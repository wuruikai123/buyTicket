# 用户冻结功能测试步骤

## 问题诊断

如果冻结功能不工作，按以下步骤排查：

### 1. 检查数据库

```sql
-- 执行这个SQL检查status字段
SELECT id, username, phone, status, create_time 
FROM sys_user;

-- 检查字段是否存在
SHOW COLUMNS FROM sys_user LIKE 'status';
```

**预期结果**：
- status字段存在
- 所有用户的status应该是1（正常）或0（冻结）

**如果字段不存在**，执行：
```sql
ALTER TABLE sys_user 
ADD COLUMN status INT DEFAULT 1 COMMENT '用户状态：0=冻结，1=正常';

UPDATE sys_user SET status = 1 WHERE status IS NULL;
```

### 2. 检查后端

#### 2.1 确认代码已更新
检查以下文件：
- `shared-backend/src/main/java/com/buyticket/entity/SysUser.java` - 应该有status字段
- `shared-backend/src/main/java/com/buyticket/controller/UserController.java` - login方法应该检查status
- `shared-backend/src/main/java/com/buyticket/controller/admin/AdminUserController.java` - updateStatus方法应该正确

#### 2.2 重新编译
```bash
cd shared-backend
mvn clean install
```

#### 2.3 重启后端服务
确保重启了Spring Boot应用

#### 2.4 测试后端接口
使用Postman或curl测试：

**测试登录（冻结用户）**：
```bash
curl -X POST http://localhost:8080/api/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"zhangsan","password":"123456"}'
```

**预期结果**：
- 如果用户status=0，应该返回"账号已被冻结，请联系管理员"
- 如果用户status=1，应该返回token

**测试冻结接口**：
```bash
curl -X PUT "http://localhost:8080/api/v1/admin/user/1/status?status=0" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 3. 检查前端

#### 3.1 清除浏览器缓存
```javascript
// 在浏览器控制台执行
localStorage.clear();
sessionStorage.clear();
location.reload();
```

#### 3.2 检查按钮显示
打开用户详情，在浏览器控制台执行：
```javascript
// 查看当前用户数据
console.log('currentUser:', currentUser.value);
console.log('status:', currentUser.value?.status);
```

**预期结果**：
- status应该是数字0或1
- 如果status=1，按钮应该显示"冻结"（黄色）
- 如果status=0，按钮应该显示"解冻"（绿色）

#### 3.3 检查网络请求
1. 打开浏览器开发者工具 → Network标签
2. 点击冻结按钮
3. 查看请求：
   - URL应该是：`/api/v1/admin/user/{id}/status?status=0`
   - 响应应该是成功

## 完整测试流程

### 步骤1：准备测试用户
```sql
-- 确保有一个测试用户，状态为正常
UPDATE sys_user SET status = 1 WHERE username = 'zhangsan';
```

### 步骤2：测试冻结功能

1. **登录B端**
   - 访问：http://localhost:3002
   - 登录：admin / 123456

2. **进入用户列表**
   - 点击左侧菜单"用户管理" → "用户列表"

3. **打开用户详情**
   - 找到zhangsan用户
   - 点击"详情"按钮

4. **检查按钮状态**
   - 应该看到黄色的"冻结"按钮
   - 打开浏览器控制台，查看：
     ```javascript
     console.log('用户详情数据:', data)
     ```

5. **执行冻结操作**
   - 点击"冻结"按钮
   - 确认对话框
   - 应该提示"冻结成功"
   - 按钮应该变为绿色的"解冻"

6. **验证冻结效果**
   - 打开A端登录页：http://localhost:5173/login
   - 尝试登录：zhangsan / 123456
   - **应该提示**："账号已被冻结，请联系管理员"

### 步骤3：测试解冻功能

1. **回到B端用户详情**
   - 按钮应该显示"解冻"（绿色）

2. **执行解冻操作**
   - 点击"解冻"按钮
   - 确认对话框
   - 应该提示"解冻成功"
   - 按钮应该变为黄色的"冻结"

3. **验证解冻效果**
   - 回到A端登录页
   - 再次登录：zhangsan / 123456
   - **应该成功登录**

## 常见问题

### Q1: 按钮不变化
**原因**：currentUser.status的值不正确

**解决**：
1. 在浏览器控制台查看：`console.log(currentUser.value)`
2. 检查status字段是否存在
3. 检查后端是否返回了status字段

### Q2: 冻结后还能登录
**原因**：后端login方法没有检查status

**解决**：
1. 检查UserController.java的login方法
2. 确保有这段代码：
   ```java
   if (user.getStatus() != null && user.getStatus() == 0) {
       return JsonData.buildError("账号已被冻结，请联系管理员");
   }
   ```
3. 重启后端服务

### Q3: 数据库报错
**原因**：status字段不存在

**解决**：
```sql
ALTER TABLE sys_user 
ADD COLUMN status INT DEFAULT 1 COMMENT '用户状态：0=冻结，1=正常';
```

### Q4: 前端报错
**原因**：代码没有正确更新

**解决**：
1. 清除浏览器缓存
2. 重新启动前端开发服务器
3. 硬刷新页面（Ctrl+Shift+R）

## 调试命令

### 数据库调试
```sql
-- 查看所有用户状态
SELECT id, username, status FROM sys_user;

-- 手动冻结用户
UPDATE sys_user SET status = 0 WHERE username = 'zhangsan';

-- 手动解冻用户
UPDATE sys_user SET status = 1 WHERE username = 'zhangsan';
```

### 浏览器控制台调试
```javascript
// 查看当前用户
console.log(currentUser.value);

// 查看status
console.log('status:', currentUser.value?.status);

// 手动触发冻结
handleFreeze();
```

## 成功标志

✅ 数据库有status字段
✅ 后端login方法检查status
✅ 按钮根据status动态显示"冻结"或"解冻"
✅ 冻结后用户无法登录A端
✅ 解冻后用户可以正常登录A端
✅ 按钮颜色正确（冻结=黄色，解冻=绿色）
