# 介绍插图和门票数量渲染到A端说明

## 修改概述

完成了以下功能：

1. ✅ **B端上传介绍插图** - 最多6张，120x120px
2. ✅ **介绍插图保存到数据库** - JSON数组格式
3. ✅ **A端展示介绍插图** - 在展览详情页显示
4. ✅ **门票数量显示** - 在日期选择页显示剩余票数

---

## 一、介绍插图功能

### 1. B端上传

**位置：** 展览管理 > 创建展览 / 编辑展览

**功能：**
- 最多上传6张介绍插图
- 每张图片120x120px（正方形）
- 支持删除已上传的图片
- 鼠标悬停显示X按钮

**保存格式：**
- 数据库字段：`detail_images`
- 数据类型：TEXT
- 存储格式：JSON数组字符串
- 示例：`["data:image/png;base64,...", "data:image/png;base64,..."]`

### 2. A端展示

**位置：** 展览详情页（TicketPurchase.vue）

**显示效果：**
- 在"展览详情"区域下方
- 每张图片200px高度
- 图片按上传顺序显示
- 如果没有上传图片，显示"暂无详情图片"

**代码位置：**
```vue
<div class="details-content-blocks" v-if="exhibition.images?.length">
  <div 
    v-for="(img, index) in exhibition.images" 
    :key="index" 
    class="content-block"
    :style="{ backgroundImage: `url(${img})` }"
  ></div>
</div>
```

---

## 二、门票数量显示

### 1. 数据来源

**后端接口：** `GET /api/v1/ticket/availability`

**参数：**
- `exhibitionId`: 展览ID
- `date`: 日期（YYYY-MM-DD）
- `timeSlot`: 时间段（如：09:00-12:00）

**返回数据：**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "totalCount": 100,
    "soldCount": 23,
    "remainingCount": 77
  }
}
```

### 2. A端显示

**位置：** 日期选择页（datechoose.vue）

**显示位置：**
- 在时间段选择器下方
- 显示格式："剩余XX张"

**更新时机：**
- 页面加载时
- 选择日期时
- 切换时间段时

**代码位置：**
```vue
<div class="availability">
  <span class="availability-text">剩余{{ remainingTickets }}张</span>
</div>
```

**更新逻辑：**
```typescript
const updateRemainingTickets = async () => {
  if (!selectedDate.value || !exhibition.value.id) return;
  
  try {
    const res = await ticketApi.getAvailability({
      exhibitionId: exhibition.value.id,
      date: formatDate(selectedDate.value),
      timeSlot: selectedTimeSlot.value
    });
    if (res) {
      remainingTickets.value = res.remainingCount;
    }
  } catch (e) {
    console.error(e);
    remainingTickets.value = 0;
  }
};
```

---

## 三、数据库变更

### 1. 添加介绍插图字段

**表名：** `exhibition`

**字段名：** `detail_images`

**类型：** TEXT

**说明：** 存储介绍插图的JSON数组

**迁移脚本：** `ADD_DETAIL_IMAGES_COLUMN.sql`

```sql
ALTER TABLE exhibition 
ADD COLUMN IF NOT EXISTS detail_images TEXT COMMENT '介绍插图(JSON数组)' AFTER cover_image;
```

### 2. 每小时门票数量字段

**表名：** `exhibition`

**字段名：** `tickets_per_hour`

**类型：** INT

**默认值：** 100

**说明：** 每小时可售门票数量

**迁移脚本：** `ADD_TICKETS_PER_HOUR_COLUMN.sql`

```sql
ALTER TABLE exhibition 
ADD COLUMN IF NOT EXISTS tickets_per_hour INT DEFAULT 100 COMMENT '每小时门票数量' AFTER price;
```

---

## 四、修改的文件列表

### 后端文件

1. `shared-backend/src/main/java/com/buyticket/entity/Exhibition.java`
   - 添加 `detailImages` 字段（TEXT类型）
   - 添加 `ticketsPerHour` 字段（Integer类型）

### 前端文件

**B端：**
1. `frontend-b/src/views/exhibition/ExhibitionForm.vue`
   - 添加介绍插图上传功能
   - 保存时将图片数组转为JSON字符串
   - 编辑时解析JSON字符串为图片数组

**A端：**
1. `frontend-a/src/views/TicketPurchase.vue`
   - 解析 `detailImages` JSON字符串
   - 显示介绍插图列表

2. `frontend-a/src/views/buyTicket/datechoose.vue`
   - 已实现剩余票数显示
   - 调用 `ticketApi.getAvailability` 获取库存

### 数据库文件

1. `ADD_DETAIL_IMAGES_COLUMN.sql` - 添加介绍插图字段
2. `ADD_TICKETS_PER_HOUR_COLUMN.sql` - 添加每小时门票数量字段

---

## 五、部署步骤

### 1. 执行数据库迁移

```bash
# 登录服务器
ssh root@47.121.192.245

# 执行迁移脚本
mysql -u root -p buyticket < ADD_DETAIL_IMAGES_COLUMN.sql
mysql -u root -p buyticket < ADD_TICKETS_PER_HOUR_COLUMN.sql

# 验证字段是否添加成功
mysql -u root -p -e "USE buyticket; DESCRIBE exhibition;"
```

### 2. 重启后端

```bash
cd /www/wwwroot/shared-backend

# 停止服务
pkill -f buyticket

# 重新编译
mvn clean package -DskipTests

# 启动服务
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 查看日志
tail -f app.log
```

### 3. 重新构建前端

```bash
# B端
cd /www/wwwroot/frontend-b
npm run build

# A端
cd /www/wwwroot/frontend-a
npm run build
```

### 4. 重启Nginx

```bash
nginx -t && nginx -s reload
```

---

## 六、测试步骤

### 测试介绍插图功能

**B端测试：**

1. **上传介绍插图**
   - [ ] 进入"创建展览"页面
   - [ ] 上传封面图
   - [ ] 上传1-6张介绍插图
   - [ ] 确认图片显示正常
   - [ ] 点击"保存"

2. **删除介绍插图**
   - [ ] 鼠标悬停在图片上
   - [ ] 确认显示X按钮
   - [ ] 点击X删除图片
   - [ ] 确认图片被删除

3. **编辑展览**
   - [ ] 进入"展览列表"
   - [ ] 点击"详情"进入编辑页
   - [ ] 确认已上传的介绍插图正常显示
   - [ ] 可以删除或添加新图片
   - [ ] 保存修改

**A端测试：**

1. **查看展览详情**
   - [ ] 进入展览列表
   - [ ] 点击任意展览
   - [ ] 滚动到"展览详情"区域
   - [ ] 确认介绍插图正常显示
   - [ ] 图片按上传顺序显示
   - [ ] 图片比例正确

2. **无图片情况**
   - [ ] 查看没有上传介绍插图的展览
   - [ ] 确认显示"暂无详情图片"

### 测试门票数量显示

**准备工作：**

1. **生成库存**
   - [ ] 进入B端"门票管理 > 库存管理"
   - [ ] 点击"批量生成库存"
   - [ ] 选择展览、日期范围、时间段
   - [ ] 确认每小时门票数量使用展览设置的值
   - [ ] 生成库存

**A端测试：**

1. **查看剩余票数**
   - [ ] 进入展览详情页
   - [ ] 点击"购票"按钮
   - [ ] 进入日期选择页
   - [ ] 确认显示"剩余XX张"
   - [ ] 数字正确（与库存一致）

2. **切换日期和时间段**
   - [ ] 选择不同日期
   - [ ] 确认剩余票数更新
   - [ ] 切换时间段
   - [ ] 确认剩余票数更新

3. **购票后验证**
   - [ ] 购买1张门票
   - [ ] 返回日期选择页
   - [ ] 确认剩余票数减少1张

4. **售罄情况**
   - [ ] 选择已售罄的时间段
   - [ ] 确认显示"剩余0张"
   - [ ] 点击"确认"
   - [ ] 确认提示"该时间段已售罄"

---

## 七、常见问题

### 1. 介绍插图不显示

**可能原因：**
- 数据库字段未添加
- JSON格式错误
- 图片数据过大

**解决方法：**
```bash
# 检查字段是否存在
mysql -u root -p -e "USE buyticket; SHOW COLUMNS FROM exhibition LIKE 'detail_images';"

# 检查数据格式
mysql -u root -p -e "USE buyticket; SELECT id, name, detail_images FROM exhibition LIMIT 1;"
```

### 2. 剩余票数显示0

**可能原因：**
- 库存未生成
- 时间段格式不匹配
- 日期格式错误

**解决方法：**
```bash
# 检查库存数据
mysql -u root -p -e "USE buyticket; SELECT * FROM ticket_inventory WHERE exhibition_id = 1 LIMIT 5;"

# 检查时间段格式
# 确保前端和后端使用相同格式：09:00-12:00
```

### 3. 图片上传失败

**可能原因：**
- 图片过大
- 浏览器内存不足
- Base64编码失败

**解决方法：**
- 压缩图片后再上传
- 建议单张图片不超过2MB
- 使用JPG格式而非PNG

---

## 八、优化建议

### 1. 图片存储优化

**当前方案：** Base64编码存储在数据库

**优化方案：** 上传到OSS（对象存储服务）

**优点：**
- 减少数据库大小
- 提升加载速度
- 支持CDN加速
- 降低服务器压力

**实现步骤：**
1. 开通阿里云OSS或腾讯云COS
2. 配置上传接口
3. 修改前端上传逻辑
4. 存储图片URL而非Base64

### 2. 图片懒加载

**优化方案：** 使用懒加载技术

**优点：**
- 提升首屏加载速度
- 节省流量
- 改善用户体验

**实现方式：**
```vue
<img v-lazy="imageUrl" alt="展览图片" />
```

### 3. 库存缓存

**优化方案：** 使用Redis缓存库存数据

**优点：**
- 减少数据库查询
- 提升响应速度
- 支持高并发

**实现步骤：**
1. 安装Redis
2. 配置Spring Data Redis
3. 缓存库存查询结果
4. 设置合理的过期时间

---

## 版本信息

- 修改日期：2026-01-30
- 修改人：Kiro AI
- 版本：v1.5
- 功能：介绍插图渲染到A端 + 门票数量显示

