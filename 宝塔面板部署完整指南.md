# 宝塔面板部署完整指南 - 展览门票管理系统

## 📋 目录

1. [准备工作](#准备工作)
2. [安装宝塔面板](#安装宝塔面板)
3. [配置服务器环境](#配置服务器环境)
4. [部署数据库](#部署数据库)
5. [部署后端服务](#部署后端服务)
6. [部署前端项目](#部署前端项目)
7. [配置支付宝支付](#配置支付宝支付)
8. [测试验证](#测试验证)
9. [常见问题](#常见问题)

---

## 📦 准备工作

### 1. 服务器要求

- **操作系统**：CentOS 7.x / Ubuntu 18.04+ / Debian 10+
- **配置**：最低 2核4G，推荐 4核8G
- **带宽**：最低 3M，推荐 5M+
- **硬盘**：最低 40G

### 2. 域名准备

- 已备案的域名（必须）
- 域名解析到服务器 IP

示例：
- 用户端：`www.yourdomain.com`
- 管理端：`admin.yourdomain.com`
- 核销端：`verify.yourdomain.com`

### 3. 本地准备

- 项目代码
- Git 客户端
- FTP 工具（可选，宝塔自带）

---

## 🚀 第一步：安装宝塔面板

### 1.1 连接服务器

使用 SSH 工具连接服务器（推荐 Xshell、FinalShell）

```bash
ssh root@your-server-ip
```

### 1.2 安装宝塔面板

#### CentOS 系统

```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

#### Ubuntu/Debian 系统

```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 1.3 记录登录信息

安装完成后会显示：

```
==================================================================
Congratulations! Installed successfully!
==================================================================
外网面板地址: http://your-ip:8888/xxxxxxxx
内网面板地址: http://192.168.x.x:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
==================================================================
```

**重要**：记录这些信息！

### 1.4 登录宝塔面板

1. 浏览器访问：`http://your-ip:8888/xxxxxxxx`
2. 输入用户名和密码
3. 绑定宝塔账号（可选）

---

## ⚙️ 第二步：配置服务器环境

### 2.1 安装软件

登录宝塔面板后，点击"软件商店"，安装以下软件：

#### 必装软件

1. **Nginx 1.22**
   - 点击"安装"
   - 选择"编译安装"（推荐）或"极速安装"
   - 等待安装完成

2. **MySQL 8.0**
   - 点击"安装"
   - 选择"编译安装"
   - 设置 root 密码（记住这个密码！）
   - 等待安装完成（约 10-20 分钟）

3. **OpenJDK 17**
   - 搜索"Java"
   - 安装"OpenJDK 17"
   - 等待安装完成

4. **PM2 管理器**（用于管理 Java 应用）
   - 搜索"PM2"
   - 点击"安装"

#### 可选软件

- **phpMyAdmin**：数据库管理工具（推荐）
- **Redis**：缓存（如果需要）

### 2.2 配置防火墙

点击"安全" → 添加以下端口：

| 端口 | 说明 |
|------|------|
| 80 | HTTP |
| 443 | HTTPS |
| 8080 | 后端服务（可选，建议只开放内网） |
| 3306 | MySQL（建议只开放内网） |

### 2.3 配置 SSL 证书（推荐）

1. 点击"网站" → "添加站点"
2. 输入域名：`www.yourdomain.com`
3. 点击"SSL" → "Let's Encrypt"
4. 勾选域名，点击"申请"
5. 等待证书申请成功

对其他域名重复此步骤。

---

## 💾 第三步：部署数据库

### 3.1 创建数据库

1. 点击"数据库" → "添加数据库"
2. 填写信息：
   - 数据库名：`buyticket`
   - 用户名：`buyticket`
   - 密码：设置一个强密码（记住！）
   - 访问权限：本地服务器
3. 点击"提交"

### 3.2 导入数据库结构

#### 方法 1：使用 phpMyAdmin

1. 点击"数据库" → 找到 `buyticket` → 点击"管理"
2. 进入 phpMyAdmin
3. 点击"导入"
4. 选择文件：`shared-backend/src/main/resources/sql/schema.sql`
5. 点击"执行"

#### 方法 2：使用命令行

1. 点击"文件" → 上传 `schema.sql` 到 `/root/`
2. 点击"终端" → 执行：

```bash
mysql -u buyticket -p buyticket < /root/schema.sql
# 输入数据库密码
```

### 3.3 执行数据库迁移

在 phpMyAdmin 或终端中执行：

```sql
-- 添加 pay_time 列
ALTER TABLE ticket_order ADD COLUMN pay_time DATETIME DEFAULT NULL COMMENT '支付时间' AFTER create_time;
ALTER TABLE mall_order ADD COLUMN pay_time DATETIME DEFAULT NULL COMMENT '支付时间' AFTER create_time;

-- 确保 mall_order 有 order_no 列
ALTER TABLE mall_order ADD COLUMN order_no VARCHAR(32) UNIQUE COMMENT '订单号（唯一）' AFTER id;
```

### 3.4 导入初始数据（可选）

```bash
# 导入展览数据
mysql -u buyticket -p buyticket < /root/insert-exhibition-data.sql

# 导入门票数据
mysql -u buyticket -p buyticket < /root/insert-tickets-2026.sql
```

---

## 🔧 第四步：部署后端服务

### 4.1 上传代码

#### 方法 1：使用 Git（推荐）

1. 点击"文件" → 进入 `/www/wwwroot/`
2. 点击"终端"
3. 执行：

```bash
cd /www/wwwroot/
git clone https://github.com/your-username/buyticket.git
cd buyticket
```

#### 方法 2：使用宝塔上传

1. 点击"文件" → 进入 `/www/wwwroot/`
2. 点击"上传"
3. 上传项目压缩包
4. 解压

### 4.2 修改配置文件

1. 点击"文件" → 进入 `/www/wwwroot/buyticket/shared-backend/src/main/resources/`
2. 编辑 `application.yml`：

```yaml
spring:
  profiles:
    active: prod  # 👈 改为 prod

---
# 生产环境配置
spring:
  config:
    activate:
      on-profile: prod
  
  datasource:
    url: jdbc:mysql://localhost:3306/buyticket?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: buyticket
    password: 你的数据库密码  # 👈 改为你的数据库密码
    driver-class-name: com.mysql.cj.jdbc.Driver

alipay:
  # 开发环境先用沙箱测试
  app-id: 9021000158671506
  merchant-private-key: MIIEvQIBADANBgkqhkiG9w0BAQE...（你的沙箱私钥）
  alipay-public-key: MIIBIjANBgkqhkiG9w0BAQEFAAO...（你的沙箱公钥）
  notify-url: https://www.yourdomain.com/api/v1/payment/alipay/notify  # 👈 改为你的域名
  return-url: https://www.yourdomain.com/order-success  # 👈 改为你的域名
  gateway-url: https://openapi-sandbox.dl.alipaydev.com/gateway.do  # 沙箱网关

logging:
  level:
    root: INFO
    com.buyticket: INFO
  file:
    name: /www/wwwroot/logs/buyticket/application.log
```

### 4.3 打包项目

在宝塔终端执行：

```bash
cd /www/wwwroot/buyticket/shared-backend

# 如果没有 Maven，先安装
wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.9.5/binaries/apache-maven-3.9.5-bin.tar.gz
tar -zxvf apache-maven-3.9.5-bin.tar.gz -C /usr/local/
ln -s /usr/local/apache-maven-3.9.5/bin/mvn /usr/bin/mvn

# 打包项目
mvn clean package -DskipTests
```

### 4.4 配置 Java 项目

1. 点击"软件商店" → 找到"Java项目管理器" → 点击"设置"
2. 点击"添加项目"
3. 填写信息：
   - 项目名称：`buyticket-backend`
   - 项目路径：`/www/wwwroot/buyticket/shared-backend`
   - 启动文件：`target/buyticket-0.0.1-SNAPSHOT.jar`
   - 启动命令：`java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod`
   - 端口：`8080`
4. 点击"提交"
5. 点击"启动"

### 4.5 查看日志

点击"日志" → 查看启动日志，确认启动成功：

```
=== 支付宝配置加载成功 ===
APPID: 9021000158671506
异步通知地址: https://www.yourdomain.com/api/v1/payment/alipay/notify
同步跳转地址: https://www.yourdomain.com/order-success
支付宝网关: https://openapi-sandbox.dl.alipaydev.com/gateway.do
========================

Started BuyticketApplication in 15.234 seconds
```

---

## 🌐 第五步：部署前端项目

### 5.1 本地构建前端

在本地电脑上执行：

```bash
# 构建 frontend-a（用户端）
cd frontend-a
npm install
npm run build

# 构建 frontend-b（管理端）
cd ../frontend-b
npm install
npm run build

# 构建 frontend-c（核销端）
cd ../frontend-c
npm install
npm run build
```

### 5.2 上传前端文件

#### 方法 1：使用宝塔上传

1. 点击"文件" → 进入 `/www/wwwroot/`
2. 创建目录：
   - `frontend-a`
   - `frontend-b`
   - `frontend-c`
3. 分别上传对应的 `dist` 目录内容

#### 方法 2：使用 FTP

使用 FileZilla 等 FTP 工具上传。

### 5.3 配置网站

#### 配置 frontend-a（用户端）

1. 点击"网站" → "添加站点"
2. 填写信息：
   - 域名：`www.yourdomain.com`
   - 根目录：`/www/wwwroot/frontend-a`
   - PHP 版本：纯静态
3. 点击"提交"

#### 配置 frontend-b（管理端）

1. 点击"网站" → "添加站点"
2. 填写信息：
   - 域名：`admin.yourdomain.com`
   - 根目录：`/www/wwwroot/frontend-b`
   - PHP 版本：纯静态
3. 点击"提交"

#### 配置 frontend-c（核销端）

1. 点击"网站" → "添加站点"
2. 填写信息：
   - 域名：`verify.yourdomain.com`
   - 根目录：`/www/wwwroot/frontend-c`
   - PHP 版本：纯静态
3. 点击"提交"

### 5.4 配置 Nginx 反向代理

对每个网站进行配置：

1. 点击网站 → "设置" → "配置文件"
2. 在 `server` 块中添加：

```nginx
# API 反向代理
location /api/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 支持 WebSocket（如果需要）
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# 前端路由支持
location / {
    try_files $uri $uri/ /index.html;
}
```

3. 点击"保存"
4. 重启 Nginx

### 5.5 配置 SSL 证书

对每个网站：

1. 点击网站 → "设置" → "SSL"
2. 选择"Let's Encrypt"
3. 勾选域名
4. 点击"申请"
5. 开启"强制 HTTPS"

---

## 💳 第六步：配置支付宝支付

### 6.1 开发环境（沙箱测试）

#### 步骤 1：获取沙箱配置

1. 访问：https://open.alipay.com/
2. 登录支付宝账号
3. 进入"开发者中心" → "研发服务" → "沙箱环境"
4. 记录：
   - APPID
   - 应用私钥
   - 支付宝公钥

#### 步骤 2：配置回调地址

在 `application.yml` 中：

```yaml
alipay:
  app-id: 9021000158671506  # 沙箱 APPID
  merchant-private-key: 你的沙箱私钥
  alipay-public-key: 你的沙箱公钥
  notify-url: https://www.yourdomain.com/api/v1/payment/alipay/notify  # 你的域名
  return-url: https://www.yourdomain.com/order-success  # 你的域名
  gateway-url: https://openapi-sandbox.dl.alipaydev.com/gateway.do  # 沙箱网关
```

#### 步骤 3：重启后端服务

在宝塔面板：
1. 点击"Java项目管理器"
2. 找到 `buyticket-backend`
3. 点击"重启"

#### 步骤 4：测试支付

1. 访问 `https://www.yourdomain.com`
2. 创建订单
3. 进行支付
4. 使用沙箱买家账号支付
5. 查看订单状态是否更新

### 6.2 生产环境（正式支付）

#### 步骤 1：企业认证

1. 准备材料：
   - 企业营业执照
   - 法人身份证
   - 企业支付宝账号
   - 对公银行账户

2. 访问：https://enterpriseportal.alipay.com/
3. 注册企业支付宝账号
4. 完成企业认证（1-3个工作日）

#### 步骤 2：创建应用

1. 登录：https://open.alipay.com/
2. 点击"控制台" → "网页&移动应用"
3. 点击"创建应用"
4. 填写应用信息：
   - 应用名称：展览门票管理系统
   - 应用图标：上传 Logo
   - 应用简介：在线购买展览门票

#### 步骤 3：生成密钥

1. 下载"支付宝开放平台开发助手"
   - 访问：https://opendocs.alipay.com/common/02kipl
2. 打开工具 → 选择"RSA2(SHA256)密钥"
3. 点击"生成密钥"
4. 保存：
   - 应用私钥（merchant_private_key）
   - 应用公钥

#### 步骤 4：配置应用

1. 在支付宝开放平台：
   - 点击应用 → "开发设置"
   - 选择"接口加签方式" → "公钥"
   - 上传你的应用公钥
   - 保存支付宝公钥

2. 配置回调地址：
   - 授权回调地址：`https://www.yourdomain.com`
   - 应用网关：`https://www.yourdomain.com/api/v1/payment/alipay/notify`

#### 步骤 5：签约产品

1. 点击"产品绑定"
2. 选择：
   - 手机网站支付
   - 电脑网站支付
3. 提交签约申请
4. 等待审核（1-3个工作日）

#### 步骤 6：修改配置

审核通过后，修改 `application.yml`：

```yaml
alipay:
  app-id: 2021001234567890  # 真实 APPID
  merchant-private-key: MIIEvQIBADANBgkqhkiG9w0BAQE...  # 真实私钥
  alipay-public-key: MIIBIjANBgkqhkiG9w0BAQEFAAO...  # 真实支付宝公钥
  notify-url: https://www.yourdomain.com/api/v1/payment/alipay/notify
  return-url: https://www.yourdomain.com/order-success
  gateway-url: https://openapi.alipay.com/gateway.do  # 生产网关
```

#### 步骤 7：重启服务并测试

1. 重启后端服务
2. 用小额真实支付测试
3. 验证订单状态更新

---

## ✅ 第七步：测试验证

### 7.1 测试清单

- [ ] 前端页面可以访问
- [ ] 用户可以注册登录
- [ ] 可以浏览展览信息
- [ ] 可以创建订单
- [ ] 可以进行支付
- [ ] 支付后订单状态更新
- [ ] 管理端可以登录
- [ ] 管理端可以管理展览
- [ ] 核销端可以核销门票

### 7.2 查看日志

#### 后端日志

```bash
# 在宝塔终端执行
tail -f /www/wwwroot/logs/buyticket/application.log
```

或在宝塔面板：
- Java项目管理器 → 日志

#### Nginx 日志

- 网站 → 设置 → 日志

### 7.3 性能优化

1. **开启 Gzip 压缩**
   - 网站 → 设置 → 性能优化 → 开启 Gzip

2. **配置缓存**
   - 网站 → 设置 → 配置文件
   - 添加静态资源缓存规则

3. **配置 CDN**（可选）
   - 使用阿里云 CDN 或腾讯云 CDN

---

## 🔧 常见问题

### Q1: 后端启动失败？

**排查步骤**：
1. 查看日志：Java项目管理器 → 日志
2. 检查端口是否被占用：`netstat -tunlp | grep 8080`
3. 检查数据库连接是否正确
4. 检查 Java 版本：`java -version`

### Q2: 前端访问 404？

**解决方案**：
1. 检查网站根目录是否正确
2. 检查 Nginx 配置中的 `try_files`
3. 重启 Nginx

### Q3: 支付回调没有触发？

**排查步骤**：
1. 检查域名是否可以公网访问
2. 检查 `notify_url` 配置是否正确
3. 查看后端日志是否有回调记录
4. 检查防火墙是否开放 80/443 端口

### Q4: 数据库连接失败？

**解决方案**：
1. 检查数据库密码是否正确
2. 检查数据库是否启动：`systemctl status mysqld`
3. 检查数据库权限

### Q5: SSL 证书申请失败？

**解决方案**：
1. 确保域名已解析到服务器
2. 确保 80 端口可以访问
3. 尝试使用其他 CA 机构

---

## 📊 部署架构图

```
用户浏览器
    ↓
域名 (www.yourdomain.com)
    ↓
Nginx (80/443)
    ↓
    ├─→ 前端静态文件 (/www/wwwroot/frontend-a)
    │
    └─→ /api/* → 后端服务 (localhost:8080)
            ↓
        Spring Boot 应用
            ↓
        MySQL 数据库 (localhost:3306)
```

---

## 🎯 部署完成检查清单

### 服务器环境
- [ ] 宝塔面板安装成功
- [ ] Nginx 安装成功
- [ ] MySQL 8.0 安装成功
- [ ] OpenJDK 17 安装成功
- [ ] 防火墙配置正确

### 数据库
- [ ] 数据库创建成功
- [ ] 数据库结构导入成功
- [ ] 数据库迁移执行成功
- [ ] 初始数据导入成功

### 后端服务
- [ ] 代码上传成功
- [ ] 配置文件修改正确
- [ ] 项目打包成功
- [ ] 服务启动成功
- [ ] 日志显示正常

### 前端项目
- [ ] 前端构建成功
- [ ] 文件上传成功
- [ ] 网站配置成功
- [ ] Nginx 反向代理配置成功
- [ ] SSL 证书配置成功

### 支付配置
- [ ] 支付宝配置正确
- [ ] 回调地址配置正确
- [ ] 支付测试成功
- [ ] 订单状态更新正常

### 功能测试
- [ ] 用户注册登录正常
- [ ] 展览浏览正常
- [ ] 订单创建正常
- [ ] 支付流程正常
- [ ] 管理端功能正常
- [ ] 核销端功能正常

---

## 📞 技术支持

如果遇到问题：

1. **查看日志**：
   - 后端日志：`/www/wwwroot/logs/buyticket/application.log`
   - Nginx 日志：网站 → 设置 → 日志

2. **查看文档**：
   - `QUICK_START_GUIDE.md`
   - `ALIPAY_SANDBOX_VS_PRODUCTION.md`
   - `DEPLOYMENT_GUIDE.md`

3. **宝塔论坛**：
   - https://www.bt.cn/bbs/

---

## 🎉 恭喜！

如果所有检查项都通过，说明部署成功！

现在你可以：
- ✅ 访问 `https://www.yourdomain.com` 使用系统
- ✅ 访问 `https://admin.yourdomain.com` 管理系统
- ✅ 访问 `https://verify.yourdomain.com` 核销门票
- ✅ 接收真实的支付订单

祝你使用愉快！🎊
