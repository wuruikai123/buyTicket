# 个人中心功能增强说明

## 新增功能

### 1. 退出登录按钮

**位置：** 个人中心页面右上角

**功能：**
- 点击"退出登录"按钮
- 弹出确认对话框："确定要退出登录吗？"
- 确认后清除本地存储的 token 和用户信息
- 跳转到登录页面

**样式：**
- 红色背景按钮
- 带有退出图标
- 鼠标悬停时变为深红色

**代码位置：**
- 前端：`frontend-a/src/views/Profile.vue` 第 30-34 行（按钮）
- 逻辑：`frontend-a/src/views/Profile.vue` 第 290-310 行（handleLogout 方法）

---

### 2. 删除订单功能

**功能说明：**
用户可以删除特定状态的订单，删除后订单将从数据库中永久删除。

**可删除的订单状态：**

#### 门票订单
- ✅ 待支付（status = 0）
- ❌ 待使用（status = 1）- 不可删除
- ✅ 已使用（status = 2）
- ✅ 已取消/已作废（status = 3）

#### 商城订单
- ✅ 待支付（status = 0）
- ❌ 待发货（status = 1）- 不可删除
- ❌ 已发货（status = 2）- 不可删除
- ✅ 已完成（status = 3）
- ✅ 已取消（status = 4）

**操作流程：**
1. 在订单列表中，可删除的订单右侧会显示红色圆形删除按钮
2. 点击删除按钮
3. 弹出二次确认对话框："确定要删除这个[状态]的订单吗？删除后将无法恢复。"
4. 确认后调用后端接口删除订单
5. 删除成功后刷新订单列表

**安全机制：**
- 后端验证订单所有权（只能删除自己的订单）
- 后端验证订单状态（只能删除允许删除的状态）
- 前端二次确认（防止误删）

**代码位置：**

**前端：**
- 删除按钮：`frontend-a/src/views/Profile.vue` 第 103-111 行
- 判断逻辑：`frontend-a/src/views/Profile.vue` 第 312-317 行（canDeleteOrder 方法）
- 删除逻辑：`frontend-a/src/views/Profile.vue` 第 319-345 行（handleDeleteOrder 方法）
- API 接口：
  - `frontend-a/src/api/ticket.ts` 第 63-66 行
  - `frontend-a/src/api/mall.ts` 第 82-85 行

**后端：**
- 门票订单删除：`shared-backend/src/main/java/com/buyticket/controller/OrderController.java` 第 227-254 行
- 商城订单删除：`shared-backend/src/main/java/com/buyticket/controller/OrderController.java` 第 256-283 行

---

### 3. 订单显示封面图

**功能说明：**
订单列表中每个订单卡片左侧显示展览或商品的封面图。

**实现方式：**
- 订单数据中包含 `coverImage` 字段
- 使用 CSS `background-image` 显示封面图
- 如果没有封面图，显示灰色占位背景

**代码位置：**
- 模板：`frontend-a/src/views/Profile.vue` 第 91 行
- 数据映射：`frontend-a/src/views/Profile.vue` 第 223 行（门票订单）、第 234 行（商城订单）

---

## API 接口

### 删除门票订单

**请求：**
```
DELETE /api/v1/order/ticket/{id}
```

**参数：**
- `id`：订单ID（路径参数）

**响应：**
```json
{
  "code": 0,
  "msg": "订单已删除",
  "data": null
}
```

**错误响应：**
```json
{
  "code": -1,
  "msg": "不可删除待使用的订单",
  "data": null
}
```

---

### 删除商城订单

**请求：**
```
DELETE /api/v1/order/mall/{id}
```

**参数：**
- `id`：订单ID（路径参数）

**响应：**
```json
{
  "code": 0,
  "msg": "订单已删除",
  "data": null
}
```

**错误响应：**
```json
{
  "code": -1,
  "msg": "不可删除待发货或已发货的订单",
  "data": null
}
```

---

## 测试步骤

### 1. 测试退出登录

1. 登录系统
2. 进入个人中心
3. 点击右上角"退出登录"按钮
4. 确认弹出对话框
5. 点击"确定"
6. 验证：
   - [ ] 成功跳转到登录页
   - [ ] 本地存储的 token 已清除
   - [ ] 再次访问个人中心显示"未登录"状态

### 2. 测试删除订单

#### 测试待支付订单删除
1. 创建一个待支付的订单
2. 进入个人中心
3. 找到该订单，确认显示删除按钮
4. 点击删除按钮
5. 确认弹出对话框
6. 点击"确定删除"
7. 验证：
   - [ ] 订单从列表中消失
   - [ ] 数据库中订单已删除
   - [ ] 显示"订单已删除"提示

#### 测试待使用订单（不可删除）
1. 创建并支付一个订单（状态变为待使用）
2. 进入个人中心
3. 找到该订单
4. 验证：
   - [ ] 订单右侧不显示删除按钮
   - [ ] 只显示状态标签

#### 测试已使用订单删除
1. 在B端核销一个订单（状态变为已使用）
2. 在A端个人中心找到该订单
3. 确认显示删除按钮
4. 点击删除
5. 验证删除成功

#### 测试已取消订单删除
1. 取消一个待支付订单
2. 确认显示删除按钮
3. 点击删除
4. 验证删除成功

### 3. 测试订单封面图

1. 创建订单时确保展览有封面图
2. 进入个人中心
3. 验证：
   - [ ] 订单卡片左侧显示封面图
   - [ ] 图片比例正确
   - [ ] 没有封面图时显示灰色占位

---

## 注意事项

### 1. 数据安全
- 删除操作不可恢复，请谨慎操作
- 后端已验证订单所有权，用户只能删除自己的订单
- 后端已验证订单状态，防止删除不应删除的订单

### 2. 用户体验
- 删除操作有二次确认，防止误删
- 删除按钮只在可删除的订单上显示，避免用户困惑
- 删除成功后自动刷新列表

### 3. 状态说明
- "待使用"的订单不可删除，因为用户可能需要使用
- "待发货"和"已发货"的商城订单不可删除，因为涉及物流
- 其他状态的订单可以删除，因为已完成或已取消

---

## 修改的文件列表

### 前端
1. `frontend-a/src/views/Profile.vue` - 个人中心页面
2. `frontend-a/src/api/ticket.ts` - 门票API
3. `frontend-a/src/api/mall.ts` - 商城API

### 后端
1. `shared-backend/src/main/java/com/buyticket/controller/OrderController.java` - 订单控制器

---

## 版本信息

- 修改日期：2026-01-23
- 修改人：Kiro AI
- 版本：v1.1
- 功能：个人中心增强（退出登录、删除订单、显示封面图）
