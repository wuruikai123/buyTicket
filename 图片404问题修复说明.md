# 图片404问题修复说明

## 问题描述

访问展览封面图时返回404错误：
```
GET http://localhost:8080/images/exhibition_current.jpg 404 (Not Found)
```

## 问题原因

### 1. 数据库存储的路径格式不统一

数据库中可能存在两种路径格式：
- `/uploads/xxx.jpg` - 新的上传路径
- `/images/xxx.jpg` - 旧的路径或其他来源

### 2. 后端静态资源配置不完整

后端只配置了 `/uploads/**` 路径的静态资源访问：
```java
registry.addResourceHandler("/uploads/**")
        .addResourceLocations("file:" + uploadPath + "/");
```

但没有配置 `/images/**` 路径。

## 解决方案

### 修改后端配置

**文件**：`shared-backend/src/main/java/com/buyticket/config/WebMvcConfig.java`

**修改内容**：
```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    // 配置上传文件的访问路径
    registry.addResourceHandler("/uploads/**")
            .addResourceLocations("file:" + uploadPath + "/");
    
    // 配置images路径（兼容旧数据）
    registry.addResourceHandler("/images/**")
            .addResourceLocations("file:" + uploadPath + "/");
}
```

**说明**：
- 添加了 `/images/**` 路径的映射
- 两个路径都指向同一个物理目录（`uploadPath`）
- 这样可以兼容不同格式的图片路径

## 验证步骤

### 1. 检查数据库中的图片路径

```sql
SELECT 
    id,
    name,
    cover_image,
    detail_images
FROM exhibition
ORDER BY id DESC
LIMIT 10;
```

**可能的结果**：
```
id | name      | cover_image
1  | 展览A     | /uploads/2024/01/xxx.jpg
2  | 展览B     | /images/exhibition_current.jpg
3  | 展览C     | /uploads/2024/01/yyy.jpg
```

### 2. 重启后端服务

修改配置后必须重启后端服务才能生效。

### 3. 测试图片访问

#### 测试 /uploads/ 路径
```
http://localhost:8080/uploads/2024/01/xxx.jpg
```

#### 测试 /images/ 路径
```
http://localhost:8080/images/exhibition_current.jpg
```

两个路径都应该能正常访问。

### 4. 测试前端页面

1. 访问展览列表：http://localhost:5173/exhibitions
2. 访问首页：http://localhost:5173/
3. 访问展览详情：http://localhost:5173/ticket/1

检查封面图是否正常显示。

## 其他可能的问题

### 问题1：图片文件不存在

**检查**：
```bash
# Windows
dir shared-backend\uploads

# Linux/Mac
ls -la shared-backend/uploads/
```

**解决**：确保图片文件确实存在于uploads目录中。

### 问题2：文件路径配置错误

**检查**：`application.properties` 或 `application.yml`
```properties
file.upload.path=uploads
```

**说明**：
- 相对路径：`uploads` - 相对于项目根目录
- 绝对路径：`D:/uploads` 或 `/var/uploads`

### 问题3：权限问题

**检查**：uploads目录是否有读取权限

**解决**：
```bash
# Linux/Mac
chmod -R 755 uploads/

# Windows
# 右键 uploads 文件夹 → 属性 → 安全 → 编辑权限
```

### 问题4：跨域问题

**现象**：浏览器控制台显示CORS错误

**解决**：检查后端CORS配置（通常已配置）

## 路径映射说明

### 当前配置

```
URL路径                          物理路径
/uploads/xxx.jpg        →       uploads/xxx.jpg
/images/xxx.jpg         →       uploads/xxx.jpg
```

### 访问示例

```
数据库存储：/images/exhibition_current.jpg
前端处理：http://localhost:8080/images/exhibition_current.jpg
后端映射：uploads/exhibition_current.jpg
实际文件：shared-backend/uploads/exhibition_current.jpg
```

## 统一路径建议

### 方案1：统一使用 /uploads/ 路径

**优点**：路径统一，易于管理

**实施**：
1. 新上传的文件都使用 `/uploads/` 路径
2. 旧数据通过SQL更新：
```sql
UPDATE exhibition 
SET cover_image = REPLACE(cover_image, '/images/', '/uploads/')
WHERE cover_image LIKE '/images/%';
```

### 方案2：保持兼容（当前方案）

**优点**：不需要修改数据库，兼容性好

**缺点**：路径不统一

## 完成检查清单

- [x] 修改后端配置，添加 `/images/**` 路径映射
- [ ] 重启后端服务
- [ ] 检查数据库中的图片路径格式
- [ ] 测试 /uploads/ 路径访问
- [ ] 测试 /images/ 路径访问
- [ ] 测试前端展览列表页面
- [ ] 测试前端首页
- [ ] 测试前端展览详情页面

## 总结

✅ 已修改后端配置，支持 `/images/**` 路径
✅ 兼容 `/uploads/**` 和 `/images/**` 两种路径格式
✅ 不需要修改数据库

**下一步**：重启后端服务，测试图片是否能正常显示。
