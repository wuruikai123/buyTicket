# ✅ 支付宝配置完成说明

## 📋 已完成的配置

### 1. 后端配置
**文件**: `shared-backend/src/main/java/com/buyticket/config/AlipayConfig.java`

```java
// 异步通知地址（支付宝服务器 → 你的后端）
public static String notify_url = "http://p22294f8.natappfree.cc/api/v1/payment/alipay/notify";

// 同步通知地址（用户浏览器跳转）
public static String return_url = "http://localhost:3000/order/success";
```

### 2. 前端页面
**文件**: `frontend-a/src/views/OrderSuccess.vue`
- 支付成功页面
- 显示订单号、支付宝交易号、支付金额
- 带动画效果的成功图标
- 操作按钮：查看订单详情、返回首页

### 3. 路由配置
**文件**: `frontend-a/src/router/index.ts`
- 添加了 `/order/success` 路由

---

## 🔧 配置详解

### 异步通知地址（notify_url）
```
http://p22294f8.natappfree.cc/api/v1/payment/alipay/notify
```

**工作流程**：
```
用户支付成功
    ↓
支付宝服务器 POST 请求
    ↓
http://p22294f8.natappfree.cc/api/v1/payment/alipay/notify
    ↓
natapp 转发到
    ↓
http://localhost:8080/api/v1/payment/alipay/notify
    ↓
你的后端收到通知，更新订单状态
```

### 同步通知地址（return_url）
```
http://localhost:3000/order/success
```

**工作流程**：
```
用户支付成功
    ↓
支付宝页面跳转
    ↓
用户浏览器访问 http://localhost:3000/order/success?out_trade_no=xxx&trade_no=xxx&total_amount=xxx
    ↓
前端显示支付成功页面
```

---

## 🚀 使用步骤

### 1. 启动 natapp（必须）
```bash
# 确保 natapp 正在运行，并且地址是 http://p22294f8.natappfree.cc
natapp -authtoken=你的token
```

**重要**：
- natapp 必须一直运行，否则支付宝无法通知你的服务器
- 免费版 natapp 每次重启地址会变化，需要重新配置
- 如果地址变化，需要修改 `AlipayConfig.java` 中的 `notify_url`

### 2. 启动后端服务
```bash
# 在 shared-backend 目录下
mvn spring-boot:run

# 或使用 IDEA 运行
```

确保后端运行在 `http://localhost:8080`

### 3. 启动前端服务
```bash
# 在 frontend-a 目录下
npm run dev
```

确保前端运行在 `http://localhost:3000`

### 4. 测试支付流程

#### 步骤1：创建订单
1. 登录系统
2. 选择展览
3. 选择日期和票数
4. 创建订单

#### 步骤2：发起支付
在订单详情页面，调用支付接口：
```javascript
// 前端代码示例
const createPayment = async (orderNo) => {
  try {
    const response = await request.post('/api/v1/payment/alipay/create', {
      orderNo: orderNo
    });
    
    if (response.code === 0) {
      // 在页面中渲染支付表单
      const div = document.createElement('div');
      div.innerHTML = response.data;
      document.body.appendChild(div);
      
      // 自动提交表单，跳转到支付宝
      document.forms[0].submit();
    }
  } catch (error) {
    console.error('创建支付订单失败', error);
  }
};
```

#### 步骤3：支付宝沙箱支付
1. 页面会跳转到支付宝沙箱支付页面
2. 使用沙箱买家账号登录
3. 输入支付密码完成支付

**沙箱账号获取**：
- 登录 https://open.alipay.com/
- 进入"开发者中心" → "研发服务" → "沙箱"
- 查看"沙箱账号"

#### 步骤4：支付成功
1. **异步通知**：支付宝会POST请求到你的后端，更新订单状态
2. **同步通知**：浏览器会跳转到 `http://localhost:3000/order/success`
3. 前端显示支付成功页面

---

## 🔍 验证配置

### 运行测试脚本
```bash
test-alipay-config.bat
```

这个脚本会检查：
- ✓ 内网穿透地址是否可访问
- ✓ 本地后端服务是否启动
- ✓ 配置信息是否正确

### 查看后端日志
支付成功后，后端会输出日志：
```
收到支付宝异步通知
支付宝回调参数: {out_trade_no=T20250101000001, trade_no=..., trade_status=TRADE_SUCCESS, ...}
订单号: T20250101000001, 支付宝交易号: ..., 交易状态: TRADE_SUCCESS, 金额: 100.00
订单支付成功，状态已更新: orderNo=T20250101000001
```

---

## ⚠️ 注意事项

### 1. natapp 地址变化
免费版 natapp 每次重启地址会变化，如果地址变化：
1. 修改 `AlipayConfig.java` 中的 `notify_url`
2. 重启后端服务

### 2. 订单状态更新
- 订单状态更新**只在异步通知中处理**
- 同步通知**不更新订单状态**，只用于展示
- 如果异步通知失败，订单状态不会更新

### 3. 支付宝通知重试
- 支付宝会重试通知最多8次
- 间隔时间：2m, 10m, 10m, 1h, 2h, 6h, 15h
- 必须返回 "success" 才会停止通知

### 4. 签名验证
- 所有通知都会验证签名
- 签名验证失败会返回 "failure"
- 确保支付宝公钥配置正确

---

## 🐛 常见问题

### Q1: 支付成功但订单状态没更新
**原因**：异步通知失败
**解决**：
1. 检查 natapp 是否正在运行
2. 检查后端日志是否收到通知
3. 在支付宝开放平台查看"消息通知"日志

### Q2: natapp 地址无法访问
**原因**：natapp 未启动或配置错误
**解决**：
1. 启动 natapp
2. 确认地址是 `http://p22294f8.natappfree.cc`
3. 测试访问：`curl http://p22294f8.natappfree.cc`

### Q3: 支付宝返回签名验证失败
**原因**：支付宝公钥配置错误
**解决**：
1. 登录支付宝开放平台
2. 查看"应用信息" → "接口加签方式"
3. 复制"支付宝公钥"（不是应用公钥）
4. 更新 `AlipayConfig.java` 中的 `alipay_public_key`

### Q4: 前端跳转到支付成功页面但没有订单信息
**原因**：URL参数丢失
**解决**：
1. 检查 `return_url` 配置是否正确
2. 查看浏览器地址栏是否有参数
3. 检查前端路由配置

---

## 📚 相关文件

### 后端
- `AlipayConfig.java` - 支付宝配置
- `AlipayService.java` - 支付服务接口
- `AlipayServiceImpl.java` - 支付服务实现
- `PaymentController.java` - 支付控制器

### 前端
- `OrderSuccess.vue` - 支付成功页面
- `router/index.ts` - 路由配置

### 文档
- `支付宝支付集成指南.md` - 完整集成指南
- `test-alipay-config.bat` - 配置测试脚本

---

## ✅ 下一步

1. ✅ 配置已完成
2. ⏳ 启动 natapp
3. ⏳ 启动后端服务
4. ⏳ 启动前端服务
5. ⏳ 测试支付流程
6. ⏳ 查看日志验证

---

## 🎉 配置完成

所有配置已完成，现在可以开始测试支付功能了！

**当前配置**：
- ✅ 异步通知：`http://p22294f8.natappfree.cc/api/v1/payment/alipay/notify`
- ✅ 同步通知：`http://localhost:3000/order/success`
- ✅ 支付成功页面已创建
- ✅ 路由配置已更新

**记住**：natapp 必须一直运行，否则支付宝无法通知你的服务器！
