# 展览门票库存管理系统验证清单

## 📋 部署前检查

### 1. 文件检查
- [x] CREATE_TIME_SLOT_INVENTORY_TABLE.sql - SQL脚本
- [x] ExhibitionTimeSlotInventory.java - 实体类
- [x] ExhibitionTimeSlotInventoryMapper.java - Mapper
- [x] ExhibitionTimeSlotInventoryService.java - 服务接口
- [x] ExhibitionTimeSlotInventoryServiceImpl.java - 服务实现
- [x] ExhibitionInventoryController.java - API控制器
- [x] AdminExhibitionController.java - 已修改
- [x] TicketOrderServiceImpl.java - 已修改
- [x] AdminOrderController.java - 已修改
- [x] OrderController.java - 已修改

### 2. 代码编译检查
- [x] 所有Java文件无编译错误
- [x] 所有导入语句正确
- [x] 所有依赖注入正确

## 🚀 部署步骤

### 步骤1: 创建数据库表
```bash
mysql -u root -p buyticket < CREATE_TIME_SLOT_INVENTORY_TABLE.sql
```

**验证**:
```sql
-- 检查表是否创建成功
SHOW TABLES LIKE 'exhibition_time_slot_inventory';

-- 查看表结构
DESC exhibition_time_slot_inventory;

-- 应该看到以下字段:
-- id, exhibition_id, ticket_date, time_slot, 
-- total_tickets, sold_tickets, available_tickets, version,
-- create_time, update_time
```

- [ ] 表创建成功
- [ ] 表结构正确
- [ ] 索引创建成功

### 步骤2: 迁移现有展览（可选）
```bash
mysql -u root -p buyticket < MIGRATE_EXISTING_EXHIBITIONS_TO_INVENTORY.sql
```

**验证**:
```sql
-- 查看每个展览的库存记录数
SELECT 
    e.id, 
    e.name, 
    COUNT(i.id) AS inventory_count
FROM exhibition e
LEFT JOIN exhibition_time_slot_inventory i ON e.id = i.exhibition_id
GROUP BY e.id, e.name;
```

- [ ] 现有展览已生成库存记录
- [ ] 库存数量正确

### 步骤3: 重启后端服务
```bash
# 停止后端服务
# 启动后端服务
```

**验证**:
```bash
# 检查后端是否启动成功
curl http://localhost:8080/api/v1/exhibition/list?page=1&size=10
```

- [ ] 后端启动成功
- [ ] 无启动错误
- [ ] API可以访问

## 🧪 功能测试

### 测试1: 创建展览并初始化库存

**操作步骤**:
1. 登录B端 (http://localhost:5174)
2. 账号: admin / 123456
3. 进入"展览管理"
4. 点击"创建展览"
5. 填写信息:
   - 展览名称: 测试展览
   - 开始日期: 2026-02-10
   - 结束日期: 2026-02-12
   - 上午票数: 100
   - 下午票数: 150
   - 其他必填字段
6. 保存

**验证**:
```sql
-- 查看是否生成库存记录
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = (SELECT MAX(id) FROM exhibition)
ORDER BY ticket_date, time_slot;

-- 应该看到6条记录（3天 × 2个时间段）
-- 2026-02-10 09:00-12:00 总票数100
-- 2026-02-10 14:00-17:00 总票数150
-- 2026-02-11 09:00-12:00 总票数100
-- 2026-02-11 14:00-17:00 总票数150
-- 2026-02-12 09:00-12:00 总票数100
-- 2026-02-12 14:00-17:00 总票数150
```

**检查项**:
- [ ] 展览创建成功
- [ ] 库存记录自动生成
- [ ] 每天有2条记录（上午、下午）
- [ ] 总票数正确
- [ ] 已售票数为0
- [ ] 可售票数等于总票数

### 测试2: 查询库存API

**操作步骤**:
```bash
# 替换{exhibitionId}为实际的展览ID
curl http://localhost:8080/api/v1/exhibition/inventory/{exhibitionId}/date/2026-02-10
```

**预期返回**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "exhibitionId": 1,
      "ticketDate": "2026-02-10",
      "timeSlot": "09:00-12:00",
      "totalTickets": 100,
      "soldTickets": 0,
      "availableTickets": 100,
      "version": 0
    },
    {
      "id": 2,
      "exhibitionId": 1,
      "ticketDate": "2026-02-10",
      "timeSlot": "14:00-17:00",
      "totalTickets": 150,
      "soldTickets": 0,
      "availableTickets": 150,
      "version": 0
    }
  ],
  "msg": "success"
}
```

**检查项**:
- [ ] API返回成功
- [ ] 返回2条记录
- [ ] 数据格式正确
- [ ] 库存数量正确

### 测试3: 购买门票（扣减库存）

**操作步骤**:
1. 登录A端 (http://localhost:5173)
2. 账号: zhangsan / 123456
3. 选择测试展览
4. 选择日期: 2026-02-10
5. 选择时间段: 上午场
6. 购买数量: 5张
7. 填写联系信息
8. 提交订单

**验证**:
```sql
-- 查看库存是否扣减
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = ? 
  AND ticket_date = '2026-02-10' 
  AND time_slot = '09:00-12:00';

-- 应该看到:
-- sold_tickets = 5
-- available_tickets = 95
-- version = 1
```

**检查项**:
- [ ] 订单创建成功
- [ ] 已售票数增加5
- [ ] 可售票数减少5
- [ ] version增加1
- [ ] 订单状态为"待支付"

### 测试4: 取消订单（恢复库存）

**操作步骤**:
1. 在A端"我的订单"中找到刚创建的订单
2. 点击"取消订单"
3. 确认取消

**验证**:
```sql
-- 查看库存是否恢复
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = ? 
  AND ticket_date = '2026-02-10' 
  AND time_slot = '09:00-12:00';

-- 应该看到:
-- sold_tickets = 0
-- available_tickets = 100
-- version = 2
```

**检查项**:
- [ ] 订单取消成功
- [ ] 已售票数减少5
- [ ] 可售票数增加5
- [ ] version增加1
- [ ] 订单状态为"已取消"

### 测试5: 并发购买测试

**操作步骤**:
1. 打开2个浏览器窗口
2. 都登录A端（可以用不同账号）
3. 同时选择同一个展览、日期、时间段
4. 同时点击购买（尽量同时）

**预期结果**:
- 一个成功，一个可能失败（如果库存不足）
- 或者都成功（如果库存充足）
- 不会出现超卖

**验证**:
```sql
-- 查看库存
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = ? 
  AND ticket_date = ? 
  AND time_slot = ?;

-- 验证: sold_tickets = 实际购买的总数
-- 验证: available_tickets = total_tickets - sold_tickets
```

**检查项**:
- [ ] 没有超卖
- [ ] 库存数量正确
- [ ] 订单数量正确

### 测试6: 库存不足测试

**操作步骤**:
1. 创建一个小库存展览（如上午票数=5）
2. 尝试购买10张票

**预期结果**:
- 提示"库存不足，剩余5张"
- 订单创建失败
- 库存不变

**检查项**:
- [ ] 正确提示库存不足
- [ ] 订单未创建
- [ ] 库存未扣减

### 测试7: 作废订单（B端）

**操作步骤**:
1. 创建一个订单并支付（状态变为"待使用"）
2. 登录B端
3. 进入"订单管理"
4. 找到该订单
5. 点击"作废"

**验证**:
```sql
-- 查看库存是否恢复
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = ? 
  AND ticket_date = ? 
  AND time_slot = ?;
```

**检查项**:
- [ ] 订单作废成功
- [ ] 库存已恢复
- [ ] 订单状态为"已作废"

## 📊 数据一致性检查

### 检查1: 库存与订单一致性

```sql
-- 计算某个时间段的实际已售票数
SELECT 
    oi.exhibition_id,
    oi.ticket_date,
    oi.time_slot,
    SUM(oi.quantity) AS actual_sold
FROM order_item oi
JOIN ticket_order o ON oi.order_id = o.id
WHERE o.status IN (1, 2)  -- 待使用、已使用
  AND oi.exhibition_id = ?
  AND oi.ticket_date = ?
  AND oi.time_slot = ?
GROUP BY oi.exhibition_id, oi.ticket_date, oi.time_slot;

-- 对比库存表的sold_tickets
SELECT sold_tickets 
FROM exhibition_time_slot_inventory
WHERE exhibition_id = ?
  AND ticket_date = ?
  AND time_slot = ?;

-- 两者应该相等
```

**检查项**:
- [ ] 库存表的sold_tickets = 实际已售票数
- [ ] 没有数据不一致

### 检查2: 总票数检查

```sql
-- 验证: total_tickets = sold_tickets + available_tickets
SELECT 
    id,
    total_tickets,
    sold_tickets,
    available_tickets,
    (sold_tickets + available_tickets) AS calculated_total,
    CASE 
        WHEN total_tickets = (sold_tickets + available_tickets) 
        THEN 'OK' 
        ELSE 'ERROR' 
    END AS status
FROM exhibition_time_slot_inventory;
```

**检查项**:
- [ ] 所有记录的status都是'OK'
- [ ] 没有数据错误

## 🔍 性能测试

### 测试1: 查询性能

```sql
-- 测试查询某天库存的速度
EXPLAIN SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = 1 
  AND ticket_date = '2026-02-10';

-- 应该使用索引: idx_exhibition_id
```

**检查项**:
- [ ] 使用了索引
- [ ] 查询速度快（< 10ms）

### 测试2: 更新性能

```sql
-- 测试更新库存的速度
-- 执行多次扣减库存操作，观察响应时间
```

**检查项**:
- [ ] 更新速度快（< 50ms）
- [ ] 没有锁等待

## 📝 日志检查

### 后端日志

**检查项**:
- [ ] 没有错误日志
- [ ] 没有警告日志
- [ ] 库存操作有正确的日志记录

### 数据库日志

**检查项**:
- [ ] 没有死锁
- [ ] 没有慢查询
- [ ] 事务正常提交

## ✅ 最终验证

### 完整流程测试

1. [ ] 创建展览 → 库存自动初始化
2. [ ] 查询库存 → 返回正确数据
3. [ ] 购买门票 → 库存正确扣减
4. [ ] 支付订单 → 库存不变
5. [ ] 核销订单 → 库存不变
6. [ ] 取消订单 → 库存正确恢复
7. [ ] 作废订单 → 库存正确恢复
8. [ ] 并发购买 → 没有超卖
9. [ ] 库存不足 → 正确提示

### 边界条件测试

1. [ ] 购买数量 = 剩余库存 → 成功，库存变为0
2. [ ] 购买数量 > 剩余库存 → 失败，提示库存不足
3. [ ] 库存为0时购买 → 失败，提示库存不足
4. [ ] 取消已支付订单 → 不允许（只能作废）
5. [ ] 作废待支付订单 → 不允许（只能取消）

## 🎉 验证完成

如果所有检查项都通过，说明库存管理系统已经成功实施！

### 下一步工作

- [ ] 前端集成库存显示
- [ ] 添加定时任务清理超时订单
- [ ] 添加库存预警功能
- [ ] 性能优化（缓存）

---

**重要提示**: 
- 在生产环境部署前，务必完成所有测试
- 建议先在测试环境验证
- 做好数据备份
