# 库存自动使用展览门票数量说明

## 问题描述

**现象：**
- B端设置了"每小时门票数量"（如：100张）
- 批量生成库存后，A端显示"剩余0张"
- 用户无法购票

**原因：**
- 批量生成库存时，使用的是前端传入的 `totalCount` 参数
- 而不是展览设置的 `ticketsPerHour` 字段
- 导致库存数量不正确

---

## 解决方案

### 修改批量生成库存逻辑

**文件：** `shared-backend/src/main/java/com/buyticket/controller/admin/AdminTicketInventoryController.java`

**修改内容：**

1. **注入 ExhibitionService**
   ```java
   @Autowired
   private com.buyticket.service.ExhibitionService exhibitionService;
   ```

2. **修改批量创建逻辑**
   - 获取展览信息
   - 读取展览的 `ticketsPerHour` 字段
   - 使用该值作为库存数量
   - 如果展览未设置，则使用请求参数或默认值100

**优先级：**
1. 展览的 `ticketsPerHour` 字段（最高优先级）
2. 请求参数的 `totalCount`
3. 默认值 100

**代码逻辑：**
```java
// 获取展览信息
Exhibition exhibition = exhibitionService.getById(request.getExhibitionId());

// 确定每小时门票数量
Integer ticketsPerHour = exhibition.getTicketsPerHour();
if (ticketsPerHour == null || ticketsPerHour <= 0) {
    ticketsPerHour = request.getTotalCount() != null && request.getTotalCount() > 0 
        ? request.getTotalCount() 
        : 100;
}

// 使用 ticketsPerHour 创建库存
inventory.setTotalCount(ticketsPerHour);
```

---

## 使用流程

### 1. 创建展览

**步骤：**
1. 进入 B端 > 展览管理 > 创建展览
2. 填写展览信息
3. **设置"每小时门票数量"**（如：100）
4. 点击"保存"

**效果：**
- 展览的 `tickets_per_hour` 字段被设置为 100

### 2. 批量生成库存

**步骤：**
1. 进入 B端 > 门票管理 > 库存管理
2. 点击"批量生成库存"
3. 选择展览
4. 选择日期范围（如：2026-02-01 到 2026-02-28）
5. 选择时间段（如：09:00-12:00, 14:00-17:00）
6. **不需要手动输入数量**（系统自动使用展览设置的值）
7. 点击"生成"

**效果：**
- 系统自动为每个日期的每个时间段创建库存
- 每条库存记录的 `total_count` = 100（展览设置的值）
- 提示："成功创建 XX 条库存记录，每个时间段 100 张票"

### 3. A端查看剩余票数

**步骤：**
1. 进入 A端 > 展览列表
2. 点击任意展览
3. 点击"购票"按钮
4. 选择日期和时间段

**效果：**
- 显示"剩余100张"（或实际剩余数量）
- 用户可以正常购票

---

## 测试步骤

### 测试1：新建展览并生成库存

1. **创建展览**
   - [ ] 进入 B端 > 创建展览
   - [ ] 设置"每小时门票数量" = 50
   - [ ] 保存展览

2. **生成库存**
   - [ ] 进入 B端 > 库存管理
   - [ ] 批量生成库存
   - [ ] 选择刚创建的展览
   - [ ] 选择日期范围和时间段
   - [ ] 点击"生成"
   - [ ] 确认提示："成功创建 XX 条库存记录，每个时间段 50 张票"

3. **验证库存**
   - [ ] 在库存列表中查看
   - [ ] 确认每条记录的"总数"为 50
   - [ ] 确认"已售"为 0
   - [ ] 确认"剩余"为 50

4. **A端验证**
   - [ ] 进入 A端 > 展览详情
   - [ ] 点击"购票"
   - [ ] 选择日期和时间段
   - [ ] 确认显示"剩余50张"

### 测试2：修改展览门票数量

1. **修改展览**
   - [ ] 进入 B端 > 展览列表
   - [ ] 点击"详情"编辑展览
   - [ ] 修改"每小时门票数量" = 200
   - [ ] 保存

2. **重新生成库存**
   - [ ] 删除旧的库存记录
   - [ ] 重新批量生成库存
   - [ ] 确认提示："成功创建 XX 条库存记录，每个时间段 200 张票"

3. **验证**
   - [ ] 库存列表中"总数"为 200
   - [ ] A端显示"剩余200张"

### 测试3：未设置门票数量的展览

1. **创建展览（不设置门票数量）**
   - [ ] 创建展览时不填写"每小时门票数量"
   - [ ] 或设置为 0
   - [ ] 保存

2. **生成库存**
   - [ ] 批量生成库存
   - [ ] 在生成界面手动输入数量 = 80
   - [ ] 点击"生成"

3. **验证**
   - [ ] 库存"总数"为 80（使用手动输入的值）
   - [ ] 如果也没有手动输入，则使用默认值 100

---

## 数据库验证

### 查看展览的门票数量设置

```sql
SELECT id, name, tickets_per_hour 
FROM exhibition 
WHERE id = 1;
```

**预期结果：**
```
+----+------------------+------------------+
| id | name             | tickets_per_hour |
+----+------------------+------------------+
|  1 | 航天成就展       |              100 |
+----+------------------+------------------+
```

### 查看库存记录

```sql
SELECT exhibition_id, ticket_date, time_slot, total_count, sold_count 
FROM ticket_inventory 
WHERE exhibition_id = 1 
LIMIT 5;
```

**预期结果：**
```
+---------------+-------------+--------------+-------------+------------+
| exhibition_id | ticket_date | time_slot    | total_count | sold_count |
+---------------+-------------+--------------+-------------+------------+
|             1 | 2026-02-01  | 09:00-12:00  |         100 |          0 |
|             1 | 2026-02-01  | 14:00-17:00  |         100 |          0 |
|             1 | 2026-02-02  | 09:00-12:00  |         100 |          0 |
|             1 | 2026-02-02  | 14:00-17:00  |         100 |          0 |
|             1 | 2026-02-03  | 09:00-12:00  |         100 |          0 |
+---------------+-------------+--------------+-------------+------------+
```

### 验证剩余票数计算

```sql
SELECT 
    exhibition_id,
    ticket_date,
    time_slot,
    total_count,
    sold_count,
    (total_count - sold_count) AS remaining_count
FROM ticket_inventory 
WHERE exhibition_id = 1 
  AND ticket_date = '2026-02-01'
  AND time_slot = '09:00-12:00';
```

**预期结果：**
```
+---------------+-------------+-------------+-------------+------------+-----------------+
| exhibition_id | ticket_date | time_slot   | total_count | sold_count | remaining_count |
+---------------+-------------+-------------+-------------+------------+-----------------+
|             1 | 2026-02-01  | 09:00-12:00 |         100 |          0 |             100 |
+---------------+-------------+-------------+-------------+------------+-----------------+
```

---

## 常见问题

### 1. A端仍然显示"剩余0张"

**可能原因：**
- 库存未生成
- 日期或时间段不匹配
- 数据库字段未添加

**解决方法：**
```bash
# 1. 检查数据库字段
mysql -u root -p -e "USE buyticket; SHOW COLUMNS FROM exhibition LIKE 'tickets_per_hour';"

# 2. 检查展览设置
mysql -u root -p -e "USE buyticket; SELECT id, name, tickets_per_hour FROM exhibition;"

# 3. 检查库存数据
mysql -u root -p -e "USE buyticket; SELECT * FROM ticket_inventory WHERE exhibition_id = 1 LIMIT 5;"

# 4. 重新生成库存
# 在B端 > 库存管理 > 批量生成库存
```

### 2. 批量生成库存失败

**可能原因：**
- 展览不存在
- 日期格式错误
- 时间段格式错误

**解决方法：**
- 检查展览ID是否正确
- 日期格式：YYYY-MM-DD
- 时间段格式：HH:MM-HH:MM（如：09:00-12:00）

### 3. 库存数量不是展览设置的值

**可能原因：**
- 后端代码未更新
- 展览的 `tickets_per_hour` 字段为空或0

**解决方法：**
```bash
# 1. 重启后端
cd /www/wwwroot/shared-backend
pkill -f buyticket
mvn clean package -DskipTests
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 2. 更新展览的门票数量
mysql -u root -p -e "USE buyticket; UPDATE exhibition SET tickets_per_hour = 100 WHERE id = 1;"

# 3. 重新生成库存
```

---

## 部署步骤

### 1. 更新后端代码

```bash
cd /www/wwwroot/shared-backend

# 停止服务
pkill -f buyticket

# 重新编译
mvn clean package -DskipTests

# 启动服务
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 查看日志
tail -f app.log
```

### 2. 验证功能

```bash
# 测试批量生成库存接口
curl -X POST http://localhost:8089/api/v1/admin/ticket/inventory/batch-create \
  -H "Content-Type: application/json" \
  -d '{
    "exhibitionId": 1,
    "startDate": "2026-02-01",
    "endDate": "2026-02-05",
    "timeSlots": ["09:00-12:00", "14:00-17:00"]
  }'
```

---

## 版本信息

- 修改日期：2026-01-30
- 修改人：Kiro AI
- 版本：v1.6
- 功能：库存自动使用展览设置的每小时门票数量

