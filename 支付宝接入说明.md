# 支付宝支付接入说明

## 一、前置准备

### 1. 支付宝开放平台配置

在接入支付宝支付之前，你需要在支付宝开放平台完成以下配置：

1. **注册并登录**：访问 [支付宝开放平台](https://open.alipay.com/)
2. **创建应用**：创建网页/移动应用
3. **获取配置信息**：
   - **AppID**：应用唯一标识
   - **应用私钥**：RSA2 私钥（自己生成并保管）
   - **支付宝公钥**：从开放平台获取（上传应用公钥后获得）

### 2. 生成密钥对（RSA2）

支付宝提供了密钥生成工具：
- 下载地址：https://opendocs.alipay.com/common/02kipl
- 选择密钥格式：PKCS1（非JAVA适用）或 PKCS8（JAVA适用）
- 密钥长度：2048位
- 生成后会得到：
  - **应用私钥**（privateKey）：保存在你的服务器，用于签名
  - **应用公钥**（publicKey）：上传到支付宝开放平台

### 3. 配置应用信息

在支付宝开放平台配置：
- **接口加签方式**：选择 RSA2(SHA256)
- **应用公钥**：上传你生成的应用公钥
- **授权回调地址**：配置你的域名（如：http://yourdomain.com）
- **接口内容加密方式**：可选，一般不需要

---

## 二、后端配置

### 1. 填写配置文件

编辑 `shared-backend/src/main/resources/alipay.properties`：

```properties
# 应用ID（必填）- 从支付宝开放平台获取
alipay.appId=2021001234567890

# 商户私钥（必填）- 你生成的应用私钥（PKCS8格式，去掉头尾和换行）
alipay.privateKey=MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...

# 支付宝公钥（必填）- 从支付宝开放平台获取（不是应用公钥！）
alipay.publicKey=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...

# 支付宝网关地址
# 沙箱环境（测试用）：https://openapi.alipaydev.com/gateway.do
# 正式环境（生产用）：https://openapi.alipay.com/gateway.do
alipay.gatewayUrl=https://openapi.alipaydev.com/gateway.do

# 支付成功后的同步回调地址（必填）- 用户支付完成后跳转的前端页面
alipay.returnUrl=http://localhost:3000/payment/success

# 支付成功后的异步通知地址（必填）- 支付宝服务器通知的后端接口
# 注意：此地址必须是公网可访问的地址！本地开发可使用内网穿透工具（如 ngrok）
alipay.notifyUrl=http://your-domain.com/api/v1/payment/alipay/notify
```

**重要提示**：
- `privateKey` 和 `publicKey` 需要去掉 `-----BEGIN PRIVATE KEY-----` 等头尾标识
- `privateKey` 和 `publicKey` 需要去掉所有换行符，保持为一行
- `notifyUrl` 必须是公网可访问的地址，支付宝服务器会主动调用此接口

### 2. Maven 依赖

已在 `pom.xml` 中添加支付宝 SDK 依赖：

```xml
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.38.157.ALL</version>
</dependency>
```

执行 Maven 更新：
```bash
mvn clean install
```

### 3. 重启后端服务

配置完成后，重启 Spring Boot 应用：
```bash
# 停止现有容器
docker-compose down

# 重新构建并启动
docker-compose up --build -d
```

---

## 三、接口说明

### 1. 创建支付订单（PC端）

**接口**：`POST /api/v1/payment/alipay/create`

**请求参数**：
```json
{
  "orderId": 1,
  "type": "ticket"
}
```

**返回数据**：
```json
{
  "code": 0,
  "msg": "成功",
  "data": "<form>...</form>"  // HTML表单，前端直接渲染即可跳转到支付宝
}
```

**前端处理**：
```javascript
// 获取返回的 HTML 表单
const payForm = response.data;

// 创建临时 div 并插入表单
const div = document.createElement('div');
div.innerHTML = payForm;
document.body.appendChild(div);

// 自动提交表单，跳转到支付宝
document.forms[0].submit();
```

### 2. 创建支付订单（移动端）

**接口**：`POST /api/v1/payment/alipay/create-wap`

**请求参数**：同 PC 端

**说明**：移动端支付会跳转到适配手机的支付页面

### 3. 查询支付状态

**接口**：`GET /api/v1/payment/alipay/query?orderNo=T2025121100000001`

**返回数据**：
```json
{
  "code": 0,
  "msg": "成功",
  "data": {
    "tradeStatus": "TRADE_SUCCESS",  // 交易状态
    "tradeNo": "2024123122001234567890",  // 支付宝交易号
    "totalAmount": "100.00"  // 交易金额
  }
}
```

### 4. 支付宝异步通知

**接口**：`POST /api/v1/payment/alipay/notify`

**说明**：
- 此接口由支付宝服务器主动调用，无需前端调用
- 支付成功后，支付宝会多次调用此接口（最多 8 次）
- 接口返回 `success` 表示处理成功，支付宝停止通知
- 接口返回 `failure` 表示处理失败，支付宝会继续通知

**处理逻辑**：
1. 验证签名（防止伪造通知）
2. 判断交易状态（TRADE_SUCCESS 或 TRADE_FINISHED）
3. 更新订单状态为"已支付"
4. 返回 `success`

### 5. 退款

**接口**：`POST /api/v1/payment/alipay/refund`

**请求参数**：
```json
{
  "orderNo": "T2025121100000001",
  "refundAmount": "100.00",
  "refundReason": "用户申请退款"
}
```

**返回数据**：
```json
{
  "code": 0,
  "msg": "成功",
  "data": {
    "success": true,
    "tradeNo": "2024123122001234567890",
    "refundFee": "100.00"
  }
}
```

---

## 四、前端集成示例

### 1. 创建支付（Vue 3 示例）

```vue
<template>
  <el-button @click="handlePay" type="primary">立即支付</el-button>
</template>

<script setup>
import { ElMessage } from 'element-plus';
import request from '@/utils/request';

const props = defineProps({
  orderId: Number
});

const handlePay = async () => {
  try {
    const res = await request.post('/payment/alipay/create', {
      orderId: props.orderId,
      type: 'ticket'
    });
    
    if (res.code === 0) {
      // 创建临时 div
      const div = document.createElement('div');
      div.innerHTML = res.data;
      document.body.appendChild(div);
      
      // 自动提交表单
      document.forms[0].submit();
    } else {
      ElMessage.error(res.msg);
    }
  } catch (error) {
    ElMessage.error('支付失败');
  }
};
</script>
```

### 2. 支付成功页面

创建 `frontend-a/src/views/PaymentSuccess.vue`：

```vue
<template>
  <div class="payment-success">
    <el-result
      icon="success"
      title="支付成功"
      sub-title="您的订单已支付成功，请在个人中心查看订单详情"
    >
      <template #extra>
        <el-button type="primary" @click="goToOrders">查看订单</el-button>
        <el-button @click="goToHome">返回首页</el-button>
      </template>
    </el-result>
  </div>
</template>

<script setup>
import { useRouter } from 'vue-router';

const router = useRouter();

const goToOrders = () => {
  router.push('/profile');
};

const goToHome = () => {
  router.push('/');
};
</script>

<style scoped>
.payment-success {
  padding: 100px 20px;
}
</style>
```

在路由中添加：
```javascript
{
  path: '/payment/success',
  name: 'PaymentSuccess',
  component: () => import('@/views/PaymentSuccess.vue')
}
```

---

## 五、测试流程

### 1. 使用沙箱环境测试

支付宝提供了沙箱环境用于测试：

1. **登录沙箱**：https://openhome.alipay.com/develop/sandbox/app
2. **获取沙箱账号**：
   - 买家账号（用于支付测试）
   - 卖家账号（商户账号）
3. **配置沙箱网关**：`alipay.gatewayUrl=https://openapi.alipaydev.com/gateway.do`

### 2. 测试步骤

1. **创建订单**：在前端创建一个门票订单
2. **发起支付**：点击"立即支付"按钮
3. **跳转支付宝**：自动跳转到支付宝支付页面
4. **登录支付**：使用沙箱买家账号登录并完成支付
5. **同步回调**：支付完成后跳转到 `returnUrl` 页面
6. **异步通知**：支付宝服务器调用 `notifyUrl` 接口
7. **查询订单**：在个人中心查看订单状态是否更新为"已支付"

### 3. 本地开发注意事项

**问题**：`notifyUrl` 必须是公网地址，本地开发无法接收通知

**解决方案**：使用内网穿透工具

#### 方案一：使用 ngrok

```bash
# 安装 ngrok
# 下载地址：https://ngrok.com/download

# 启动内网穿透（假设后端运行在 8080 端口）
ngrok http 8080

# 会得到一个公网地址，如：https://abc123.ngrok.io
# 将此地址配置到 alipay.notifyUrl
alipay.notifyUrl=https://abc123.ngrok.io/api/v1/payment/alipay/notify
```

#### 方案二：使用 natapp（国内）

```bash
# 下载 natapp
# 官网：https://natapp.cn/

# 启动内网穿透
natapp -authtoken=你的token

# 配置 notifyUrl
alipay.notifyUrl=https://your-subdomain.natapp1.cc/api/v1/payment/alipay/notify
```

---

## 六、常见问题

### 1. 签名验证失败

**原因**：
- 私钥或公钥配置错误
- 私钥格式不正确（包含换行符或头尾标识）
- 使用了应用公钥而不是支付宝公钥

**解决**：
- 检查 `alipay.properties` 配置
- 确保使用的是支付宝公钥（从开放平台获取）
- 确保私钥是 PKCS8 格式且去掉了换行符

### 2. 异步通知未收到

**原因**：
- `notifyUrl` 不是公网地址
- 服务器防火墙拦截
- 接口返回了非 `success` 字符串

**解决**：
- 使用内网穿透工具（开发环境）
- 检查服务器防火墙配置
- 确保接口正确返回 `success`

### 3. 订单状态未更新

**原因**：
- 异步通知处理失败
- 数据库更新失败
- 订单号不匹配

**解决**：
- 查看后端日志，检查异步通知是否收到
- 检查数据库连接和更新逻辑
- 确保订单号格式正确

### 4. 支付金额不一致

**原因**：
- 订单金额单位错误（元 vs 分）
- 金额格式不正确

**解决**：
- 支付宝金额单位是"元"，保留两位小数
- 确保金额格式为字符串，如 "100.00"

---

## 七、上线前检查清单

- [ ] 将 `alipay.gatewayUrl` 改为正式环境地址
- [ ] 配置正式环境的 AppID、私钥、公钥
- [ ] 配置正式的 `returnUrl` 和 `notifyUrl`（使用生产域名）
- [ ] 确保 `notifyUrl` 可公网访问
- [ ] 在支付宝开放平台签约"手机网站支付"或"电脑网站支付"产品
- [ ] 测试完整支付流程（创建订单 → 支付 → 回调 → 状态更新）
- [ ] 测试退款流程
- [ ] 配置 HTTPS（支付宝要求生产环境使用 HTTPS）
- [ ] 备份密钥文件，妥善保管

---

## 八、相关文档

- [支付宝开放平台](https://open.alipay.com/)
- [电脑网站支付文档](https://opendocs.alipay.com/open/270)
- [手机网站支付文档](https://opendocs.alipay.com/open/203)
- [支付宝 SDK 文档](https://opendocs.alipay.com/open/54/00y8k9)
- [密钥生成工具](https://opendocs.alipay.com/common/02kipl)

---

## 九、技术支持

如遇到问题，可以：
1. 查看支付宝开放平台文档
2. 在支付宝开放社区提问：https://forum.alipay.com/
3. 联系支付宝技术支持

---

**祝你接入顺利！** 🎉
