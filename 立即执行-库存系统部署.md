# 立即执行 - 库存系统部署

## 🚀 3步完成部署

### 第1步：创建数据库表（2分钟）

打开MySQL命令行或Navicat，执行：

```sql
CREATE TABLE exhibition_time_slot_inventory (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exhibition_id BIGINT NOT NULL COMMENT '展览ID',
    ticket_date DATE NOT NULL COMMENT '门票日期',
    time_slot VARCHAR(50) NOT NULL COMMENT '时间段',
    total_tickets INT NOT NULL DEFAULT 0 COMMENT '总票数',
    sold_tickets INT NOT NULL DEFAULT 0 COMMENT '已售票数',
    available_tickets INT NOT NULL DEFAULT 0 COMMENT '可售票数',
    version INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_exhibition_date_slot (exhibition_id, ticket_date, time_slot),
    INDEX idx_exhibition_id (exhibition_id),
    INDEX idx_ticket_date (ticket_date)
) COMMENT='展览时间段库存表';
```

**验证**：
```sql
SHOW TABLES LIKE 'exhibition_time_slot_inventory';
-- 应该看到表已创建
```

### 第2步：重启后端服务（1分钟）

停止并重新启动后端服务。

### 第3步：测试（5分钟）

#### 3.1 创建测试展览

1. 登录B端：http://localhost:5174
2. 账号：admin / 123456
3. 进入"展览管理" → "创建展览"
4. 填写：
   - 展览名称：测试库存展览
   - 开始日期：2026-03-01
   - 结束日期：2026-03-03
   - **上午票数：100**
   - **下午票数：150**
   - 价格：50
   - 其他必填字段
5. 保存

#### 3.2 验证库存生成

在MySQL中执行：
```sql
SELECT 
    ticket_date AS 日期,
    time_slot AS 时间段,
    total_tickets AS 总票数,
    sold_tickets AS 已售,
    available_tickets AS 可售
FROM exhibition_time_slot_inventory
WHERE exhibition_id = (SELECT MAX(id) FROM exhibition)
ORDER BY ticket_date, time_slot;
```

**预期结果**：应该看到6条记录（3天 × 2时段）
```
日期        | 时间段      | 总票数 | 已售 | 可售
2026-03-01 | 09:00-12:00 | 100   | 0    | 100
2026-03-01 | 14:00-17:00 | 150   | 0    | 150
2026-03-02 | 09:00-12:00 | 100   | 0    | 100
2026-03-02 | 14:00-17:00 | 150   | 0    | 150
2026-03-03 | 09:00-12:00 | 100   | 0    | 100
2026-03-03 | 14:00-17:00 | 150   | 0    | 150
```

#### 3.3 测试前端显示

1. 登录A端：http://localhost:5173
2. 账号：zhangsan / 123456
3. 选择"测试库存展览"
4. 点击"购票"
5. 选择日期：2026-03-01
6. **观察时间段卡片**：
   - 应该看到两个卡片
   - 上午场：09:00-12:00，剩余 100 张
   - 下午场：14:00-17:00，剩余 150 张

#### 3.4 测试购票扣减库存

1. 点击"上午场"卡片
2. 点击"确认"
3. 填写联系信息
4. 购买数量：5张
5. 提交订单
6. 完成支付

#### 3.5 验证库存扣减

在MySQL中执行：
```sql
SELECT * FROM exhibition_time_slot_inventory
WHERE exhibition_id = (SELECT MAX(id) FROM exhibition)
  AND ticket_date = '2026-03-01'
  AND time_slot = '09:00-12:00';
```

**预期结果**：
```
sold_tickets = 5
available_tickets = 95
version = 1
```

#### 3.6 测试前端实时更新

1. 返回A端日期选择页面
2. 重新选择日期：2026-03-01
3. **观察上午场卡片**：应该显示"剩余 95 张"

## ✅ 成功标志

如果看到以下结果，说明部署成功：

- [x] 数据库表创建成功
- [x] 创建展览后自动生成库存记录
- [x] 前端显示两个时间段卡片
- [x] 每个卡片显示实时剩余票数
- [x] 购票后库存正确扣减
- [x] 前端显示更新后的库存

## 🎯 核心功能

### 1. 自动初始化库存
创建展览时，系统自动为每天生成库存记录：
- 每天上午场：100张（可配置）
- 每天下午场：150张（可配置）

### 2. 实时显示库存
前端显示每个时间段的实时剩余票数：
- 绿色显示剩余票数
- 红色显示"已售罄"
- 已售罄的时间段无法点击

### 3. 自动扣减库存
用户购票时自动扣减对应时间段的库存：
- 使用乐观锁防止超卖
- 事务保证数据一致性

### 4. 自动恢复库存
用户取消订单或管理员作废订单时自动恢复库存。

## 📊 界面效果

### 时间段选择界面

```
┌────────────────────────────────────┐
│         选择时间段                  │
├────────────────────────────────────┤
│  ┌──────────┐    ┌──────────┐     │
│  │09:00-12:00│    │14:00-17:00│    │
│  │  上午场   │    │  下午场   │    │
│  │剩余 100 张│    │剩余 150 张│    │
│  └──────────┘    └──────────┘     │
└────────────────────────────────────┘
```

### 已售罄状态

```
┌────────────────────────────────────┐
│         选择时间段                  │
├────────────────────────────────────┤
│  ┌──────────┐    ┌──────────┐     │
│  │09:00-12:00│    │14:00-17:00│    │
│  │  上午场   │    │  下午场   │    │
│  │  已售罄   │    │剩余 50 张 │    │
│  └──────────┘    └──────────┘     │
│   (灰色禁用)       (可点击)        │
└────────────────────────────────────┘
```

## 🔧 故障排查

### 问题1：前端显示"剩余 0 张"

**原因**：库存表没有数据

**解决**：
1. 检查表是否创建：`SHOW TABLES LIKE 'exhibition_time_slot_inventory';`
2. 检查是否有数据：`SELECT COUNT(*) FROM exhibition_time_slot_inventory;`
3. 如果没有数据，重新创建展览

### 问题2：创建展览后没有生成库存

**原因**：后端没有重启

**解决**：
1. 停止后端服务
2. 重新启动后端服务
3. 重新创建展览

### 问题3：购票后库存没有扣减

**原因**：订单状态不是"已支付"

**解决**：
1. 检查订单状态：`SELECT * FROM ticket_order WHERE id = 订单ID;`
2. 只有status=1或2的订单才会扣减库存
3. status=0（待支付）的订单也会扣减库存，但取消后会恢复

### 问题4：前端显示不更新

**原因**：浏览器缓存

**解决**：
1. 刷新页面（F5）
2. 重新选择日期
3. 清除浏览器缓存

## 📝 数据库检查命令

### 查看所有展览的库存记录数
```sql
SELECT 
    e.id AS 展览ID,
    e.name AS 展览名称,
    COUNT(i.id) AS 库存记录数
FROM exhibition e
LEFT JOIN exhibition_time_slot_inventory i ON e.id = i.exhibition_id
GROUP BY e.id, e.name
ORDER BY e.id;
```

### 查看某个展览的详细库存
```sql
SELECT 
    ticket_date AS 日期,
    time_slot AS 时间段,
    total_tickets AS 总票数,
    sold_tickets AS 已售,
    available_tickets AS 可售,
    version AS 版本
FROM exhibition_time_slot_inventory
WHERE exhibition_id = 1
ORDER BY ticket_date, time_slot;
```

### 查看某天某时段的库存
```sql
SELECT * FROM exhibition_time_slot_inventory
WHERE exhibition_id = 1
  AND ticket_date = '2026-03-01'
  AND time_slot = '09:00-12:00';
```

## 🎉 完成！

如果所有测试都通过，恭喜你成功部署了库存管理系统！

现在你的系统可以：
- ✅ 精确管理每天每个时间段的库存
- ✅ 实时显示剩余票数
- ✅ 防止超卖
- ✅ 自动扣减和恢复库存
- ✅ 用户体验更好

---

**下一步**：
1. 为现有展览生成库存（如果有）
2. 测试并发购买
3. 添加定时任务清理超时订单
