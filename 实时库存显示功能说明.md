# 实时库存显示功能说明

## 已完成的修改

### 1. 后端修改

#### 修改文件：`TicketInventoryController.java`

**改动内容**：
- 将库存查询从旧的计算方式改为直接从 `exhibition_time_slot_inventory` 表读取
- 返回实时库存数据（总票数、已售票数、剩余票数）

**新的API响应**：
```json
{
  "code": 0,
  "data": {
    "remainingCount": 95,
    "totalTickets": 100,
    "soldTickets": 5
  }
}
```

### 2. 前端修改

#### 修改文件：`frontend-a/src/views/buyTicket/datechoose.vue`

**改动内容**：

1. **时间段卡片式显示**
   - 将原来的上下箭头选择改为卡片式点击选择
   - 每个时间段显示：时间、名称（上午场/下午场）、剩余票数

2. **实时库存显示**
   - 选择日期后，自动加载所有时间段的库存
   - 每个时间段卡片显示实时剩余票数
   - 已售罄的时间段显示"已售罄"并禁用点击

3. **视觉优化**
   - 选中的时间段高亮显示（蓝色边框）
   - 已售罄的时间段灰色显示
   - 剩余票数用绿色显示，已售罄用红色显示

## 使用流程

### 用户操作流程

1. **选择日期**
   - 用户在日历中选择日期
   - 系统自动加载该日期所有时间段的库存

2. **查看库存**
   - 上午场（09:00-12:00）显示剩余票数
   - 下午场（14:00-17:00）显示剩余票数
   - 已售罄的时间段显示"已售罄"

3. **选择时间段**
   - 点击有票的时间段卡片
   - 已售罄的时间段无法点击

4. **确认购买**
   - 点击"确认"按钮进入购票信息页面

## 界面效果

### 时间段卡片

```
┌─────────────────┐  ┌─────────────────┐
│  09:00-12:00   │  │  14:00-17:00   │
│    上午场       │  │    下午场       │
│  剩余 95 张     │  │  剩余 150 张    │
└─────────────────┘  └─────────────────┘
   (可点击)            (可点击)

┌─────────────────┐  ┌─────────────────┐
│  09:00-12:00   │  │  14:00-17:00   │
│    上午场       │  │    下午场       │
│    已售罄       │  │  剩余 50 张     │
└─────────────────┘  └─────────────────┘
  (灰色禁用)          (可点击)
```

### 选中状态

```
┌═════════════════┐  ┌─────────────────┐
║  09:00-12:00   ║  │  14:00-17:00   │
║    上午场       ║  │    下午场       │
║  剩余 95 张     ║  │  剩余 150 张    │
└═════════════════┘  └─────────────────┘
  (蓝色边框高亮)       (普通状态)
```

## 数据流程

```
用户选择日期
    ↓
前端调用API（并发加载两个时间段）
    ↓
GET /api/v1/ticket/availability?exhibitionId=1&date=2026-02-10&timeSlot=09:00-12:00
GET /api/v1/ticket/availability?exhibitionId=1&date=2026-02-10&timeSlot=14:00-17:00
    ↓
后端查询 exhibition_time_slot_inventory 表
    ↓
返回实时库存数据
    ↓
前端显示在时间段卡片上
```

## 关键代码

### 前端：加载所有时间段库存

```typescript
const loadAllSlotsInventory = async () => {
    if (!selectedDate.value || !exhibition.value.id) return;
    
    const dateStr = formatDate(selectedDate.value);
    const inventoryMap = new Map<string, number>();
    
    // 并发加载所有时间段的库存
    const promises = timeSlots.map(async (slot) => {
        const res = await ticketApi.getAvailability({
            exhibitionId: exhibition.value.id,
            date: dateStr,
            timeSlot: slot
        });
        inventoryMap.set(slot, res.remainingCount || 0);
    });
    
    await Promise.all(promises);
    slotsInventory.value = inventoryMap;
};
```

### 后端：从库存表读取

```java
@GetMapping("/availability")
public JsonData getAvailability(@RequestParam Long exhibitionId,
                                @RequestParam String date,
                                @RequestParam String timeSlot) {
    LocalDate ticketDate = LocalDate.parse(date);
    
    // 从库存表查询
    ExhibitionTimeSlotInventory inventory = inventoryService.getAvailableInventory(
        exhibitionId, ticketDate, timeSlot
    );
    
    Map<String, Object> result = new HashMap<>();
    if (inventory != null) {
        result.put("remainingCount", inventory.getAvailableTickets());
        result.put("totalTickets", inventory.getTotalTickets());
        result.put("soldTickets", inventory.getSoldTickets());
    } else {
        result.put("remainingCount", 0);
    }
    
    return JsonData.buildSuccess(result);
}
```

## 测试步骤

### 1. 准备工作

1. 执行SQL创建库存表：
```bash
mysql -u root -p buyticket < CREATE_TIME_SLOT_INVENTORY_TABLE.sql
```

2. 重启后端服务

3. 在B端创建测试展览：
   - 开始日期：2026-03-01
   - 结束日期：2026-03-03
   - 上午票数：100
   - 下午票数：150

### 2. 测试实时库存显示

1. 登录A端（zhangsan/123456）
2. 选择测试展览
3. 选择日期：2026-03-01
4. 观察时间段卡片：
   - 上午场显示"剩余 100 张"
   - 下午场显示"剩余 150 张"

### 3. 测试购票后库存更新

1. 选择上午场，购买5张票
2. 完成支付
3. 返回日期选择页面
4. 再次选择2026-03-01
5. 观察上午场应显示"剩余 95 张"

### 4. 测试已售罄显示

1. 创建一个小库存展览（上午票数：5）
2. 购买5张票
3. 返回日期选择页面
4. 观察上午场应显示"已售罄"且无法点击

## 优势

### 1. 实时性
- 每次选择日期都会重新加载库存
- 显示的是数据库中的实时数据
- 购票后立即反映在库存中

### 2. 用户体验
- 卡片式设计更直观
- 一眼看到所有时间段的库存
- 已售罄的时间段明确标识

### 3. 防止超卖
- 显示实时库存，用户知道剩余票数
- 已售罄的时间段无法选择
- 后端使用乐观锁保证不超卖

## 注意事项

### 1. 必须先创建库存表
如果没有执行SQL创建表，API会返回0库存。

### 2. 必须重启后端
修改代码后必须重启后端服务才能生效。

### 3. 新展览自动生成库存
创建展览时，系统会自动为每天每个时间段生成库存记录。

### 4. 旧展览需要迁移
如果有旧的展览数据，需要执行迁移脚本生成库存记录。

## 常见问题

### Q1: 显示剩余0张但实际有票？
**A**: 检查库存表是否有数据，可能需要执行迁移脚本。

### Q2: 购票后库存没有更新？
**A**: 刷新页面或重新选择日期，会重新加载库存。

### Q3: 所有时间段都显示已售罄？
**A**: 检查：
1. 库存表是否创建
2. 后端是否重启
3. 展览是否生成了库存记录

## 总结

✅ 实时显示每个时间段的库存
✅ 卡片式设计更直观
✅ 已售罄时间段自动禁用
✅ 从库存表读取，数据准确
✅ 购票后库存实时更新

下一步：执行SQL创建表 → 重启后端 → 测试功能
