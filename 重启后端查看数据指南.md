# 重启后端查看真实数据指南

## 问题现象
- Dashboard显示的数据为0
- 用户统计页面数据为0
- 今日核销了3张门票，但显示为0

## 原因分析
后端代码已修改，但**后端服务没有重启**，所以新的 `AdminStatisticsController` 没有生效。

## 解决步骤

### 1. 停止当前后端服务
如果后端正在运行，在运行的终端按 `Ctrl + C` 停止。

### 2. 重新编译并启动后端

#### 方法1：使用IDEA（推荐）
1. 打开 `shared-backend` 项目
2. 找到主类（带 `@SpringBootApplication` 注解的类）
3. 右键 → Run 或 Debug
4. 等待看到类似输出：
   ```
   Started Application in X.XXX seconds
   ```

#### 方法2：使用命令行
```bash
cd shared-backend
mvn clean spring-boot:run
```

### 3. 验证后端API

运行测试脚本：
```bash
test-dashboard-api.bat
```

或手动测试：
```bash
curl http://localhost:8080/api/v1/admin/statistics/dashboard
```

应该返回类似：
```json
{
  "code": 0,
  "data": {
    "todayTicketOrders": 0,
    "todayVerified": 3,
    "totalTicketOrders": 16,
    "userGrowth": [...],
    "orderTrend": [...],
    "salesTrend": [...]
  },
  "msg": "success"
}
```

### 4. 刷新前端页面

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 刷新 Dashboard 页面（F5）
4. 查看控制台输出：
   ```
   Dashboard API返回数据: {todayTicketOrders: 0, todayVerified: 3, ...}
   Dashboard数据已更新: {...}
   ```

### 5. 检查数据显示

#### Dashboard页面应该显示：
- **今日销售门票**: 今天创建的订单数
- **今日核销门票**: 3张（你今天核销的数量）
- **用户增长趋势**: 近7日累计用户数曲线
- **销售趋势**: 近7日每天的销售额
- **订单趋势**: 近7日每天的门票订单数

#### 用户统计页面应该显示：
- **总用户数**: 基于订单的唯一用户数
- **今日新增**: 今天首次下单的用户数
- **活跃用户**: 近7日有订单的用户数
- **用户注册趋势**: 近7日每天的订单数曲线

## 数据说明

### 今日核销门票统计规则
```java
// 查询条件
status = 2 (已使用)
verify_time >= 今天00:00:00
verify_time <= 今天23:59:59
```

### 用户增长趋势统计规则
```java
// 统计截止到每天的累计唯一用户数
SELECT DISTINCT user_id 
FROM ticket_order 
WHERE create_time <= '某天23:59:59'
```

### 订单趋势统计规则
```java
// 统计每天创建的订单数
SELECT COUNT(*) 
FROM ticket_order 
WHERE create_time BETWEEN '某天00:00:00' AND '某天23:59:59'
```

### 销售趋势统计规则
```java
// 统计每天的销售额（排除待支付和已取消）
SELECT SUM(total_amount) 
FROM ticket_order 
WHERE create_time BETWEEN '某天00:00:00' AND '某天23:59:59'
  AND status NOT IN (0, 3)
```

## 调试技巧

### 1. 查看浏览器控制台
打开F12，查看Console标签，应该能看到：
- `Dashboard API返回数据:` - 后端返回的原始数据
- `Dashboard数据已更新:` - 前端处理后的数据
- `用户统计API返回数据:` - 用户统计接口返回的数据

### 2. 查看Network标签
在Network标签中找到：
- `/api/v1/admin/statistics/dashboard` 请求
- 查看Response，确认返回的数据是否正确

### 3. 直接查询数据库
```sql
-- 查看今日核销数量
SELECT COUNT(*) as today_verified 
FROM ticket_order 
WHERE status = 2 
  AND DATE(verify_time) = CURDATE();

-- 查看今日创建的订单
SELECT COUNT(*) as today_orders 
FROM ticket_order 
WHERE DATE(create_time) = CURDATE();

-- 查看总用户数
SELECT COUNT(DISTINCT user_id) as total_users 
FROM ticket_order 
WHERE user_id IS NOT NULL;
```

## 常见问题

### Q1: 后端启动失败
**A**: 检查端口8080是否被占用：
```bash
netstat -ano | findstr :8080
```

### Q2: API返回404
**A**: 确认后端已启动，并且URL正确：
```
http://localhost:8080/api/v1/admin/statistics/dashboard
```

### Q3: 数据还是为0
**A**: 
1. 确认后端已重启
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 硬刷新页面（Ctrl+F5）
4. 检查数据库中是否真的有数据

### Q4: verify_time为空
**A**: 运行修复脚本：
```sql
-- 运行 FIX_VERIFY_TIME_DATA.sql
UPDATE ticket_order 
SET verify_time = update_time 
WHERE status = 2 AND verify_time IS NULL;
```

## 验证清单

- [ ] 后端服务已重启
- [ ] API测试返回正确数据
- [ ] 浏览器控制台显示正确数据
- [ ] Dashboard显示今日核销门票为3
- [ ] 用户增长趋势图有数据
- [ ] 订单趋势图有数据
- [ ] 销售趋势图有数据
- [ ] 用户统计页面有数据

## 下一步

如果完成以上步骤后数据仍然不正确，请：
1. 截图浏览器控制台的输出
2. 截图Network标签的API响应
3. 提供数据库查询结果
