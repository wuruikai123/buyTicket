# 支付宝支付前端集成说明

## 功能概述

已完成支付宝支付的前端集成，用户在购票或购买商品时，会跳转到支付页面选择支付方式，然后跳转到支付宝完成支付。

## 实现的功能

### 1. 支付API (`frontend-a/src/api/payment.ts`)

```typescript
// 创建支付宝PC网页支付
createAlipayPc(data: { orderId, orderType, returnUrl })

// 创建支付宝手机网页支付
createAlipayWap(data: { orderId, orderType, returnUrl })

// 查询支付状态
queryPayment(params: { orderId, orderType })
```

### 2. 支付页面 (`frontend-a/src/views/Payment.vue`)

- 显示订单信息（订单号、金额、类型）
- 支付方式选择（支付宝、微信-暂不支持）
- 自动识别PC/移动端，调用对应的支付接口
- 取消订单功能

### 3. 支付成功页面 (`frontend-a/src/views/OrderSuccess.vue`)

- 显示支付成功动画
- 显示订单信息和支付宝交易号
- 提供"查看订单详情"和"返回首页"按钮

### 4. 订单创建流程修改

#### 门票订单 (`frontend-a/src/views/buyTicket/ticketinfo.vue`)
- 创建订单后跳转到 `/payment/:orderId?type=ticket`

#### 商城订单 (`frontend-a/src/views/MallCheckout.vue`)
- 创建订单后跳转到 `/payment/:orderId?type=mall`

## 支付流程

```
用户填写订单信息
    ↓
创建订单（状态：待支付）
    ↓
跳转到支付页面 /payment/:orderId
    ↓
选择支付方式（支付宝）
    ↓
调用后端API生成支付表单
    ↓
自动提交表单跳转到支付宝
    ↓
用户在支付宝完成支付
    ↓
支付宝回调后端（异步通知）
    ↓
支付宝跳转回前端 /order-success
    ↓
显示支付成功页面
```

## 路由配置

已在 `frontend-a/src/router/index.ts` 中添加：

```typescript
{
  path: 'payment/:orderId',
  name: 'Payment',
  component: () => import('@/views/Payment.vue'),
},
{
  path: 'order-success',
  name: 'OrderSuccess',
  component: () => import('@/views/OrderSuccess.vue'),
}
```

## 后端接口要求

### 1. 创建支付宝支付

**PC网页支付**
- 接口：`POST /api/v1/payment/alipay/pc`
- 参数：
  ```json
  {
    "orderId": 123,
    "orderType": "ticket",
    "returnUrl": "http://localhost:3000/order-success"
  }
  ```
- 返回：
  ```json
  {
    "code": 0,
    "data": {
      "formHtml": "<form>...</form>"
    }
  }
  ```

**手机网页支付**
- 接口：`POST /api/v1/payment/alipay/wap`
- 参数和返回同上

### 2. 支付宝异步通知

- 接口：`POST /api/v1/payment/alipay/notify`
- 支付宝会POST通知到这个地址
- 需要验证签名并更新订单状态

### 3. 支付宝同步返回

- 用户支付完成后，支付宝会跳转到 `returnUrl`
- URL参数包含：
  - `out_trade_no`: 订单号
  - `trade_no`: 支付宝交易号
  - `total_amount`: 支付金额
  - 其他参数...

## 测试步骤

1. 启动后端服务，确保支付宝配置正确
2. 启动前端服务
3. 登录系统
4. 选择展览购票或商城购物
5. 填写订单信息，点击"支付"
6. 应该跳转到支付页面
7. 选择支付宝支付，点击"立即支付"
8. 会自动跳转到支付宝支付页面
9. 完成支付后，跳转回支付成功页面

## 注意事项

1. **支付宝配置**：需要在 `shared-backend/src/main/resources/alipay.properties` 中配置：
   - AppID
   - 应用私钥
   - 支付宝公钥
   - 网关地址
   - 回调地址

2. **内网穿透**：本地开发需要使用内网穿透工具（如natapp）将本地服务暴露到公网，支付宝才能回调

3. **HTTPS要求**：生产环境支付宝要求使用HTTPS

4. **订单状态**：
   - 0: 待支付
   - 1: 待使用/待发货
   - 2: 已使用/已发货
   - 3: 已完成
   - 4: 已取消

5. **支付超时**：建议设置订单30分钟超时自动取消

## 后续优化建议

1. 添加支付倒计时显示
2. 添加支付状态轮询（防止异步通知失败）
3. 添加微信支付支持
4. 添加余额支付选项
5. 优化移动端支付体验
6. 添加支付失败重试机制
