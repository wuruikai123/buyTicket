# 301 重定向问题完整解决方案

## 问题现象

访问日志显示：
```
POST /api/v1/admin/auth/login HTTP/1.1" 301 162
```

## 可能的原因

### 1. Spring Boot 默认行为
Spring Boot 会自动处理尾部斜杠：
- 如果请求 `/api/v1/admin/auth/login`，但实际路径是 `/api/v1/admin/auth/login/`
- 或者反过来
- Spring Boot 会返回 301 重定向

### 2. Nginx 配置问题
如果 Nginx 的 `proxy_pass` 配置不正确，会导致路径不匹配

### 3. 后端代码问题
Controller 可能有编译错误或路径定义问题

## 诊断步骤

### 步骤 1：直接测试后端（绕过 Nginx）

在服务器上执行：

```bash
# 测试 1：不带尾部斜杠
curl -i -X POST http://127.0.0.1:8089/api/v1/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 测试 2：带尾部斜杠
curl -i -X POST http://127.0.0.1:8089/api/v1/admin/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

**观察结果：**
- 如果测试 1 返回 200，说明后端正常，问题在 Nginx
- 如果测试 1 返回 301，说明后端有问题
- 如果测试 2 返回 200，说明后端需要尾部斜杠

### 步骤 2：检查后端是否正确编译

```bash
# 查看后端日志
tail -100 /path/to/backend/logs/application.log

# 或者查看 Spring Boot 启动日志
ps aux | grep java
```

查找是否有：
- 编译错误
- Controller 加载失败
- 路径映射错误

### 步骤 3：检查 Nginx 配置

```bash
# 查看当前配置
cat /www/server/panel/vhost/nginx/47.121.192.245_5174.conf | grep -A 5 "location /api"

# 应该看到
location /api/ {
    proxy_pass http://127.0.0.1:8089;  # 注意：没有尾部斜杠
    ...
}
```

## 解决方案

### 方案 A：修复 Spring Boot 配置（推荐）

如果后端返回 301，需要禁用 Spring Boot 的尾部斜杠重定向：

**创建配置类：**

```java
// shared-backend/src/main/java/com/buyticket/config/WebConfig.java
package com.buyticket.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.PathMatchConfigurer;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configurePathMatch(PathMatchConfigurer configurer) {
        // 禁用尾部斜杠匹配
        configurer.setUseTrailingSlashMatch(false);
    }
}
```

**然后重新编译并重启后端：**
```bash
cd shared-backend
mvn clean package -DskipTests
# 停止旧进程
kill -9 $(ps aux | grep 'buyticket' | grep -v grep | awk '{print $2}')
# 启动新进程
nohup java -jar target/buyticket-*.jar --server.port=8089 > backend.log 2>&1 &
```

### 方案 B：修改 Controller（如果方案A不行）

修改 `AdminAuthController.java`：

```java
@RestController
@RequestMapping("/api/v1/admin/auth")
public class AdminAuthController {
    
    // 同时支持带和不带斜杠
    @PostMapping(value = {"/login", "/login/"})
    public JsonData login(@RequestBody AdminUser loginReq) {
        // ... 原有代码
    }
}
```

### 方案 C：修改 Nginx 配置（临时方案）

如果后端确实需要尾部斜杠，修改 Nginx：

```nginx
location /api/ {
    # 使用 rewrite 添加尾部斜杠
    rewrite ^(/api/v1/admin/auth/login)$ $1/ permanent;
    
    proxy_pass http://127.0.0.1:8089;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

## 快速验证

### 1. 检查后端是否真的在运行

```bash
# 检查进程
ps aux | grep java | grep buyticket

# 检查端口
netstat -tlnp | grep 8089

# 测试后端健康
curl http://127.0.0.1:8089/api/v1/common/agreement
```

### 2. 检查后端日志

```bash
# 查看最新日志
tail -50 /path/to/backend/logs/application.log

# 或者查看 nohup 日志
tail -50 backend.log
```

查找：
- 是否有 `AdminAuthController` 加载成功的日志
- 是否有路径映射信息
- 是否有错误信息

### 3. 使用 curl 完整测试

```bash
# 完整的 curl 测试（显示所有信息）
curl -v -X POST http://127.0.0.1:8089/api/v1/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' 2>&1 | tee curl-test.log

# 查看结果
cat curl-test.log
```

## 最可能的问题

根据你的情况，最可能的问题是：

1. **后端没有正确编译**
   - AdminAuthController 有编译错误
   - JwtUtils.generateAdminToken 方法不存在（但我们已经确认存在）

2. **后端没有重启**
   - 修改了代码但没有重新编译
   - 旧版本的 jar 还在运行

3. **Spring Boot 版本问题**
   - 某些版本的 Spring Boot 对尾部斜杠处理不同

## 立即执行的命令

```bash
# 1. 测试后端
curl -i -X POST http://127.0.0.1:8089/api/v1/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 2. 如果返回 301，查看 Location 头
# 3. 如果返回 404，检查后端日志
# 4. 如果返回 500，检查后端日志

# 把结果告诉我！
```
