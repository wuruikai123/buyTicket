# 支付配置修复说明

## 🔴 问题描述

支付时出现错误：
```
创建支付订单失败: com.alipay.api.AlipayApiException: RSA签名遭遇异常,请检查私钥格式是否正确。私钥[privateKey]不可为空
```

**根本原因**：生产环境配置中支付宝私钥为空或未正确加载。

## ✅ 已修复内容

### 1. 更新了 `application.yml` 生产环境配置

- ✅ 添加了默认的支付宝私钥（使用开发环境的私钥作为临时方案）
- ✅ 更新了回调地址为 `https://ai-yishuguan.com`
- ✅ 保留了环境变量支持，优先使用环境变量

### 2. 添加了配置验证

在 `AlipayConfig.java` 中添加了启动时验证：
- ✅ 检查私钥不能为空
- ✅ 检查 APPID 不能为空
- ✅ 检查公钥不能为空
- ✅ 如果配置无效，启动时会立即报错

## 🚀 立即修复步骤

### 方案一：使用配置文件中的默认值（快速修复）

1. **重新编译后端**：
   ```bash
   cd shared-backend
   mvn clean package -DskipTests
   ```

2. **重启后端服务**：
   ```bash
   # 停止当前服务
   # 启动新服务
   java -jar target/buyticket2-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
   ```

3. **验证配置**：
   查看启动日志，应该看到：
   ```
   === 支付宝配置加载成功 ===
   APPID: 9021000158671506
   异步通知地址: https://ai-yishuguan.com/api/v1/payment/alipay/notify
   同步跳转地址: https://ai-yishuguan.com/order-success
   支付宝网关: https://openapi-sandbox.dl.alipaydev.com/gateway.do
   私钥长度: 1672
   ========================
   ```

### 方案二：使用环境变量（推荐生产环境）

1. **设置环境变量**（在服务器上）：
   ```bash
   export ALIPAY_APP_ID="你的支付宝APPID"
   export ALIPAY_MERCHANT_PRIVATE_KEY="你的商户私钥"
   export ALIPAY_PUBLIC_KEY="支付宝公钥"
   export ALIPAY_NOTIFY_URL="https://ai-yishuguan.com/api/v1/payment/alipay/notify"
   export ALIPAY_RETURN_URL="https://ai-yishuguan.com/order-success"
   export ALIPAY_GATEWAY_URL="https://openapi.alipay.com/gateway.do"  # 生产环境
   # 或
   export ALIPAY_GATEWAY_URL="https://openapi-sandbox.dl.alipaydev.com/gateway.do"  # 沙箱环境
   ```

2. **重启后端服务**

### 方案三：直接修改配置文件（不推荐，但最快）

如果服务器上不方便设置环境变量，可以直接修改 `application.yml`：

```yaml
alipay:
  app-id: 9021000158671506  # 你的真实APPID
  merchant-private-key: |  # 你的真实私钥（多行格式）
    MIIEwAIBADANBgkqhkiG9w0BAQEFAASCBKowggSmAgEAAoIBAQCo4Nm2s5DrnO70IyKKKJxlgdf5yp4TWxL3Pn9Ghv8vXF7flcO/lK+L83lD8spw2Tn2Tu+cQnWSdgV29NUoNeuhvUvfDYR6P0h/DIkBaCXBoEKo3hYA8PycoigVoBTvo/fv+PXOnyPJi1xGthtS1yGUlnrbP0rAMjVGcs4hSg+zMUnd/qKHQG8ZQCSvM9fl1apSgUgqphSSkNF4VILNtzOydfqZNIX+shSdRcS+xX5xnhIv3+m8lyZ7c7N+Rr1WXo3M2Thuxe3YhhSqJWp9gnFjyaWEOfZ3LJByp/ul4oOswy7AQjRXyu489hEl0x5peVLiqNpsQivzW536qtiuRJwPAgMBAAECggEBAI0HIKjTMb2g02frg2eO3HRkR0EhdHrDfoYcmdsC103svInInqx5dVPRIj6dHXO55A6OAskiMt75Ujzx3qPyy3DJDPgbaLtR56+5fxw+pfEZbTFqLUPh+4KuY/0TLwikjGPJKzS+bvtbNtcSMqUuZKuaMsSvCTSReS34p6zjFVNVBIDQYmFZaPY4A5V/2WuhUPfXizggCoBAC2UY+D6aI6/Gu5LgRI2a+cNJ05UaHl+a3LEqGGsYXoRY0yXO7ZYpZsp5nJqfNxGnTQ4bMfX1MZB0cn/1GFQiiefRQdRsHy03Vs0ANEJKnSVb7hek8yw0IBMJqnFW9AESSlxF/P2gb+ECgYEA4Lez+2wjG3AG2u2UlsavIoz0fSjZdn1MKyuLvQozzjQjZ/rFAE3X1rcBGR+olswapLm1nLN1/jQhJBYBEIes3jni/gTBAjUueRNJ04Z4V2pXQKFgyTqQtpsL1xGL8YHCwHLBSnQ8gqOuoVLOIeQiSfM5ClC6kvdT/VJ2Age1Dp8CgYEAwGMxxF2R8nUr8G48vqDtSH4RvA3nV6RPo5FLltN54YGV5n6g9SwpJqyLQrQVfktdnzP22W7Hf8FvJIREZ9JjslDSzez1vjzqTGezqCK/BNtRg/eC3Bftf4aNGMK7E1tZ/1IRoemWGoIT7M/DgD7vpkGLNRP6arfinwDTkkVMLJECgYEAtEvwBhu/FzaM6X6RJ2AGCGybhQgPYngpcsGffm7/HcTLW5PiF9pdAJMYOHYkJ8le3yd5RV7fnrNom7Fj7UVON4auTyy1RvYwcUg+hY5wY4KYuuw/4XQxw7EmkMotQ/nerdXkq74TBqYZaKotZRfLQxX4gARBjcUPCELvF7XjWPUCgYEAnT+2ytjsVO/+xRtlnS6uI+Wfm0UGBXWw/nHhBdu+sFqZ6ncwGpVI4WqAvTmyo7L4SAtSRfCtMbgqnv9ZZj7p7DLxyw1W43Ko02Cj0NbtqQuWejYRiNIp9mVE6Ksp+61cRzuOW/gwD2So4pQDKMzIVu0V2oGE2juJCQvE4ravh3ECgYEAyjSotxY3oK6n085IhnooIr4iTY59n8pQkw1oef44AWX5Whbq1+4SotARqSBN1hWQ26nRrdGTurGKHSUKh21hHeRGCR1hFWdQ+yFXQdUqZxT8BWMU5jDo4FF3OA0fEt8BvvtEiE1Z2PK0GG+sX3FL0BImXOjUZcrR6nfiNbO5Fqg=
  alipay-public-key: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuTYl9i2N+ZH3eaHlqfdckMi/tDDnv77ztcnquz0bv7mf8mme58CAkvzF9tzM4eesE2yaE9tpRUvQ2mnvheacTsg0HTGPFq16BTRSQKfOkPEwDz1ffqq285FzuYvKFzIey1sXDTlpgkhM9KYKfi6AcE0sfFw6sCTCI7rTn8eaFeHdxRPPSfXoS75ckhOhGqQGvKzziQecGtTPdZOvN8p47Y+mX6naNqggrq25o0fyU9VrLkQkvErKgLv8d6n0+2Yb/Aa9MwtXAY0e9NVJXPkYRkmUHVC8gB+lp+7u3eRRqUaABfo1JZwGtZKicPLgMBNaLrgcsAFLZlQKyyDVInSEywIDAQAB
  notify-url: https://ai-yishuguan.com/api/v1/payment/alipay/notify
  return-url: https://ai-yishuguan.com/order-success
  gateway-url: https://openapi-sandbox.dl.alipaydev.com/gateway.do  # 沙箱环境
  # gateway-url: https://openapi.alipay.com/gateway.do  # 生产环境（正式上线时使用）
  sign-type: RSA2
  charset: utf-8
```

## ⚠️ 重要提示

### 当前使用的是沙箱环境

配置文件中的 `gateway-url` 设置为：
```
https://openapi-sandbox.dl.alipaydev.com/gateway.do
```

这是**支付宝沙箱环境**，用于测试。正式上线时需要改为：
```
https://openapi.alipay.com/gateway.do
```

### 私钥格式要求

支付宝私钥必须是完整的 RSA 私钥，格式如下：
```
-----BEGIN RSA PRIVATE KEY-----
MIIEwAIBADANBgkqhkiG9w0BAQEFAASCBKowggSmAgEAAoIBAQCo4Nm2s5DrnO70...
-----END RSA PRIVATE KEY-----
```

或者去掉头尾的纯 Base64 格式（当前配置使用这种格式）。

## 🔍 验证修复

修复后，测试支付流程：

1. **创建订单**
2. **点击支付**
3. **应该跳转到支付宝支付页面**（而不是报错）

如果还有问题，检查：
- ✅ 后端启动日志中是否有配置加载成功的消息
- ✅ 私钥长度是否大于 0
- ✅ 浏览器控制台是否有其他错误

## 📝 后续优化建议

1. **使用环境变量管理敏感信息**（推荐）
2. **使用配置中心**（如 Nacos、Apollo）
3. **添加配置加密**（如使用 Jasypt）
4. **生产环境使用正式支付宝账号**（不要用沙箱）
