# 部署快速指令

## 一键部署脚本

### 1. 数据库迁移

```bash
# 执行数据库迁移（添加核销时间字段）
mysql -u root -p buyticket < ADD_VERIFY_TIME_COLUMN.sql
```

### 2. 后端重启

```bash
# 停止后端
pkill -f buyticket

# 重新编译并启动
cd /www/wwwroot/shared-backend
mvn clean package -DskipTests
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 查看启动日志
tail -f app.log
```

### 3. 前端重新构建

```bash
# B端
cd /www/wwwroot/frontend-b
npm run build

# C端
cd /www/wwwroot/frontend-c
npm run build
```

### 4. 重启Nginx

```bash
nginx -t && nginx -s reload
```

---

## 验证命令

### 检查后端是否启动

```bash
# 查看进程
ps aux | grep buyticket

# 查看端口
netstat -tlnp | grep 8089

# 查看日志
tail -f /www/wwwroot/shared-backend/app.log
```

### 测试新接口

```bash
# 测试今日核销数量接口
curl http://localhost:8089/api/v1/order/ticket/today-count

# 测试核销记录接口
curl "http://localhost:8089/api/v1/order/ticket/records?date=2026-01-30"
```

### 检查数据库字段

```bash
mysql -u root -p -e "USE buyticket; DESCRIBE ticket_order;"
```

---

## 回滚方案

### 如果需要回滚数据库

```sql
-- 删除核销时间字段
ALTER TABLE ticket_order DROP COLUMN verify_time;

-- 删除索引
DROP INDEX idx_verify_time ON ticket_order;
DROP INDEX idx_status_verify_time ON ticket_order;
```

### 如果需要回滚代码

```bash
# 后端回滚
cd /www/wwwroot/shared-backend
git checkout HEAD~1
mvn clean package -DskipTests
pkill -f buyticket
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 前端回滚
cd /www/wwwroot/frontend-b
git checkout HEAD~1
npm run build

cd /www/wwwroot/frontend-c
git checkout HEAD~1
npm run build
```

---

## 常见问题

### 1. 后端启动失败

**检查：**
```bash
# 查看错误日志
tail -100 /www/wwwroot/shared-backend/app.log

# 检查端口占用
netstat -tlnp | grep 8089
```

**解决：**
```bash
# 如果端口被占用，杀掉进程
kill -9 $(lsof -t -i:8089)

# 重新启动
cd /www/wwwroot/shared-backend
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &
```

### 2. 数据库字段不存在

**检查：**
```bash
mysql -u root -p -e "USE buyticket; SHOW COLUMNS FROM ticket_order LIKE 'verify_time';"
```

**解决：**
```bash
# 重新执行迁移脚本
mysql -u root -p buyticket < ADD_VERIFY_TIME_COLUMN.sql
```

### 3. 前端构建失败

**检查：**
```bash
# 查看Node版本
node -v

# 查看npm版本
npm -v
```

**解决：**
```bash
# 清理缓存
cd /www/wwwroot/frontend-b
rm -rf node_modules package-lock.json
npm install
npm run build

# 或使用淘宝镜像
npm install --registry=https://registry.npmmirror.com
npm run build
```

### 4. Nginx配置错误

**检查：**
```bash
nginx -t
```

**解决：**
```bash
# 查看错误日志
tail -100 /var/log/nginx/error.log

# 重新加载配置
nginx -s reload
```

---

## 监控命令

### 实时监控后端日志

```bash
tail -f /www/wwwroot/shared-backend/app.log | grep -E "ERROR|WARN|核销"
```

### 监控Nginx访问日志

```bash
tail -f /var/log/nginx/access.log | grep -E "/api/v1/order/ticket"
```

### 监控系统资源

```bash
# CPU和内存
top

# 磁盘空间
df -h

# 网络连接
netstat -an | grep 8089
```

---

## 性能测试

### 测试核销记录接口性能

```bash
# 使用ab工具测试
ab -n 100 -c 10 "http://localhost:8089/api/v1/order/ticket/records?date=2026-01-30"

# 使用curl测试响应时间
time curl "http://localhost:8089/api/v1/order/ticket/records?date=2026-01-30"
```

### 测试数据库查询性能

```sql
-- 查看执行计划
EXPLAIN SELECT * FROM ticket_order 
WHERE status = 2 
AND verify_time >= '2026-01-30 00:00:00' 
AND verify_time <= '2026-01-30 23:59:59'
ORDER BY verify_time DESC;

-- 查看索引使用情况
SHOW INDEX FROM ticket_order;
```

