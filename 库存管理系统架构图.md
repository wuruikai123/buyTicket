# 展览门票库存管理系统架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层 (Frontend)                      │
├─────────────────────────────────────────────────────────────┤
│  A端 (用户端)              │  B端 (管理端)                      │
│  - 查看展览                │  - 创建展览                        │
│  - 选择日期/时间段          │  - 管理库存                        │
│  - 查看剩余票数            │  - 查看订单                        │
│  - 购买门票                │  - 取消/作废订单                   │
│  - 取消订单                │                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP API
┌─────────────────────────────────────────────────────────────┐
│                      控制器层 (Controller)                     │
├─────────────────────────────────────────────────────────────┤
│  ExhibitionInventoryController  │  查询库存API                │
│  AdminExhibitionController      │  创建展览 → 初始化库存       │
│  OrderController                │  创建订单 → 扣减库存         │
│  AdminOrderController           │  取消/作废 → 恢复库存        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       服务层 (Service)                         │
├─────────────────────────────────────────────────────────────┤
│  ExhibitionTimeSlotInventoryService                          │
│  ├─ initializeInventory()      初始化库存                     │
│  ├─ decreaseInventory()        扣减库存（乐观锁）             │
│  ├─ increaseInventory()        恢复库存                       │
│  ├─ getAvailableInventory()    查询单个时间段                │
│  └─ getDateInventory()         查询某天所有时间段             │
│                                                               │
│  TicketOrderService                                          │
│  └─ createOrder()              创建订单 + 扣减库存            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层 (Mapper)                       │
├─────────────────────────────────────────────────────────────┤
│  ExhibitionTimeSlotInventoryMapper (MyBatis Plus)            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       数据库层 (Database)                      │
├─────────────────────────────────────────────────────────────┤
│  exhibition_time_slot_inventory                              │
│  ├─ id                                                       │
│  ├─ exhibition_id                                            │
│  ├─ ticket_date                                              │
│  ├─ time_slot                                                │
│  ├─ total_tickets                                            │
│  ├─ sold_tickets                                             │
│  ├─ available_tickets                                        │
│  └─ version (乐观锁)                                          │
└─────────────────────────────────────────────────────────────┘
```

## 核心流程图

### 1. 创建展览流程

```
┌──────────────┐
│ B端管理员     │
│ 创建展览      │
└──────┬───────┘
       │
       ↓
┌──────────────────────────────────────┐
│ AdminExhibitionController.create()   │
│ 1. 保存展览信息                       │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ inventoryService.initializeInventory()│
│ 2. 初始化库存                         │
│    - 遍历每一天                       │
│    - 为每个时间段创建库存记录          │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ exhibition_time_slot_inventory       │
│ 3. 保存库存记录                       │
│                                      │
│ 示例：                                │
│ 展览ID=1, 日期=2026-02-10            │
│ 时间段=09:00-12:00, 总票数=100       │
│ 已售=0, 可售=100, version=0          │
└──────────────────────────────────────┘
```

### 2. 购买门票流程

```
┌──────────────┐
│ A端用户       │
│ 购买门票      │
└──────┬───────┘
       │
       ↓
┌──────────────────────────────────────┐
│ OrderController.createTicketOrder()  │
│ 1. 接收订单请求                       │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ TicketOrderService.createOrder()     │
│ 2. 验证展览信息                       │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ inventoryService.decreaseInventory() │
│ 3. 扣减库存（乐观锁）                  │
│                                      │
│ UPDATE ... SET                       │
│   sold_tickets = sold_tickets + 2,   │
│   available_tickets = available - 2, │
│   version = version + 1              │
│ WHERE id = ? AND version = ?         │
└──────┬───────────────────────────────┘
       │
       ├─ 成功 ──→ 继续
       │
       └─ 失败 ──→ 抛出异常（库存不足或并发冲突）
       │
       ↓
┌──────────────────────────────────────┐
│ 4. 创建订单                           │
│ 5. 创建订单详情                       │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────┐
│ 订单创建成功  │
└──────────────┘
```

### 3. 取消订单流程

```
┌──────────────┐
│ 用户/管理员   │
│ 取消订单      │
└──────┬───────┘
       │
       ↓
┌──────────────────────────────────────┐
│ OrderController.cancelTicketOrder()  │
│ 1. 验证订单状态                       │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ restoreInventory()                   │
│ 2. 查询订单项                         │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ inventoryService.increaseInventory() │
│ 3. 恢复库存（乐观锁）                  │
│                                      │
│ UPDATE ... SET                       │
│   sold_tickets = sold_tickets - 2,   │
│   available_tickets = available + 2, │
│   version = version + 1              │
│ WHERE id = ? AND version = ?         │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────┐
│ 4. 更新订单状态为"已取消"              │
└──────┬───────────────────────────────┘
       │
       ↓
┌──────────────┐
│ 订单取消成功  │
└──────────────┘
```

## 并发控制示意图

### 乐观锁机制

```
时间线 ──────────────────────────────────────────→

用户A                    用户B
  │                       │
  │ 1. 查询库存            │
  │    剩余: 10张          │
  │    version: 5         │
  │                       │ 2. 查询库存
  │                       │    剩余: 10张
  │                       │    version: 5
  │                       │
  │ 3. 购买5张            │
  │    UPDATE ... WHERE   │
  │    version = 5        │
  │    ✅ 成功             │
  │    version → 6        │
  │                       │
  │                       │ 4. 购买8张
  │                       │    UPDATE ... WHERE
  │                       │    version = 5
  │                       │    ❌ 失败
  │                       │    (version已经是6)
  │                       │
  │                       │ 5. 提示重试
  │                       │    重新查询库存
  │                       │    剩余: 5张
  │                       │    version: 6
  │                       │
  │                       │ 6. 购买5张
  │                       │    ✅ 成功
```

## 数据流图

```
┌─────────────┐
│   展览信息   │
│  Exhibition │
└──────┬──────┘
       │
       │ 创建展览
       ↓
┌─────────────────────────────┐
│      库存记录                │
│ ExhibitionTimeSlotInventory │
│                             │
│ 展览ID: 1                   │
│ 日期: 2026-02-10            │
│ 时间段: 09:00-12:00         │
│ 总票数: 100                 │
│ 已售: 0 → 20 → 0            │
│ 可售: 100 → 80 → 100        │
│ 版本: 0 → 5 → 6             │
└──────┬──────────────────────┘
       │
       │ 购买门票 / 取消订单
       ↓
┌─────────────┐
│   订单信息   │
│ TicketOrder │
│             │
│ 订单ID: 1   │
│ 状态: 0→3   │
└──────┬──────┘
       │
       │ 订单详情
       ↓
┌─────────────┐
│  订单项      │
│ OrderItem   │
│             │
│ 展览ID: 1   │
│ 日期: 2-10  │
│ 时段: 上午  │
│ 数量: 2     │
└─────────────┘
```

## 状态转换图

### 订单状态与库存关系

```
┌──────────┐
│  待支付   │ status = 0
│  (创建)   │ ← 库存已扣减
└────┬─────┘
     │
     │ 支付
     ↓
┌──────────┐
│  待使用   │ status = 1
│  (已支付) │ ← 库存已扣减
└────┬─────┘
     │
     │ 核销
     ↓
┌──────────┐
│  已使用   │ status = 2
│  (已核销) │ ← 库存已扣减
└──────────┘

     │ 取消（从待支付）
     ↓
┌──────────┐
│  已取消   │ status = 3
│          │ ← 库存已恢复 ✅
└──────────┘

     │ 作废（从待使用/已使用）
     ↓
┌──────────┐
│  已作废   │ status = 4
│          │ ← 库存已恢复 ✅
└──────────┘
```

## API接口图

```
┌─────────────────────────────────────────────┐
│           库存查询API                        │
├─────────────────────────────────────────────┤
│                                             │
│  GET /api/v1/exhibition/inventory/          │
│      {exhibitionId}/date/{date}             │
│  ↓                                          │
│  返回某天所有时间段库存                      │
│  [                                          │
│    {                                        │
│      timeSlot: "09:00-12:00",              │
│      totalTickets: 100,                    │
│      soldTickets: 20,                      │
│      availableTickets: 80                  │
│    },                                       │
│    {                                        │
│      timeSlot: "14:00-17:00",              │
│      totalTickets: 150,                    │
│      soldTickets: 50,                      │
│      availableTickets: 100                 │
│    }                                        │
│  ]                                          │
│                                             │
└─────────────────────────────────────────────┘
```

## 总结

这个架构图展示了：
1. ✅ 清晰的分层架构
2. ✅ 完整的业务流程
3. ✅ 乐观锁并发控制
4. ✅ 库存与订单的关系
5. ✅ API接口设计

系统通过乐观锁保证并发安全，通过事务保证数据一致性，实现了可靠的库存管理。
