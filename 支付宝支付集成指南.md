# 支付宝支付集成指南

## 📋 已完成的工作

已经为你创建了完整的支付宝支付功能：

### 1. 配置类
- `AlipayConfig.java` - 支付宝配置（已填写你的沙箱信息）

### 2. Service 层
- `AlipayService.java` - 支付服务接口
- `AlipayServiceImpl.java` - 支付服务实现

### 3. Controller 层
- `PaymentController.java` - 支付控制器

---

## 🔧 配置说明

### 异步通知地址（notify_url）
**作用**：支付宝支付成功后，会主动调用这个地址通知你的服务器

**当前配置**：`http://localhost:8080/api/v1/payment/alipay/notify`

**生产环境修改**：
```java
// 在 AlipayConfig.java 中修改
public static String notify_url = "http://你的域名/api/v1/payment/alipay/notify";
```

**重要**：
- 必须是外网可以访问的地址
- 支付宝会POST请求这个地址
- 本地开发需要使用内网穿透工具（如 natapp、ngrok）

### 同步通知地址（return_url）
**作用**：用户支付完成后，浏览器会跳转到这个地址

**当前配置**：`http://localhost:3000/order/success`

**生产环境修改**：
```java
// 在 AlipayConfig.java 中修改
public static String return_url = "http://你的前端域名/order/success";
```

---

## 📦 添加依赖

在 `pom.xml` 中添加支付宝 SDK 依赖：

```xml
<!-- 支付宝SDK -->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.38.157.ALL</version>
</dependency>
```

---

## 🚀 API 接口说明

### 1. 创建支付订单（PC端）
```
POST /api/v1/payment/alipay/create
参数: orderNo=订单号
返回: 支付表单HTML（直接在页面中渲染即可跳转到支付宝）
```

### 2. 创建手机网站支付订单
```
POST /api/v1/payment/alipay/create-wap
参数: orderNo=订单号
返回: 支付表单HTML
```

### 3. 查询订单支付状态
```
GET /api/v1/payment/alipay/query?orderNo=订单号
返回: 订单支付状态信息
```

### 4. 申请退款
```
POST /api/v1/payment/alipay/refund
参数: 
  - orderNo: 订单号
  - refundReason: 退款原因（可选）
返回: 退款结果
```

### 5. 支付宝异步通知（支付宝调用）
```
POST /api/v1/payment/alipay/notify
说明: 支付宝支付成功后会自动调用此接口
```

### 6. 支付宝同步通知（页面跳转）
```
GET /api/v1/payment/alipay/return
说明: 用户支付完成后浏览器会跳转到此接口
```

---

## 💻 前端集成示例

### 发起支付
```javascript
// 创建支付订单
const response = await request.post('/api/v1/payment/alipay/create', {
  orderNo: 'T20250101000001'
});

if (response.code === 0) {
  // 在页面中渲染支付表单HTML
  const div = document.createElement('div');
  div.innerHTML = response.data;
  document.body.appendChild(div);
  
  // 自动提交表单跳转到支付宝
  document.forms[0].submit();
}
```

### 支付成功页面
创建 `frontend-a/src/views/OrderSuccess.vue`：
```vue
<template>
  <div class="order-success">
    <h2>支付成功</h2>
    <p>订单号: {{ orderNo }}</p>
    <p>支付宝交易号: {{ tradeNo }}</p>
    <p>支付金额: ¥{{ totalAmount }}</p>
    <button @click="goToOrders">查看我的订单</button>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';

const route = useRoute();
const router = useRouter();

const orderNo = ref('');
const tradeNo = ref('');
const totalAmount = ref('');

onMounted(() => {
  // 从URL参数中获取支付宝返回的信息
  orderNo.value = route.query.out_trade_no;
  tradeNo.value = route.query.trade_no;
  totalAmount.value = route.query.total_amount;
});

const goToOrders = () => {
  router.push('/profile');
};
</script>
```

---

## 🧪 测试流程

### 1. 本地测试（使用内网穿透）

**安装 natapp**：
1. 访问 https://natapp.cn/
2. 注册账号并购买免费隧道
3. 下载客户端
4. 配置隧道指向 `localhost:8080`

**启动内网穿透**：
```bash
natapp -authtoken=你的token
```

**修改配置**：
```java
// 将 notify_url 改为 natapp 提供的地址
public static String notify_url = "http://xxx.natappfree.cc/api/v1/payment/alipay/notify";
```

### 2. 沙箱测试账号

支付宝沙箱提供了测试买家账号：
- 登录 https://open.alipay.com/
- 进入"开发者中心" -> "研发服务" -> "沙箱"
- 查看"沙箱账号"，获取买家账号和密码

### 3. 测试步骤

1. 创建订单
2. 调用支付接口
3. 跳转到支付宝沙箱支付页面
4. 使用沙箱买家账号登录并支付
5. 支付成功后：
   - 浏览器跳转到 return_url
   - 支付宝异步通知 notify_url
   - 订单状态更新为 "paid"

---

## 🔍 支付流程说明

```
用户下单
  ↓
调用 /api/v1/payment/alipay/create
  ↓
返回支付表单HTML
  ↓
前端渲染表单并自动提交
  ↓
跳转到支付宝支付页面
  ↓
用户完成支付
  ↓
支付宝异步通知 notify_url（更新订单状态）
  ↓
浏览器跳转到 return_url（显示支付成功页面）
```

---

## ⚠️ 注意事项

### 1. 异步通知处理
- 异步通知可能会多次发送，需要做幂等性处理（已实现）
- 必须验证签名（已实现）
- 必须验证订单金额（已实现）
- 返回 "success" 表示处理成功，支付宝不再重复通知
- 返回 "failure" 表示处理失败，支付宝会继续通知

### 2. 订单状态
- `pending` - 待支付
- `paid` - 已支付
- `used` - 已使用
- `refunded` - 已退款
- `cancelled` - 已取消

### 3. 支付宝交易状态
- `WAIT_BUYER_PAY` - 交易创建，等待买家付款
- `TRADE_CLOSED` - 未付款交易超时关闭，或支付完成后全额退款
- `TRADE_SUCCESS` - 交易支付成功
- `TRADE_FINISHED` - 交易结束，不可退款

### 4. 生产环境配置
- 将沙箱网关改为正式网关：`https://openapi.alipay.com/gateway.do`
- 使用正式的 APPID 和密钥
- 配置正确的 notify_url 和 return_url
- 确保服务器可以被支付宝访问

---

## 🐛 常见问题

### 1. 异步通知收不到
- 检查 notify_url 是否可以外网访问
- 查看支付宝开放平台的"消息通知"日志
- 确认服务器防火墙没有拦截支付宝IP

### 2. 签名验证失败
- 检查支付宝公钥是否正确
- 确认字符编码为 UTF-8
- 确认签名方式为 RSA2

### 3. 订单金额不匹配
- 检查订单金额格式（保留两位小数）
- 确认前后端金额计算一致

---

## 📚 参考文档

- 支付宝开放平台：https://open.alipay.com/
- 电脑网站支付文档：https://opendocs.alipay.com/open/270
- 手机网站支付文档：https://opendocs.alipay.com/open/203
- SDK 文档：https://opendocs.alipay.com/open/54/00y8k9

---

## ✅ 下一步

1. 在 `pom.xml` 中添加支付宝 SDK 依赖
2. 重启后端服务
3. 配置内网穿透（本地测试）
4. 创建前端支付页面
5. 测试完整支付流程
