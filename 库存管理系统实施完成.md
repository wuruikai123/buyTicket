# 展览门票库存管理系统实施完成

## 实施概述

已完成展览门票库存管理系统的后端实现，采用**独立库存表 + 乐观锁**方案，实现了精细化的时间段库存管理。

## 已完成的工作

### 1. 数据库表创建

**文件**: `CREATE_TIME_SLOT_INVENTORY_TABLE.sql`

创建了 `exhibition_time_slot_inventory` 表，包含以下字段：
- `exhibition_id`: 展览ID
- `ticket_date`: 门票日期
- `time_slot`: 时间段（如：09:00-12:00）
- `total_tickets`: 总票数
- `sold_tickets`: 已售票数
- `available_tickets`: 可售票数
- `version`: 乐观锁版本号

**唯一索引**: `(exhibition_id, ticket_date, time_slot)` 防止重复记录

### 2. 实体类和Mapper

**文件**:
- `ExhibitionTimeSlotInventory.java` - 库存实体类
- `ExhibitionTimeSlotInventoryMapper.java` - MyBatis Mapper

### 3. 库存服务实现

**文件**: 
- `ExhibitionTimeSlotInventoryService.java` - 服务接口
- `ExhibitionTimeSlotInventoryServiceImpl.java` - 服务实现

**核心功能**:

#### 3.1 初始化库存
```java
initializeInventory(exhibitionId, startDate, endDate, morningTickets, afternoonTickets)
```
- 创建展览时自动生成每天每个时间段的库存记录
- 支持上午场（09:00-12:00）和下午场（14:00-17:00）

#### 3.2 扣减库存（乐观锁）
```java
decreaseInventory(exhibitionId, ticketDate, timeSlot, quantity)
```
- 使用乐观锁（version字段）防止并发超卖
- 先检查库存是否足够
- 更新时验证version，失败则抛出异常

#### 3.3 恢复库存
```java
increaseInventory(exhibitionId, ticketDate, timeSlot, quantity)
```
- 订单取消或作废时恢复库存
- 同样使用乐观锁保证数据一致性

#### 3.4 查询库存
```java
getAvailableInventory(exhibitionId, ticketDate, timeSlot)  // 查询单个时间段
getDateInventory(exhibitionId, ticketDate)                 // 查询某天所有时间段
```

### 4. 展览创建时初始化库存

**修改文件**: `AdminExhibitionController.java`

在创建展览时自动初始化库存：
```java
@PostMapping("/create")
public JsonData create(@RequestBody Exhibition exhibition) {
    exhibitionService.save(exhibition);
    
    // 初始化库存
    inventoryService.initializeInventory(
        exhibition.getId(),
        exhibition.getStartDate(),
        exhibition.getEndDate(),
        exhibition.getMorningTickets(),
        exhibition.getAfternoonTickets()
    );
    
    return JsonData.buildSuccess("创建成功");
}
```

### 5. 订单创建时扣减库存

**修改文件**: `TicketOrderServiceImpl.java`

订单创建流程：
1. 验证展览是否存在
2. **扣减库存**（使用乐观锁）
3. 创建订单
4. 创建订单详情

```java
// 扣减库存
for (TicketItemRequest item : request.getItems()) {
    inventoryService.decreaseInventory(
        exhibitionId,
        item.getDate(),
        item.getTimeSlot(),
        item.getQuantity()
    );
}
```

### 6. 订单取消/作废时恢复库存

**修改文件**: 
- `AdminOrderController.java` - B端管理员操作
- `OrderController.java` - A端用户操作

#### 6.1 取消订单（待支付 -> 已取消）
```java
@PostMapping("/ticket/{id}/cancel")
public JsonData cancelTicketOrder(@PathVariable Long id) {
    // 恢复库存
    restoreInventory(id);
    
    // 更新订单状态
    order.setStatus(3);
    ticketOrderService.updateById(order);
}
```

#### 6.2 作废订单（待使用/已使用 -> 已作废）
```java
@PostMapping("/ticket/{id}/void")
public JsonData voidTicketOrder(@PathVariable Long id) {
    // 恢复库存
    restoreInventory(id);
    
    // 更新订单状态
    order.setStatus(4);
    ticketOrderService.updateById(order);
}
```

#### 6.3 恢复库存方法
```java
private void restoreInventory(Long orderId) {
    // 查询订单项
    List<OrderItem> orderItems = orderItemService.list(query);
    
    // 恢复每个订单项的库存
    for (OrderItem item : orderItems) {
        inventoryService.increaseInventory(
            item.getExhibitionId(),
            item.getTicketDate(),
            item.getTimeSlot(),
            item.getQuantity()
        );
    }
}
```

### 7. 库存查询API

**新增文件**: `ExhibitionInventoryController.java`

提供前端查询库存的接口：

#### 7.1 查询某天所有时间段库存
```
GET /api/v1/exhibition/inventory/{exhibitionId}/date/{date}
```

返回示例：
```json
[
  {
    "id": 1,
    "exhibitionId": 1,
    "ticketDate": "2026-02-01",
    "timeSlot": "09:00-12:00",
    "totalTickets": 100,
    "soldTickets": 20,
    "availableTickets": 80,
    "version": 5
  },
  {
    "id": 2,
    "exhibitionId": 1,
    "ticketDate": "2026-02-01",
    "timeSlot": "14:00-17:00",
    "totalTickets": 150,
    "soldTickets": 50,
    "availableTickets": 100,
    "version": 8
  }
]
```

#### 7.2 查询指定时间段库存
```
GET /api/v1/exhibition/inventory/{exhibitionId}/date/{date}/slot/{timeSlot}
```

## 核心特性

### 1. 乐观锁防止超卖

使用 `version` 字段实现乐观锁：
```sql
UPDATE exhibition_time_slot_inventory 
SET sold_tickets = ?, 
    available_tickets = ?, 
    version = version + 1 
WHERE id = ? AND version = ?
```

如果 `version` 不匹配（被其他事务修改），更新失败，抛出异常。

### 2. 事务保证数据一致性

所有涉及库存操作的方法都使用 `@Transactional`：
- 创建订单：扣减库存失败则回滚订单创建
- 取消订单：恢复库存和更新订单状态在同一事务中

### 3. 精细化库存管理

- 每个展览的每一天的每个时间段都有独立的库存记录
- 支持实时查询剩余票数
- 支持动态调整库存

## 数据库操作步骤

### 1. 执行SQL创建表
```bash
# 在MySQL中执行
mysql -u root -p buyticket < CREATE_TIME_SLOT_INVENTORY_TABLE.sql
```

或者手动执行：
```sql
CREATE TABLE exhibition_time_slot_inventory (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exhibition_id BIGINT NOT NULL COMMENT '展览ID',
    ticket_date DATE NOT NULL COMMENT '门票日期',
    time_slot VARCHAR(50) NOT NULL COMMENT '时间段',
    total_tickets INT NOT NULL DEFAULT 0 COMMENT '总票数',
    sold_tickets INT NOT NULL DEFAULT 0 COMMENT '已售票数',
    available_tickets INT NOT NULL DEFAULT 0 COMMENT '可售票数',
    version INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_exhibition_date_slot (exhibition_id, ticket_date, time_slot),
    INDEX idx_exhibition_id (exhibition_id),
    INDEX idx_ticket_date (ticket_date)
) COMMENT='展览时间段库存表';
```

### 2. 重启后端服务
```bash
# 停止后端
# 重新启动后端
```

### 3. 测试流程

#### 3.1 创建新展览
- 在B端创建展览，设置开始日期、结束日期、上午票数、下午票数
- 系统自动初始化库存

#### 3.2 查询库存
```bash
# 查询2026-02-01的库存
curl http://localhost:8080/api/v1/exhibition/inventory/1/date/2026-02-01
```

#### 3.3 创建订单
- A端用户选择日期和时间段购买门票
- 系统自动扣减库存

#### 3.4 取消订单
- 用户取消待支付订单
- 系统自动恢复库存

## 订单状态与库存的关系

| 订单状态 | 状态码 | 库存操作 | 说明 |
|---------|-------|---------|------|
| 待支付 | 0 | 扣减库存 | 创建订单时立即扣减 |
| 待使用 | 1 | 无操作 | 支付完成，库存已扣减 |
| 已使用 | 2 | 无操作 | 核销完成，库存已扣减 |
| 已取消 | 3 | 恢复库存 | 取消订单时恢复 |
| 已作废 | 4 | 恢复库存 | 作废订单时恢复 |

## 并发场景处理

### 场景1：两个用户同时购买最后1张票

```
用户A查询库存：剩余1张，version=10
用户B查询库存：剩余1张，version=10

用户A购买1张：
  UPDATE ... SET sold=100, available=0, version=11 WHERE id=1 AND version=10
  ✅ 成功

用户B购买1张：
  UPDATE ... SET sold=101, available=-1, version=11 WHERE id=1 AND version=10
  ❌ 失败（version已经是11了）
  → 提示"库存更新失败，请重试"
```

### 场景2：用户购买时库存不足

```
剩余库存：5张
用户购买：10张

检查库存：5 < 10
抛出异常："库存不足，剩余5张"
订单创建失败，事务回滚
```

## 后续优化建议

### 1. 定时任务处理超时订单

创建定时任务，每5分钟检查一次：
```java
@Scheduled(cron = "0 */5 * * * ?")
public void cancelExpiredOrders() {
    // 查询30分钟前创建的待支付订单
    // 自动取消并恢复库存
}
```

### 2. 缓存热门展览库存

使用Redis缓存库存信息，减少数据库查询：
```java
@Cacheable(value = "inventory", key = "#exhibitionId + ':' + #date")
public List<ExhibitionTimeSlotInventory> getDateInventory(...)
```

### 3. 库存预警

当库存低于阈值时发送通知：
```java
if (availableTickets < totalTickets * 0.1) {
    // 发送库存预警
}
```

## 前端集成指南

### 1. 查询可用库存

```javascript
// 查询某天的所有时间段库存
const response = await axios.get(
  `/api/v1/exhibition/inventory/${exhibitionId}/date/${date}`
)

// 显示剩余票数
timeSlots.value = response.data.data.map(slot => ({
  timeSlot: slot.timeSlot,
  availableTickets: slot.availableTickets,
  totalTickets: slot.totalTickets
}))
```

### 2. 创建订单

```javascript
// 创建订单（后端会自动扣减库存）
const response = await axios.post('/api/v1/order/ticket/create', {
  exhibitionId: 1,
  items: [
    {
      date: '2026-02-01',
      timeSlot: '09:00-12:00',
      quantity: 2,
      unitPrice: 50.00
    }
  ],
  totalAmount: 100.00,
  contactName: '张三',
  contactPhone: '13800138000'
})
```

### 3. 实时显示库存

```vue
<div v-for="slot in timeSlots" :key="slot.timeSlot">
  <div>{{ slot.timeSlot }}</div>
  <div>剩余：{{ slot.availableTickets }}/{{ slot.totalTickets }}</div>
  <el-button 
    :disabled="slot.availableTickets === 0"
    @click="selectSlot(slot)"
  >
    {{ slot.availableTickets > 0 ? '购买' : '已售罄' }}
  </el-button>
</div>
```

## 测试检查清单

- [ ] 执行SQL创建 `exhibition_time_slot_inventory` 表
- [ ] 重启后端服务
- [ ] 创建新展览，检查是否自动生成库存记录
- [ ] 查询库存API是否正常返回数据
- [ ] 创建订单，检查库存是否正确扣减
- [ ] 取消订单，检查库存是否正确恢复
- [ ] 作废订单，检查库存是否正确恢复
- [ ] 并发测试：多个用户同时购买同一时间段门票
- [ ] 库存不足测试：购买数量超过剩余库存

## 总结

✅ 已完成展览门票库存管理系统的完整后端实现
✅ 使用乐观锁防止超卖
✅ 支持精细化的时间段库存管理
✅ 订单取消/作废自动恢复库存
✅ 提供完整的库存查询API

下一步需要：
1. 执行SQL创建数据库表
2. 重启后端服务
3. 前端集成库存查询和显示功能
4. 测试完整的购票流程
