# 支付宝沙箱测试完整指南

## 一、沙箱账号获取

1. 登录支付宝开放平台：https://open.alipay.com/
2. 进入"开发者中心" -> "研发服务" -> "沙箱环境"
3. 查看沙箱账号信息

### 沙箱买家账号
- 账号：在沙箱页面查看（通常是手机号格式）
- 登录密码：111111
- 支付密码：111111
- 可用余额：充足（沙箱环境虚拟金额）

### 沙箱卖家账号
- 账号：在沙箱页面查看
- 登录密码：111111

## 二、解决资源加载失败问题

### 问题原因
支付宝沙箱的静态资源（CSS/JS）从 `https://gw.alipayobjects.com` 加载，可能因为网络问题导致加载失败。

### 解决方案

#### 方案1：使用新沙箱网关（推荐）
已在 `AlipayConfig.java` 中配置：
```java
public static String gatewayUrl = "https://openapi-sandbox.dl.alipaydev.com/gateway.do";
```

#### 方案2：修改 hosts 文件
如果资源仍然加载失败，可以尝试修改 hosts 文件：

**Windows**: `C:\Windows\System32\drivers\etc\hosts`
**Mac/Linux**: `/etc/hosts`

添加以下内容：
```
# 支付宝沙箱资源
47.246.7.158 gw.alipayobjects.com
47.246.7.158 t.alipayobjects.com
```

#### 方案3：使用代理
如果上述方法都不行，可以使用代理访问支付宝资源。

## 三、支付宝沙箱登录问题

### 常见问题

#### 1. 二维码失效
**原因**：沙箱环境的二维码有时效性，或者网络问题导致无法加载

**解决方法**：
- 刷新页面重新生成二维码
- 使用账号密码登录（推荐）

#### 2. 账号密码登录失败
**原因**：
- 密码输入错误（沙箱密码统一为 111111）
- 沙箱账号未激活
- 网络问题

**解决方法**：
1. 确认使用正确的沙箱买家账号
2. 密码输入：111111
3. 如果提示账号不存在，去支付宝开放平台重新生成沙箱账号

#### 3. 支付宝APP扫码失败
**原因**：沙箱环境不支持真实的支付宝APP扫码

**解决方法**：
- 必须使用沙箱版支付宝APP（需要单独下载）
- 或者使用账号密码登录（推荐）

## 四、完整测试流程

### 1. 配置检查

确认 `AlipayConfig.java` 配置正确：
```java
// AppID（从沙箱页面获取）
public static String app_id = "你的沙箱AppID";

// 商户私钥（从沙箱页面获取）
public static String merchant_private_key = "你的私钥";

// 支付宝公钥（从沙箱页面获取）
public static String alipay_public_key = "支付宝公钥";

// 沙箱网关
public static String gatewayUrl = "https://openapi-sandbox.dl.alipaydev.com/gateway.do";

// 异步通知地址（需要公网地址，使用natapp）
public static String notify_url = "http://你的natapp域名/api/v1/payment/alipay/notify";

// 同步返回地址
public static String return_url = "http://localhost:3000/order-success";
```

### 2. 启动内网穿透

```bash
# 启动 natapp
natapp -authtoken=你的token

# 记录生成的公网地址，更新到 AlipayConfig.java 的 notify_url
```

### 3. 启动服务

```bash
# 启动后端
cd shared-backend
mvn spring-boot:run

# 启动前端
cd frontend-a
npm run dev
```

### 4. 测试支付流程

1. 登录系统（用户端）
2. 选择展览购票
3. 填写订单信息，点击"支付"
4. 跳转到支付页面，选择"支付宝支付"
5. 点击"立即支付"
6. 跳转到支付宝沙箱支付页面

### 5. 支付宝沙箱支付

#### 使用账号密码登录（推荐）
1. 点击"账号密码登录"
2. 输入沙箱买家账号
3. 输入密码：111111
4. 点击"登录"
5. 输入支付密码：111111
6. 点击"确认支付"

#### 使用扫码登录
1. 下载沙箱版支付宝APP
2. 使用沙箱账号登录APP
3. 扫描页面二维码
4. 在APP中确认支付

### 6. 支付完成

- 支付成功后，页面会自动跳转到 `http://localhost:3000/order-success`
- 后端会收到支付宝的异步通知，自动更新订单状态
- 订单状态从"待支付"变为"待使用"

## 五、常见错误及解决

### 1. 资源加载失败（ERR_BLOCKED_BY_CLIENT）

**错误信息**：
```
Failed to load resource: net::ERR_BLOCKED_BY_CLIENT
```

**原因**：浏览器插件（如广告拦截器）阻止了支付宝资源加载

**解决方法**：
- 禁用广告拦截插件
- 将支付宝域名加入白名单
- 使用无痕模式测试

### 2. 签名验证失败

**错误信息**：
```
签名验证失败
```

**原因**：
- 私钥配置错误
- 公钥配置错误
- 签名方式不匹配

**解决方法**：
1. 重新从沙箱页面复制密钥
2. 确认使用 RSA2 签名方式
3. 检查密钥格式（PKCS8）

### 3. 异步通知未收到

**原因**：
- notify_url 配置错误
- 内网穿透未启动
- 后端服务未启动

**解决方法**：
1. 确认 natapp 正在运行
2. 测试 notify_url 是否可以公网访问
3. 查看后端日志

### 4. 订单状态未更新

**原因**：
- 异步通知处理失败
- 订单号不匹配
- 金额不匹配

**解决方法**：
1. 查看后端日志中的异步通知信息
2. 确认订单号和金额是否正确
3. 手动调用模拟支付通知接口：
   ```bash
   curl -X POST "http://localhost:8082/api/v1/payment/mock-notify?orderNo=订单号"
   ```

## 六、调试技巧

### 1. 查看后端日志

后端会输出详细的支付宝交互日志：
```
初始化支付宝客户端，使用配置：
  AppID: 9021000158671506
  网关: https://openapi-sandbox.dl.alipaydev.com/gateway.do
  ...
创建支付宝PC支付订单: orderNo=T17669959851293SBO3S
支付宝支付订单创建成功: orderNo=T17669959851293SBO3S
收到支付宝异步通知
订单支付成功，状态已更新: orderNo=T17669959851293SBO3S
```

### 2. 使用支付宝开放平台工具

- 网关检测工具：检测网关是否可访问
- 签名验证工具：验证签名是否正确
- 异步通知模拟：模拟支付宝发送异步通知

### 3. 使用 Postman 测试

测试创建支付订单接口：
```
POST http://localhost:8082/api/v1/payment/alipay/create?orderNo=T17669959851293SBO3S
```

## 七、生产环境配置

生产环境需要：
1. 申请正式的支付宝应用
2. 配置正式的 AppID 和密钥
3. 修改网关地址为正式环境：
   ```java
   public static String gatewayUrl = "https://openapi.alipay.com/gateway.do";
   ```
4. 配置正式的异步通知地址（必须是HTTPS）
5. 配置正式的同步返回地址

## 八、测试账号信息

### 沙箱买家账号示例
- 账号：jzxfqq5417@sandbox.com
- 登录密码：111111
- 支付密码：111111
- 用户名：沙箱环境
- 证件类型：身份证
- 证件号码：123456789012345678

**注意**：实际账号请从支付宝开放平台沙箱页面获取！

## 九、快速测试命令

```bash
# 1. 启动natapp
natapp -authtoken=你的token

# 2. 启动后端（新终端）
cd shared-backend
mvn spring-boot:run

# 3. 启动前端（新终端）
cd frontend-a
npm run dev

# 4. 访问系统
# 浏览器打开：http://localhost:3000

# 5. 测试支付
# 登录 -> 选择展览 -> 购票 -> 支付 -> 使用沙箱账号登录支付宝
```

## 十、故障排查清单

- [ ] AlipayConfig 配置是否正确
- [ ] natapp 是否正在运行
- [ ] 后端服务是否启动
- [ ] 前端服务是否启动
- [ ] 沙箱账号密码是否正确（111111）
- [ ] 浏览器是否禁用了广告拦截
- [ ] 网络是否正常
- [ ] 订单是否创建成功
- [ ] 订单状态是否为"待支付"
