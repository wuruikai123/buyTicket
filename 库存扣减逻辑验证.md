# 库存扣减逻辑验证

## 问题
支付成功后，门票是否会自动减少？

## 答案
**是的，会自动减少。** 因为系统使用实时计算方式，不需要手动扣减库存。

## 当前库存逻辑

### 核心原理
剩余票数 = 总票数 - 已售票数

其中：
- **总票数**：从 `Exhibition` 表的 `morningTickets` 或 `afternoonTickets` 字段获取（固定值）
- **已售票数**：实时统计 `OrderItem` 表中，订单状态为 1（待使用）或 2（已使用）的票数总和

### 订单状态说明
- **0 - 待支付**：订单已创建但未支付，**不占用库存**
- **1 - 待使用**：订单已支付但未核销，**占用库存**
- **2 - 已使用**：订单已核销，**占用库存**
- **3 - 已取消**：订单已取消，**不占用库存**
- **4 - 已作废**：订单已作废，**不占用库存**

## 完整流程演示

### 场景设置
- 展览：故宫博物院
- 日期：2026-02-01
- 时间段：09:00-12:00
- 总票数：100张

### 步骤1：初始状态
```
查询剩余票数：
- 总票数：100
- 已售票数：0（没有状态为1或2的订单）
- 剩余票数：100
```

### 步骤2：用户A创建订单（购买5张）
```sql
-- 创建订单
INSERT INTO ticket_order (user_id, total_amount, status, ...) 
VALUES (1, 600, 0, ...);  -- status=0 待支付

-- 创建订单项
INSERT INTO order_item (order_id, exhibition_id, ticket_date, time_slot, quantity, ...) 
VALUES (1, 1, '2026-02-01', '09:00-12:00', 5, ...);
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：0（订单状态为0，不统计）
- 剩余票数：100 ← 仍然是100，因为还没支付
```

### 步骤3：用户A支付成功
```sql
-- 更新订单状态
UPDATE ticket_order 
SET status = 1, pay_time = NOW() 
WHERE id = 1;
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：5（订单状态为1，开始统计）
  SELECT SUM(quantity) FROM order_item oi
  JOIN ticket_order t ON oi.order_id = t.id
  WHERE oi.exhibition_id = 1
    AND oi.ticket_date = '2026-02-01'
    AND oi.time_slot = '09:00-12:00'
    AND t.status IN (1, 2)
  -- 结果：5
- 剩余票数：95 ← 自动减少了5张
```

### 步骤4：用户B创建订单（购买3张）
```sql
INSERT INTO ticket_order (user_id, total_amount, status, ...) 
VALUES (2, 360, 0, ...);

INSERT INTO order_item (order_id, exhibition_id, ticket_date, time_slot, quantity, ...) 
VALUES (2, 1, '2026-02-01', '09:00-12:00', 3, ...);
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：5（只统计用户A的订单，用户B还没支付）
- 剩余票数：95
```

### 步骤5：用户B支付成功
```sql
UPDATE ticket_order 
SET status = 1, pay_time = NOW() 
WHERE id = 2;
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：8（用户A的5张 + 用户B的3张）
- 剩余票数：92 ← 自动减少了3张
```

### 步骤6：用户A核销订单
```sql
UPDATE ticket_order 
SET status = 2, verify_time = NOW() 
WHERE id = 1;
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：8（状态1和2都统计）
- 剩余票数：92 ← 不变，因为已使用的订单仍然占用库存
```

### 步骤7：用户C创建订单但取消（购买2张）
```sql
-- 创建订单
INSERT INTO ticket_order (user_id, total_amount, status, ...) 
VALUES (3, 240, 0, ...);

INSERT INTO order_item (order_id, exhibition_id, ticket_date, time_slot, quantity, ...) 
VALUES (3, 1, '2026-02-01', '09:00-12:00', 2, ...);

-- 取消订单
UPDATE ticket_order 
SET status = 3 
WHERE id = 3;
```

**此时查询剩余票数**：
```
- 总票数：100
- 已售票数：8（不统计状态为3的订单）
- 剩余票数：92 ← 不变，取消的订单不占用库存
```

## 代码验证

### 查询剩余票数的代码
```java
// TicketInventoryController.getAvailability()

// 1. 获取总票数
int totalTickets = exhibition.getMorningTickets(); // 100

// 2. 查询订单项
List<OrderItem> orderItems = orderItemService.list(itemWrapper);
// 结果：[{orderId:1, quantity:5}, {orderId:2, quantity:3}, {orderId:3, quantity:2}]

// 3. 过滤已支付订单
List<TicketOrder> paidOrders = ticketOrderService.list(orderWrapper);
// WHERE status IN (1, 2)
// 结果：[{id:1, status:1}, {id:2, status:1}]

// 4. 统计已售票数
int soldTickets = orderItems.stream()
    .filter(item -> paidOrderIds.contains(item.getOrderId()))
    .mapToInt(OrderItem::getQuantity)
    .sum();
// 结果：5 + 3 = 8

// 5. 计算剩余票数
int remainingTickets = totalTickets - soldTickets;
// 结果：100 - 8 = 92
```

## 关键点总结

### ✅ 正确的地方
1. **创建订单时不扣减库存**：因为用户可能不支付
2. **支付成功后自动减少**：通过实时统计实现
3. **核销后库存不变**：已使用的订单仍然占用库存
4. **取消订单不占库存**：状态为3的订单不统计

### ✅ 优势
1. **无需手动扣减**：支付成功后，订单状态变为1，自动被统计
2. **数据一致性**：库存数据始终准确，不会出现不同步
3. **逻辑简单**：只需要更新订单状态，不需要额外的库存操作

### ⚠️ 注意事项
1. **待支付订单不占库存**：用户创建订单后，其他用户仍然可以购买相同的票
2. **可能出现超卖**：如果多个用户同时支付，在高并发情况下可能超卖
3. **需要并发控制**：如果业务量大，建议添加分布式锁或数据库行锁

## 测试验证步骤

### 1. 准备测试数据
```sql
-- 创建展览，设置100张票
INSERT INTO exhibition (name, morning_tickets, afternoon_tickets, ...) 
VALUES ('测试展览', 100, 100, ...);
```

### 2. 测试创建订单
- 访问A端购票页面
- 选择展览、日期、时间段
- 查看剩余票数：应该是100
- 创建订单（5张票）
- 再次查看剩余票数：应该仍然是100（因为还没支付）

### 3. 测试支付订单
- 支付刚才创建的订单
- 再次查看剩余票数：应该变成95

### 4. 测试多个订单
- 创建第二个订单（3张票）并支付
- 查看剩余票数：应该变成92

### 5. 测试取消订单
- 创建第三个订单（2张票）但不支付
- 取消订单
- 查看剩余票数：应该仍然是92

## 结论
**当前的库存逻辑是正确的！** 

支付成功后，订单状态从0变为1，会自动被统计到已售票数中，剩余票数会自动减少。不需要手动扣减库存，系统通过实时计算自动处理。

## 相关文档
- [库存管理重构完成总结.md](./库存管理重构完成总结.md)
- [A端剩余票数显示修复说明.md](./A端剩余票数显示修复说明.md)
