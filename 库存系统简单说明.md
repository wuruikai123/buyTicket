# 库存系统简单说明

## 问题：现在的展览不管有没有超过截止日期，都有票

### 原因分析

**旧系统的问题**：
```
exhibition表：
- morning_tickets: 100  （这100张是整个展览期间的总数？还是每天的数量？）
- afternoon_tickets: 150

当用户购买时：
- 2月1号上午买了50张
- 2月5号上午买了30张
- 2月10号上午买了20张

问题：每天上午到底还剩多少票？无法精确知道！
```

### 新系统的解决方案

**使用库存表精确管理每一天**：

```
exhibition_time_slot_inventory表：

展览ID=1，梵高画展（2026-02-01 到 2026-02-10）

| ID | 展览ID | 日期       | 时间段      | 总票数 | 已售 | 可售 |
|----|-------|-----------|------------|-------|------|------|
| 1  | 1     | 2026-02-01| 09:00-12:00| 100   | 50   | 50   |
| 2  | 1     | 2026-02-01| 14:00-17:00| 150   | 0    | 150  |
| 3  | 1     | 2026-02-02| 09:00-12:00| 100   | 0    | 100  |
| 4  | 1     | 2026-02-02| 14:00-17:00| 150   | 0    | 150  |
| 5  | 1     | 2026-02-03| 09:00-12:00| 100   | 0    | 100  |
| 6  | 1     | 2026-02-03| 14:00-17:00| 150   | 0    | 150  |
...
| 19 | 1     | 2026-02-10| 09:00-12:00| 100   | 0    | 100  |
| 20 | 1     | 2026-02-10| 14:00-17:00| 150   | 0    | 150  |

现在：
- 2月1号上午买了50张 → 只影响ID=1这条记录
- 2月5号上午还有100张可以卖
- 2月10号上午还有100张可以卖
- 每天的库存是独立的！
```

## 如何使用

### 1. 创建展览（B端管理员）

```
展览名称：梵高画展
开始日期：2026-02-01
结束日期：2026-02-10
上午票数：100  ← 表示每天上午有100张票
下午票数：150  ← 表示每天下午有150张票
```

保存后，系统自动生成20条库存记录（10天 × 2个时间段）

### 2. 用户购票（A端）

```
用户选择：
- 展览：梵高画展
- 日期：2026-02-05
- 时间段：上午场（09:00-12:00）
- 数量：5张

系统操作：
1. 查询库存：2026-02-05上午还有100张
2. 扣减库存：已售=5，可售=95
3. 创建订单
```

### 3. 查看剩余票数

```
前端显示：
2026-02-05
  上午场（09:00-12:00）剩余：95/100张 [购买]
  下午场（14:00-17:00）剩余：150/150张 [购买]

2026-02-06
  上午场（09:00-12:00）剩余：100/100张 [购买]
  下午场（14:00-17:00）剩余：150/150张 [购买]
```

## 立即执行的步骤

### 第1步：创建表（复制粘贴到MySQL）

```sql
CREATE TABLE exhibition_time_slot_inventory (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exhibition_id BIGINT NOT NULL COMMENT '展览ID',
    ticket_date DATE NOT NULL COMMENT '门票日期',
    time_slot VARCHAR(50) NOT NULL COMMENT '时间段',
    total_tickets INT NOT NULL DEFAULT 0 COMMENT '总票数',
    sold_tickets INT NOT NULL DEFAULT 0 COMMENT '已售票数',
    available_tickets INT NOT NULL DEFAULT 0 COMMENT '可售票数',
    version INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_exhibition_date_slot (exhibition_id, ticket_date, time_slot),
    INDEX idx_exhibition_id (exhibition_id),
    INDEX idx_ticket_date (ticket_date)
) COMMENT='展览时间段库存表';
```

### 第2步：为现有展览生成库存（可选）

如果你已经有展览数据，执行 `MIGRATE_EXISTING_EXHIBITIONS_TO_INVENTORY.sql`

### 第3步：重启后端

停止并重新启动后端服务

### 第4步：测试

1. 创建一个新展览
2. 查看数据库：`SELECT * FROM exhibition_time_slot_inventory WHERE exhibition_id = 最新的展览ID;`
3. 应该看到自动生成的库存记录

## 验证是否成功

```sql
-- 查看某个展览的库存
SELECT 
    ticket_date AS 日期,
    time_slot AS 时间段,
    total_tickets AS 总票数,
    sold_tickets AS 已售,
    available_tickets AS 可售
FROM exhibition_time_slot_inventory
WHERE exhibition_id = 1
ORDER BY ticket_date, time_slot;
```

预期结果：
```
日期        | 时间段      | 总票数 | 已售 | 可售
2026-02-01 | 09:00-12:00 | 100   | 0    | 100
2026-02-01 | 14:00-17:00 | 150   | 0    | 150
2026-02-02 | 09:00-12:00 | 100   | 0    | 100
2026-02-02 | 14:00-17:00 | 150   | 0    | 150
...
```

## 常见问题

### Q1: 为什么要创建新表？
**A**: 因为旧的exhibition表无法精确管理每一天每个时间段的库存。新表可以记录每天每个时间段的剩余票数。

### Q2: 表里没有数据怎么办？
**A**: 
1. 先执行SQL创建表
2. 重启后端
3. 创建新展览，系统会自动生成库存数据
4. 或者执行迁移脚本为现有展览生成数据

### Q3: 现在的展览都有票是什么原因？
**A**: 因为旧系统没有精确管理每天的库存。新系统实施后，每天的库存是独立的，卖完就没有了。

### Q4: 需要修改前端吗？
**A**: 后端已经完成，前端需要：
1. 显示每个时间段的剩余票数
2. 根据库存禁用"已售罄"的时间段
3. 调用新的库存查询API

## 总结

新表的作用就是**精确记录每一天每个时间段的库存**，解决了"不知道某天某时段还剩多少票"的问题。

执行SQL → 重启后端 → 创建展览 → 自动生成库存 → 购票时自动扣减 → 每天库存独立管理
