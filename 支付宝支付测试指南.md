# 支付宝支付测试指南

## 🎯 测试目标

验证支付宝支付功能是否正常工作，包括：
1. 内网穿透配置是否正确
2. 支付接口是否可用
3. 异步通知是否能收到
4. 订单状态是否正确更新

---

## 📋 前置条件

### 1. natapp 内网穿透
```bash
# 确保 natapp 正在运行
# 地址: http://p22294f8.natappfree.cc
```

**检查方法**：
```bash
curl http://p22294f8.natappfree.cc
```

如果返回内容，说明 natapp 正在运行。

### 2. 后端服务
```bash
# 在 shared-backend 目录下启动
cd shared-backend
mvn spring-boot:run
```

**检查方法**：
```bash
curl http://localhost:8080/api/v1/payment/alipay/notify -X POST
```

### 3. 前端服务
```bash
# 在 frontend-a 目录下启动
cd frontend-a
npm run dev
```

访问 http://localhost:3000

---

## 🧪 测试步骤

### 步骤 1：运行配置测试脚本

```bash
test-natapp-alipay.bat
```

这个脚本会自动检查：
- ✓ 内网穿透地址是否可访问
- ✓ 本地后端服务是否启动
- ✓ 内网穿透转发是否正常

**预期结果**：所有检查项都显示 ✅

---

### 步骤 2：创建测试订单

1. 登录系统（http://localhost:3000）
2. 选择一个展览
3. 选择日期和票数
4. 填写联系信息
5. 创建订单

**记录订单号**，例如：`T1735459200000ABC123`

---

### 步骤 3：发起支付

#### 方法 1：通过前端（推荐）

在订单详情页面，点击"支付"按钮。

#### 方法 2：通过 API 测试

```bash
# 替换 YOUR_ORDER_NO 为实际订单号
curl -X POST "http://localhost:8080/api/v1/payment/alipay/create?orderNo=YOUR_ORDER_NO"
```

**预期结果**：
- 返回支付表单 HTML
- 浏览器跳转到支付宝沙箱支付页面

---

### 步骤 4：支付宝沙箱支付

#### 4.1 获取沙箱账号

1. 登录 https://open.alipay.com/
2. 进入"开发者中心" → "研发服务" → "沙箱"
3. 查看"沙箱账号"

**沙箱买家账号示例**：
- 账号：xxx@sandbox.com
- 登录密码：111111
- 支付密码：111111

#### 4.2 完成支付

1. 在支付宝沙箱页面，使用沙箱买家账号登录
2. 输入支付密码
3. 点击"确认支付"

---

### 步骤 5：验证异步通知

#### 5.1 查看后端日志

支付成功后，后端应该输出类似日志：

```
收到支付宝异步通知
支付宝回调参数: {out_trade_no=T1735459200000ABC123, trade_no=2024122922001234567890, trade_status=TRADE_SUCCESS, total_amount=100.00, ...}
订单号: T1735459200000ABC123, 支付宝交易号: 2024122922001234567890, 交易状态: TRADE_SUCCESS, 金额: 100.00
订单支付成功，状态已更新: orderNo=T1735459200000ABC123
```

**关键信息**：
- ✓ 收到支付宝异步通知
- ✓ 签名验证通过
- ✓ 订单状态已更新

#### 5.2 查看支付宝开放平台日志

1. 登录 https://open.alipay.com/
2. 进入"开发者中心" → "消息通知"
3. 查看通知记录

**预期结果**：
- 通知状态：成功
- 响应内容：success

---

### 步骤 6：验证订单状态

#### 6.1 查询数据库

```sql
SELECT * FROM ticket_order WHERE order_no = 'YOUR_ORDER_NO';
```

**预期结果**：
- `status` = 1（待使用）

#### 6.2 前端查看

1. 进入"个人中心" → "我的订单"
2. 找到刚才的订单
3. 查看订单状态

**预期结果**：
- 订单状态显示"待使用"

---

### 步骤 7：验证同步通知

支付完成后，浏览器应该自动跳转到：
```
http://localhost:3000/order/success?out_trade_no=T1735459200000ABC123&trade_no=2024122922001234567890&total_amount=100.00
```

**预期结果**：
- 显示支付成功页面
- 显示订单号、支付宝交易号、支付金额
- 有"查看订单详情"和"返回首页"按钮

---

## 🔍 测试检查清单

### 内网穿透测试
- [ ] natapp 正在运行
- [ ] 可以访问 http://p22294f8.natappfree.cc
- [ ] 内网穿透可以转发到本地 8080 端口

### 支付接口测试
- [ ] 可以创建支付订单
- [ ] 返回支付表单 HTML
- [ ] 可以跳转到支付宝支付页面

### 异步通知测试
- [ ] 后端收到支付宝异步通知
- [ ] 签名验证通过
- [ ] 订单金额验证通过
- [ ] 订单状态更新为"待使用"
- [ ] 返回 "success" 给支付宝

### 同步通知测试
- [ ] 浏览器跳转到支付成功页面
- [ ] 显示订单信息
- [ ] 可以查看订单详情

### 数据库验证
- [ ] 订单状态正确（status = 1）
- [ ] 订单金额正确
- [ ] 订单号正确

---

## 🐛 常见问题排查

### 问题 1：内网穿透地址无法访问

**症状**：
```
curl: (7) Failed to connect to p22294f8.natappfree.cc
```

**解决方法**：
1. 检查 natapp 是否正在运行
2. 检查地址是否正确
3. 重启 natapp

```bash
# 重启 natapp
natapp -authtoken=你的token
```

---

### 问题 2：后端未收到异步通知

**症状**：
- 支付成功，但订单状态没有更新
- 后端日志没有"收到支付宝异步通知"

**排查步骤**：

1. **检查 natapp 是否正在运行**
```bash
curl http://p22294f8.natappfree.cc
```

2. **检查后端服务是否正常**
```bash
curl -X POST http://localhost:8080/api/v1/payment/alipay/notify
```

3. **检查支付宝通知日志**
- 登录支付宝开放平台
- 查看"消息通知"日志
- 查看通知状态和错误信息

4. **手动模拟异步通知**
```bash
curl -X POST "http://localhost:8080/api/v1/payment/alipay/notify" \
  -d "out_trade_no=YOUR_ORDER_NO" \
  -d "trade_no=TEST123456" \
  -d "trade_status=TRADE_SUCCESS" \
  -d "total_amount=100.00"
```

---

### 问题 3：签名验证失败

**症状**：
```
支付宝回调签名验证失败
```

**解决方法**：

1. **检查支付宝公钥是否正确**
- 登录支付宝开放平台
- 查看"应用信息" → "接口加签方式"
- 复制"支付宝公钥"（不是应用公钥）
- 更新 `AlipayConfig.java` 中的 `alipay_public_key`

2. **检查字符编码**
- 确保 `charset = "utf-8"`

3. **检查签名方式**
- 确保 `sign_type = "RSA2"`

---

### 问题 4：订单金额不匹配

**症状**：
```
订单金额不匹配: orderNo=xxx, expected=100.00, actual=100
```

**解决方法**：
- 检查订单金额格式（保留两位小数）
- 确保前后端金额计算一致

---

### 问题 5：同步通知页面空白

**症状**：
- 支付成功后跳转到空白页面
- 没有显示订单信息

**解决方法**：

1. **检查前端路由配置**
```javascript
// frontend-a/src/router/index.ts
{
  path: 'order/success',
  name: 'OrderSuccess',
  component: () => import('@/views/OrderSuccess.vue'),
}
```

2. **检查 URL 参数**
- 查看浏览器地址栏是否有参数
- 例如：`?out_trade_no=xxx&trade_no=xxx&total_amount=xxx`

3. **检查前端代码**
```javascript
// OrderSuccess.vue
const orderNo = route.query.out_trade_no;
```

---

## 📊 测试数据记录

### 测试记录表

| 测试项 | 预期结果 | 实际结果 | 状态 | 备注 |
|--------|---------|---------|------|------|
| 内网穿透可访问 | ✅ | | | |
| 后端服务正常 | ✅ | | | |
| 创建支付订单 | 返回表单 | | | |
| 跳转支付宝 | 成功跳转 | | | |
| 完成支付 | 支付成功 | | | |
| 收到异步通知 | 后端日志 | | | |
| 订单状态更新 | status=1 | | | |
| 同步通知跳转 | 显示成功页 | | | |

---

## 🎉 测试成功标准

所有以下条件都满足，说明支付功能正常：

1. ✅ 内网穿透正常工作
2. ✅ 可以创建支付订单
3. ✅ 可以跳转到支付宝支付页面
4. ✅ 支付成功后收到异步通知
5. ✅ 订单状态正确更新为"待使用"
6. ✅ 浏览器跳转到支付成功页面
7. ✅ 数据库订单状态正确

---

## 📚 相关文档

- `支付宝配置完成说明.md` - 配置说明
- `支付宝支付集成指南.md` - 集成指南
- `test-natapp-alipay.bat` - 自动测试脚本

---

## 💡 测试技巧

### 快速测试异步通知

不需要每次都完成支付，可以直接调用接口测试：

```bash
# 测试异步通知接口
curl -X POST "http://localhost:8080/api/v1/payment/alipay/notify" \
  -d "out_trade_no=T1735459200000ABC123" \
  -d "trade_no=TEST123456" \
  -d "trade_status=TRADE_SUCCESS" \
  -d "total_amount=100.00"
```

### 查看实时日志

```bash
# 在 shared-backend 目录下
tail -f logs/spring.log
```

### 重置订单状态

如果需要重新测试，可以重置订单状态：

```sql
UPDATE ticket_order SET status = 0 WHERE order_no = 'YOUR_ORDER_NO';
```

---

## ✅ 测试完成

恭喜！如果所有测试都通过，说明支付宝支付功能已经正常工作。

现在可以：
1. 在生产环境配置正式的支付宝账号
2. 将沙箱网关改为正式网关
3. 配置正式的域名和通知地址
