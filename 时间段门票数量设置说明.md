# 时间段门票数量设置说明

## 功能概述

在B端展览表单中，可以为不同时间段设置不同的门票数量：
- **每小时门票数**：默认值，用于其他时间段
- **9-12点门票数**：上午时段的门票数量
- **14-17点门票数**：下午时段的门票数量

---

## 一、数据库变更

### 新增字段

**表名：** `exhibition`

**字段：**
1. `morning_tickets` - INT - 9-12点门票数量
2. `afternoon_tickets` - INT - 14-17点门票数量

### 执行迁移

```bash
# 登录MySQL
mysql -u root -p buyticket

# 执行SQL
ALTER TABLE exhibition 
ADD COLUMN morning_tickets INT DEFAULT 100 COMMENT '9-12点门票数量' AFTER tickets_per_hour;

ALTER TABLE exhibition 
ADD COLUMN afternoon_tickets INT DEFAULT 100 COMMENT '14-17点门票数量' AFTER morning_tickets;

-- 为已有展览设置默认值
UPDATE exhibition 
SET morning_tickets = COALESCE(tickets_per_hour, 100),
    afternoon_tickets = COALESCE(tickets_per_hour, 100)
WHERE morning_tickets IS NULL OR afternoon_tickets IS NULL;

# 验证
DESCRIBE exhibition;

# 退出
exit;
```

---

## 二、B端操作

### 1. 创建/编辑展览

**步骤：**
1. 进入 B端 > 展览管理 > 创建展览（或编辑展览）
2. 填写基本信息
3. 设置门票数量：
   - **每小时门票数**：100（默认值，用于其他时间段）
   - **9-12点门票数**：150（上午时段）
   - **14-17点门票数**：200（下午时段）
4. 点击"保存"

### 2. 批量生成库存

**步骤：**
1. 进入 B端 > 门票管理 > 库存管理
2. 点击"批量生成库存"
3. 选择展览
4. 选择日期范围：2026-02-01 到 2026-02-28
5. 选择时间段：
   - ☑ 09:00-12:00
   - ☑ 14:00-17:00
6. 点击"生成"

**效果：**
- 系统会自动为每个时间段使用对应的门票数量
- 09:00-12:00 时段：使用 `morning_tickets` = 150张
- 14:00-17:00 时段：使用 `afternoon_tickets` = 200张

---

## 三、库存生成逻辑

### 优先级规则

**对于 09:00-12:00 时段：**
1. 优先使用 `morning_tickets`
2. 如果未设置，使用 `tickets_per_hour`
3. 如果都未设置，使用默认值 100

**对于 14:00-17:00 时段：**
1. 优先使用 `afternoon_tickets`
2. 如果未设置，使用 `tickets_per_hour`
3. 如果都未设置，使用默认值 100

**对于其他时间段：**
1. 使用 `tickets_per_hour`
2. 如果未设置，使用默认值 100

### 代码逻辑

```java
// 根据时间段确定门票数量
Integer ticketCount;
if ("09:00-12:00".equals(timeSlot)) {
    ticketCount = exhibition.getMorningTickets();
    if (ticketCount == null || ticketCount <= 0) {
        ticketCount = exhibition.getTicketsPerHour();
    }
} else if ("14:00-17:00".equals(timeSlot)) {
    ticketCount = exhibition.getAfternoonTickets();
    if (ticketCount == null || ticketCount <= 0) {
        ticketCount = exhibition.getTicketsPerHour();
    }
} else {
    ticketCount = exhibition.getTicketsPerHour();
}
```

---

## 四、A端显示效果

### 购票流程

1. **进入展览详情**
   - 访问 A端
   - 点击展览进入详情页
   - 点击"购票"按钮

2. **选择日期和时间段**
   - 选择日期：2026-02-01
   - 选择时间段：09:00-12:00
   - **显示："剩余150张"**

3. **切换时间段**
   - 选择时间段：14:00-17:00
   - **显示："剩余200张"**

---

## 五、部署步骤

### 1. 执行数据库迁移

```bash
mysql -u root -p buyticket < ADD_TIME_SLOT_TICKETS_COLUMNS.sql
```

### 2. 重启后端

```bash
cd /www/wwwroot/shared-backend
pkill -f buyticket
mvn clean package -DskipTests
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &
```

### 3. 重新构建B端前端

```bash
cd /www/wwwroot/frontend-b
npm run build
```

### 4. 重启Nginx

```bash
nginx -s reload
```

---

## 六、测试步骤

### B端测试

1. **创建展览**
   - [ ] 登录B端
   - [ ] 进入"创建展览"
   - [ ] 设置"每小时门票数" = 100
   - [ ] 设置"9-12点门票数" = 150
   - [ ] 设置"14-17点门票数" = 200
   - [ ] 保存展览

2. **生成库存**
   - [ ] 进入"库存管理"
   - [ ] 批量生成库存
   - [ ] 选择展览和日期范围
   - [ ] 勾选两个时间段
   - [ ] 点击"生成"

3. **验证库存**
   - [ ] 在库存列表中查看
   - [ ] 09:00-12:00 时段的"总数"为 150
   - [ ] 14:00-17:00 时段的"总数"为 200

### A端测试

1. **查看上午时段**
   - [ ] 进入展览详情
   - [ ] 点击"购票"
   - [ ] 选择日期
   - [ ] 选择时间段：09:00-12:00
   - [ ] 确认显示"剩余150张"

2. **查看下午时段**
   - [ ] 切换时间段：14:00-17:00
   - [ ] 确认显示"剩余200张"

3. **购票测试**
   - [ ] 购买1张上午时段的票
   - [ ] 返回日期选择页
   - [ ] 确认上午时段显示"剩余149张"
   - [ ] 下午时段仍显示"剩余200张"

---

## 七、数据库验证

### 查看展览设置

```sql
SELECT 
    id, 
    name, 
    tickets_per_hour,
    morning_tickets,
    afternoon_tickets
FROM exhibition;
```

**预期结果：**
```
+----+----------------+------------------+-----------------+-------------------+
| id | name           | tickets_per_hour | morning_tickets | afternoon_tickets |
+----+----------------+------------------+-----------------+-------------------+
|  1 | 航天成就展     |              100 |             150 |               200 |
+----+----------------+------------------+-----------------+-------------------+
```

### 查看库存数据

```sql
SELECT 
    e.name AS exhibition_name,
    ti.ticket_date,
    ti.time_slot,
    ti.total_count,
    ti.sold_count,
    (ti.total_count - ti.sold_count) AS remaining
FROM ticket_inventory ti
JOIN exhibition e ON ti.exhibition_id = e.id
WHERE ti.exhibition_id = 1
  AND ti.ticket_date = '2026-02-01'
ORDER BY ti.time_slot;
```

**预期结果：**
```
+----------------+-------------+-------------+-------------+------------+-----------+
| exhibition_name| ticket_date | time_slot   | total_count | sold_count | remaining |
+----------------+-------------+-------------+-------------+------------+-----------+
| 航天成就展     | 2026-02-01  | 09:00-12:00 |         150 |          0 |       150 |
| 航天成就展     | 2026-02-01  | 14:00-17:00 |         200 |          0 |       200 |
+----------------+-------------+-------------+-------------+------------+-----------+
```

---

## 八、常见问题

### 1. 库存数量不正确

**问题：** 生成的库存数量不是设置的值

**排查：**
```sql
-- 检查展览设置
SELECT id, name, morning_tickets, afternoon_tickets FROM exhibition WHERE id = 1;

-- 检查库存数据
SELECT * FROM ticket_inventory WHERE exhibition_id = 1 AND ticket_date = '2026-02-01';
```

**解决：**
- 确认展览的门票数量字段已设置
- 删除旧的库存记录
- 重新生成库存

### 2. A端显示的数量不对

**问题：** A端显示的剩余票数与数据库不一致

**排查：**
```bash
# 测试API
curl "http://localhost:8089/api/v1/ticket/availability?exhibitionId=1&date=2026-02-01&timeSlot=09:00-12:00"
```

**解决：**
- 清除浏览器缓存
- 重启后端服务
- 检查API返回的数据

### 3. 字段未添加

**问题：** 保存展览时报错，字段不存在

**解决：**
```bash
# 检查字段是否存在
mysql -u root -p -e "USE buyticket; SHOW COLUMNS FROM exhibition LIKE '%tickets%';"

# 如果不存在，执行迁移
mysql -u root -p buyticket < ADD_TIME_SLOT_TICKETS_COLUMNS.sql
```

---

## 九、使用场景

### 场景1：上午人多，下午人少

**设置：**
- 9-12点门票数：200张
- 14-17点门票数：100张

**效果：**
- 上午时段可以容纳更多游客
- 下午时段控制人流

### 场景2：下午人多，上午人少

**设置：**
- 9-12点门票数：100张
- 14-17点门票数：300张

**效果：**
- 根据实际参观习惯调整

### 场景3：两个时段相同

**设置：**
- 9-12点门票数：150张
- 14-17点门票数：150张

**效果：**
- 两个时段平均分配

---

## 十、修改的文件列表

### 前端文件

1. `frontend-b/src/views/exhibition/ExhibitionForm.vue`
   - 添加"9-12点门票数"输入框
   - 添加"14-17点门票数"输入框
   - 添加表单验证规则

### 后端文件

1. `shared-backend/src/main/java/com/buyticket/entity/Exhibition.java`
   - 添加 `morningTickets` 字段
   - 添加 `afternoonTickets` 字段

2. `shared-backend/src/main/java/com/buyticket/controller/admin/AdminTicketInventoryController.java`
   - 修改批量生成库存逻辑
   - 根据时间段使用不同的门票数量

### 数据库文件

1. `ADD_TIME_SLOT_TICKETS_COLUMNS.sql`
   - 添加 `morning_tickets` 字段
   - 添加 `afternoon_tickets` 字段

---

## 版本信息

- 修改日期：2026-01-30
- 修改人：Kiro AI
- 版本：v1.8
- 功能：时间段门票数量独立设置

