# 订单列表展览名称显示修复说明

## 问题描述
B端"订单核销管理"页面（`/order/verification`）的订单列表中，"展览名称"列显示为空。

## 根本原因
后端接口 `/api/v1/admin/order/ticket/list` 返回的是 `TicketOrder` 实体，该实体中没有 `exhibitionName` 字段。展览名称存储在 `OrderItem` 表中。

## 解决方案

### 修改文件
`shared-backend/src/main/java/com/buyticket/controller/admin/AdminOrderController.java`

### 修改内容

#### 1. 添加 OrderItemService 依赖
```java
@Autowired
private com.buyticket.service.OrderItemService orderItemService;
```

#### 2. 修改订单列表接口
**接口**：`GET /api/v1/admin/order/ticket/list`

**修改逻辑**：
1. 查询 `TicketOrder` 分页数据
2. 对每个订单，查询 `OrderItem` 表获取展览名称
3. 将订单数据和展览名称组合成 Map 返回

**关键代码**：
```java
// 查询订单项获取展览名称
LambdaQueryWrapper<OrderItem> itemWrapper = new LambdaQueryWrapper<>();
itemWrapper.eq(OrderItem::getOrderId, order.getId());
itemWrapper.last("LIMIT 1"); // 只取第一条
OrderItem orderItem = orderItemService.getOne(itemWrapper);

if (orderItem != null) {
    map.put("exhibitionName", orderItem.getExhibitionName());
}
```

#### 3. 修改订单详情接口
**接口**：`GET /api/v1/admin/order/ticket/{id}`

**修改逻辑**：
同样查询 `OrderItem` 表获取展览名称，并包含在返回数据中。

### 返回数据结构

#### 订单列表
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1,
        "orderNo": "T1234567890ABCDEF",
        "userId": 1,
        "totalAmount": 120,
        "status": 1,
        "contactName": "张三",
        "contactPhone": "13800138000",
        "createTime": "2026-01-31T10:00:00",
        "payTime": "2026-01-31T10:05:00",
        "verifyTime": null,
        "exhibitionName": "故宫博物院展览"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

#### 订单详情
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "orderNo": "T1234567890ABCDEF",
    "userId": 1,
    "totalAmount": 120,
    "status": 1,
    "contactName": "张三",
    "contactPhone": "13800138000",
    "createTime": "2026-01-31T10:00:00",
    "payTime": "2026-01-31T10:05:00",
    "verifyTime": null,
    "exhibitionName": "故宫博物院展览"
  }
}
```

## 数据关系

### 表结构
```
ticket_order (订单表)
├── id
├── order_no
├── user_id
├── total_amount
├── status
├── contact_name
├── contact_phone
└── ...

order_item (订单项表)
├── id
├── order_id (关联 ticket_order.id)
├── exhibition_id
├── exhibition_name ← 展览名称在这里
├── ticket_date
├── time_slot
└── ...
```

### 查询逻辑
```sql
-- 1. 查询订单
SELECT * FROM ticket_order WHERE ...

-- 2. 对每个订单，查询订单项获取展览名称
SELECT exhibition_name 
FROM order_item 
WHERE order_id = ? 
LIMIT 1
```

## 前端页面

### 页面路径
`frontend-b/src/views/order/VerificationList.vue`

### 表格列定义
```vue
<el-table-column prop="exhibitionName" label="展览名称" />
```

前端代码无需修改，因为已经定义了 `exhibitionName` 列，只是后端之前没有返回这个字段。

## 性能考虑

### 当前实现
- 对每个订单执行一次额外查询
- 适用于订单量不大的场景（每页10-100条）

### 优化方案（如需要）
如果订单量很大，可以考虑：
1. 使用 JOIN 查询一次性获取所有数据
2. 批量查询所有订单的 OrderItem，然后在内存中组装
3. 在 `TicketOrder` 表中冗余存储 `exhibition_name` 字段

### 示例：批量查询优化
```java
// 1. 查询所有订单
List<TicketOrder> orders = result.getRecords();

// 2. 批量查询所有订单项
List<Long> orderIds = orders.stream()
    .map(TicketOrder::getId)
    .collect(Collectors.toList());

LambdaQueryWrapper<OrderItem> itemWrapper = new LambdaQueryWrapper<>();
itemWrapper.in(OrderItem::getOrderId, orderIds);
List<OrderItem> orderItems = orderItemService.list(itemWrapper);

// 3. 构建 orderId -> exhibitionName 的映射
Map<Long, String> exhibitionNameMap = orderItems.stream()
    .collect(Collectors.toMap(
        OrderItem::getOrderId,
        OrderItem::getExhibitionName,
        (v1, v2) -> v1 // 如果有重复，取第一个
    ));

// 4. 组装数据
for (TicketOrder order : orders) {
    map.put("exhibitionName", exhibitionNameMap.getOrDefault(order.getId(), ""));
}
```

## 测试验证

### 验证步骤
1. 重启后端服务
2. 访问 B端 → 门票管理 → 订单核销
3. 查看订单列表的"展览名称"列
4. 点击"详情"按钮，查看订单详情中的展览名称

### 预期结果
- 订单列表中显示正确的展览名称
- 订单详情中显示正确的展览名称
- 如果订单没有关联的订单项，展览名称显示为空字符串

## 相关接口

### 受影响的接口
1. `GET /api/v1/admin/order/ticket/list` - 订单列表
2. `GET /api/v1/admin/order/ticket/{id}` - 订单详情

### 其他订单接口（未修改）
- `POST /api/v1/admin/order/ticket/{id}/verify` - 核销订单
- `POST /api/v1/admin/order/ticket/{id}/reset` - 重置核销
- `POST /api/v1/admin/order/ticket/{id}/void` - 作废订单
- `POST /api/v1/admin/order/ticket/verify` - 通过订单号核销

## 注意事项

### 数据一致性
- 展览名称在创建订单时从 `Exhibition` 表复制到 `OrderItem` 表
- 即使后续修改展览名称，订单中的展览名称不会改变（历史数据保持不变）

### 多个订单项
- 一个订单可能包含多个订单项（不同日期、不同时间段）
- 当前实现只取第一个订单项的展览名称
- 如果需要显示所有订单项，需要修改返回结构

## 总结
通过在订单列表和详情接口中关联查询 `OrderItem` 表，成功在B端订单核销管理页面显示展览名称，提升了管理员的使用体验。
