# 库存管理系统快速启动指南

## 立即执行的步骤

### 1️⃣ 创建数据库表（必须）

在MySQL中执行以下SQL：

```sql
CREATE TABLE exhibition_time_slot_inventory (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    exhibition_id BIGINT NOT NULL COMMENT '展览ID',
    ticket_date DATE NOT NULL COMMENT '门票日期',
    time_slot VARCHAR(50) NOT NULL COMMENT '时间段',
    total_tickets INT NOT NULL DEFAULT 0 COMMENT '总票数',
    sold_tickets INT NOT NULL DEFAULT 0 COMMENT '已售票数',
    available_tickets INT NOT NULL DEFAULT 0 COMMENT '可售票数',
    version INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_exhibition_date_slot (exhibition_id, ticket_date, time_slot),
    INDEX idx_exhibition_id (exhibition_id),
    INDEX idx_ticket_date (ticket_date)
) COMMENT='展览时间段库存表';
```

或者执行SQL文件：
```bash
mysql -u root -p buyticket < CREATE_TIME_SLOT_INVENTORY_TABLE.sql
```

### 2️⃣ 重启后端服务（必须）

停止并重新启动后端服务，使新代码生效。

### 3️⃣ 测试库存系统

#### 测试1：创建展览
1. 登录B端（admin/123456）
2. 创建新展览，设置：
   - 开始日期：2026-02-10
   - 结束日期：2026-02-15
   - 上午票数：100
   - 下午票数：150
3. 保存后，系统自动生成库存记录

#### 测试2：查询库存
```bash
# 假设展览ID为1
curl http://localhost:8080/api/v1/exhibition/inventory/1/date/2026-02-10
```

预期返回：
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "exhibitionId": 1,
      "ticketDate": "2026-02-10",
      "timeSlot": "09:00-12:00",
      "totalTickets": 100,
      "soldTickets": 0,
      "availableTickets": 100,
      "version": 0
    },
    {
      "id": 2,
      "exhibitionId": 1,
      "ticketDate": "2026-02-10",
      "timeSlot": "14:00-17:00",
      "totalTickets": 150,
      "soldTickets": 0,
      "availableTickets": 150,
      "version": 0
    }
  ]
}
```

#### 测试3：购买门票
1. 登录A端（zhangsan/123456）
2. 选择展览
3. 选择日期和时间段
4. 购买门票
5. 再次查询库存，检查 `soldTickets` 和 `availableTickets` 是否正确变化

#### 测试4：取消订单
1. 在A端"我的订单"中取消待支付订单
2. 再次查询库存，检查库存是否恢复

## 核心功能说明

### ✅ 自动初始化库存
创建展览时，系统自动为每一天的每个时间段生成库存记录。

### ✅ 实时扣减库存
用户创建订单时，立即扣减对应时间段的库存（使用乐观锁防止超卖）。

### ✅ 自动恢复库存
用户取消订单或管理员作废订单时，自动恢复库存。

### ✅ 防止超卖
使用乐观锁（version字段）确保并发情况下不会超卖。

## API接口

### 1. 查询某天所有时间段库存
```
GET /api/v1/exhibition/inventory/{exhibitionId}/date/{date}
```

示例：
```
GET /api/v1/exhibition/inventory/1/date/2026-02-10
```

### 2. 查询指定时间段库存
```
GET /api/v1/exhibition/inventory/{exhibitionId}/date/{date}/slot/{timeSlot}
```

示例：
```
GET /api/v1/exhibition/inventory/1/date/2026-02-10/slot/09:00-12:00
```

## 订单状态与库存

| 操作 | 库存变化 |
|-----|---------|
| 创建订单 | ⬇️ 扣减库存 |
| 支付订单 | 无变化（已扣减） |
| 核销订单 | 无变化（已扣减） |
| 取消订单 | ⬆️ 恢复库存 |
| 作废订单 | ⬆️ 恢复库存 |

## 常见问题

### Q1: 创建展览后没有生成库存？
**A**: 检查展览是否设置了开始日期、结束日期、上午票数、下午票数。如果都设置了，重启后端服务。

### Q2: 购买门票时提示"库存不足"？
**A**: 检查该时间段的库存是否真的不足。可以通过API查询库存。

### Q3: 取消订单后库存没有恢复？
**A**: 检查后端日志，看是否有错误信息。确保重启了后端服务。

### Q4: 并发购买时出现"库存更新失败，请重试"？
**A**: 这是正常的乐观锁机制，提示用户重试即可。

## 数据库检查

### 检查库存表是否创建成功
```sql
SHOW TABLES LIKE 'exhibition_time_slot_inventory';
```

### 查看库存数据
```sql
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = 1 
ORDER BY ticket_date, time_slot;
```

### 查看某个时间段的库存
```sql
SELECT * FROM exhibition_time_slot_inventory 
WHERE exhibition_id = 1 
  AND ticket_date = '2026-02-10' 
  AND time_slot = '09:00-12:00';
```

## 下一步工作

### 前端集成（待实现）
1. 在购票页面显示实时库存
2. 根据库存状态禁用"已售罄"的时间段
3. 购买成功后刷新库存显示

### 可选优化
1. 添加定时任务自动取消超时未支付订单
2. 添加库存预警功能
3. 使用Redis缓存热门展览库存

## 完成检查清单

- [ ] 执行SQL创建表
- [ ] 重启后端服务
- [ ] 创建测试展览
- [ ] 查询库存API测试
- [ ] 购买门票测试
- [ ] 取消订单测试
- [ ] 并发购买测试

---

**重要提示**: 必须先执行SQL创建表，然后重启后端服务，否则系统会报错！
