# 完整问题解决方案

## 问题总结

1. ✅ **封面图片渲染到A端** - 已实现，但需要确保数据库有数据
2. ❌ **数据库错误** - `detail_images` 列不存在
3. ❌ **门票数量不能渲染到A端** - 库存未生成

---

## 解决方案

### 步骤1：执行数据库迁移（必须）

**登录服务器并执行：**

```bash
# 登录MySQL
mysql -u root -p

# 选择数据库
USE buyticket;

# 1. 添加介绍插图字段
ALTER TABLE exhibition 
ADD COLUMN detail_images TEXT COMMENT '介绍插图(JSON数组)' AFTER cover_image;

# 2. 添加每小时门票数量字段
ALTER TABLE exhibition 
ADD COLUMN tickets_per_hour INT DEFAULT 100 COMMENT '每小时门票数量' AFTER price;

# 3. 添加核销时间字段
ALTER TABLE ticket_order 
ADD COLUMN verify_time DATETIME NULL COMMENT '核销时间' AFTER pay_time;

# 4. 验证字段是否添加成功
DESCRIBE exhibition;
DESCRIBE ticket_order;

# 5. 查看展览数据
SELECT id, name, cover_image, detail_images, tickets_per_hour FROM exhibition;

# 退出
exit;
```

**预期结果：**

```
mysql> DESCRIBE exhibition;
+------------------+--------------+------+-----+---------+----------------+
| Field            | Type         | Null | Key | Default | Extra          |
+------------------+--------------+------+-----+---------+----------------+
| id               | bigint       | NO   | PRI | NULL    | auto_increment |
| name             | varchar(255) | YES  |     | NULL    |                |
| short_desc       | varchar(500) | YES  |     | NULL    |                |
| description      | text         | YES  |     | NULL    |                |
| start_date       | date         | YES  |     | NULL    |                |
| end_date         | date         | YES  |     | NULL    |                |
| status           | int          | YES  |     | NULL    |                |
| price            | decimal(10,2)| YES  |     | NULL    |                |
| tickets_per_hour | int          | YES  |     | 100     |                |
| cover_image      | text         | YES  |     | NULL    |                |
| detail_images    | text         | YES  |     | NULL    |                |
| tags             | varchar(255) | YES  |     | NULL    |                |
| create_time      | datetime     | YES  |     | NULL    |                |
+------------------+--------------+------+-----+---------+----------------+
```

---

### 步骤2：重启后端服务

```bash
# 进入后端目录
cd /www/wwwroot/shared-backend

# 停止服务
pkill -f buyticket

# 重新编译
mvn clean package -DskipTests

# 启动服务
nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &

# 查看日志，确认启动成功
tail -f app.log

# 看到 "Started BuyTicketApplication" 表示启动成功
# 按 Ctrl+C 退出日志查看
```

---

### 步骤3：重新构建前端

```bash
# B端
cd /www/wwwroot/frontend-b
npm run build

# A端
cd /www/wwwroot/frontend-a
npm run build

# 重启Nginx
nginx -t && nginx -s reload
```

---

### 步骤4：B端操作 - 编辑展览

1. **登录B端管理后台**
   - 访问：`http://47.121.192.245:3001`
   - 使用管理员账号登录

2. **编辑现有展览**
   - 进入"展览管理" > "展览列表"
   - 点击"详情"按钮进入编辑页面
   - **重新上传封面图**（如果之前没有）
   - **设置"每小时门票数量"** = 100（或其他数值）
   - **上传介绍插图**（可选，1-6张）
   - 点击"保存"

3. **验证保存成功**
   - 确认页面提示"保存成功"
   - 返回展览列表

---

### 步骤5：B端操作 - 生成库存

1. **进入库存管理**
   - 点击侧边栏"门票管理" > "库存管理"

2. **批量生成库存**
   - 点击"批量生成库存"按钮
   - **选择展览**：选择刚才编辑的展览
   - **开始日期**：2026-01-31
   - **结束日期**：2026-02-28
   - **时间段**：勾选
     - ☑ 09:00-12:00
     - ☑ 14:00-17:00
   - **不需要输入数量**（系统自动使用展览设置的值）
   - 点击"生成"按钮

3. **验证生成成功**
   - 确认提示："成功创建 XX 条库存记录，每个时间段 100 张票"
   - 在库存列表中查看
   - 确认每条记录的"总数"为 100

---

### 步骤6：A端验证

1. **查看展览列表**
   - 访问：`http://47.121.192.245:5173`
   - 进入"近期展览"页面
   - **确认封面图显示正常**

2. **查看展览详情**
   - 点击任意展览
   - **确认封面图显示**
   - **确认介绍插图显示**（如果有上传）

3. **购票流程**
   - 点击"购票"按钮
   - 选择日期：2026-01-31
   - 选择时间段：09:00-12:00
   - **确认显示"剩余100张"**（或实际数量）
   - 点击"确认"
   - 填写联系人信息
   - 验证购票流程正常

---

## 常见问题排查

### 问题1：数据库字段添加失败

**错误信息：**
```
ERROR 1060 (42S21): Duplicate column name 'detail_images'
```

**原因：** 字段已经存在

**解决：** 忽略此错误，继续下一步

---

### 问题2：后端启动失败

**检查日志：**
```bash
tail -100 /www/wwwroot/shared-backend/app.log
```

**常见错误：**

1. **端口被占用**
   ```bash
   # 查找占用8089端口的进程
   netstat -tlnp | grep 8089
   
   # 杀掉进程
   kill -9 <PID>
   
   # 重新启动
   cd /www/wwwroot/shared-backend
   nohup java -jar target/buyticket-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > app.log 2>&1 &
   ```

2. **数据库连接失败**
   ```bash
   # 检查MySQL是否运行
   systemctl status mysql
   
   # 如果未运行，启动MySQL
   systemctl start mysql
   ```

---

### 问题3：A端仍然显示"剩余0张"

**排查步骤：**

1. **检查数据库字段**
   ```sql
   USE buyticket;
   SHOW COLUMNS FROM exhibition LIKE 'tickets_per_hour';
   ```

2. **检查展览设置**
   ```sql
   SELECT id, name, tickets_per_hour FROM exhibition;
   ```
   
   如果 `tickets_per_hour` 为 NULL 或 0：
   ```sql
   UPDATE exhibition SET tickets_per_hour = 100 WHERE id = 1;
   ```

3. **检查库存数据**
   ```sql
   SELECT * FROM ticket_inventory 
   WHERE exhibition_id = 1 
   AND ticket_date = '2026-01-31' 
   AND time_slot = '09:00-12:00';
   ```
   
   如果没有数据，说明库存未生成，需要在B端重新生成。

4. **检查API响应**
   ```bash
   # 测试库存查询接口
   curl "http://localhost:8089/api/v1/ticket/availability?exhibitionId=1&date=2026-01-31&timeSlot=09:00-12:00"
   ```
   
   预期响应：
   ```json
   {
     "code": 0,
     "msg": "success",
     "data": {
       "totalCount": 100,
       "soldCount": 0,
       "remainingCount": 100
     }
   }
   ```

---

### 问题4：封面图不显示

**排查步骤：**

1. **检查数据库**
   ```sql
   SELECT id, name, cover_image FROM exhibition WHERE id = 1;
   ```
   
   如果 `cover_image` 为 NULL，说明没有上传封面图。

2. **重新上传封面图**
   - 进入B端 > 展览管理 > 编辑展览
   - 上传封面图
   - 保存

3. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 是否有错误
   - 查看 Network 标签，检查图片请求

---

### 问题5：介绍插图不显示

**排查步骤：**

1. **检查数据库**
   ```sql
   SELECT id, name, detail_images FROM exhibition WHERE id = 1;
   ```
   
   如果 `detail_images` 为 NULL 或 `[]`，说明没有上传介绍插图。

2. **上传介绍插图**
   - 进入B端 > 展览管理 > 编辑展览
   - 滚动到"介绍插图"区域
   - 点击+号上传图片（最多6张）
   - 保存

3. **验证JSON格式**
   ```sql
   SELECT detail_images FROM exhibition WHERE id = 1;
   ```
   
   应该是JSON数组格式：
   ```json
   ["data:image/png;base64,...", "data:image/png;base64,..."]
   ```

---

## 完整测试清单

### B端测试

- [ ] 登录B端管理后台
- [ ] 进入展览管理 > 展览列表
- [ ] 点击"详情"编辑展览
- [ ] 上传封面图（200x200px）
- [ ] 设置"每小时门票数量" = 100
- [ ] 上传介绍插图（1-6张，120x120px）
- [ ] 点击"保存"
- [ ] 确认提示"保存成功"
- [ ] 进入门票管理 > 库存管理
- [ ] 点击"批量生成库存"
- [ ] 选择展览、日期范围、时间段
- [ ] 点击"生成"
- [ ] 确认提示"成功创建 XX 条库存记录，每个时间段 100 张票"
- [ ] 在库存列表中查看，确认数据正确

### A端测试

- [ ] 访问A端首页
- [ ] 进入"近期展览"页面
- [ ] 确认展览列表显示封面图
- [ ] 点击任意展览进入详情页
- [ ] 确认封面图显示
- [ ] 确认介绍插图显示（如果有上传）
- [ ] 点击"购票"按钮
- [ ] 选择日期和时间段
- [ ] 确认显示"剩余100张"（或实际数量）
- [ ] 点击"确认"
- [ ] 填写联系人信息
- [ ] 选择票数
- [ ] 点击"支付"
- [ ] 验证购票流程正常

---

## 数据库完整检查脚本

```sql
-- 1. 检查展览表结构
DESCRIBE exhibition;

-- 2. 检查展览数据
SELECT 
    id, 
    name, 
    tickets_per_hour,
    CASE 
        WHEN cover_image IS NULL THEN '未上传'
        ELSE '已上传'
    END AS cover_status,
    CASE 
        WHEN detail_images IS NULL OR detail_images = '[]' THEN '未上传'
        ELSE '已上传'
    END AS detail_status
FROM exhibition;

-- 3. 检查库存数据
SELECT 
    e.name AS exhibition_name,
    ti.ticket_date,
    ti.time_slot,
    ti.total_count,
    ti.sold_count,
    (ti.total_count - ti.sold_count) AS remaining_count
FROM ticket_inventory ti
JOIN exhibition e ON ti.exhibition_id = e.id
WHERE ti.ticket_date >= CURDATE()
ORDER BY ti.ticket_date, ti.time_slot
LIMIT 10;

-- 4. 检查订单表结构
DESCRIBE ticket_order;

-- 5. 统计数据
SELECT 
    '展览总数' AS item,
    COUNT(*) AS count
FROM exhibition
UNION ALL
SELECT 
    '库存记录数',
    COUNT(*)
FROM ticket_inventory
UNION ALL
SELECT 
    '订单总数',
    COUNT(*)
FROM ticket_order;
```

---

## 版本信息

- 修改日期：2026-01-30
- 修改人：Kiro AI
- 版本：v1.7
- 功能：完整问题解决方案

